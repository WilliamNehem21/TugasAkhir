controller area network(can) is a high-speed serial bus system with real-time capability. in this paper, we present a formal model of the can bus protocol, mainly focusing on the arbitration process, transmission process, and fault confinement mechanism. moreover, 11 important properties are formalized in terms of the protocol. based on the verification tool uppaal, we describe the system model and properties for performing verification work of the can bus protocol. the verification results indicate that some properties are not satisfied in can bus system, most of which are caused by the starvation and bus-off nodes. on this basis, the dynamic priority scheduling algorithm and bus-off recovery mechanism are applied, which indicates that some problems can be solved on the application layer.



by bosch company and then established as the international standard in iso 11898. multi-master broadcasting is the key feature of this serial bus system. all nodes can transmit data when the bus is free, and the collision of multiple simultaneous transmissions is solved by priority-based arbitration algorithm. the identifier of a message resolves the priority. a transmitter broadcasts a message to all nodes and each node decides whether the data is relevant according to the identifier received. one main feature is fault confinement mechanism. each controller of can detects errors and takes appropriate measures to guarantee the data consistency and reliability. the interframe space is another characteristic. data and remote frames are separated from the previous frame by an interframe space, during which no node has access to the bus. can bus is widely used in safety critical automotive electronics due to its real-time capability, low cost and reliable error confining mechanism.



to ensure the correctness of can protocol, formal methods based on the rigorous mathematical theory could be an effective and practical approach. the adoption of formal notations with a defined mathematical meaning enables the model to be expressed with precision and unambiguity. the properties that the protocol should exhibit can be represented in mathematical framework as well. thus the correctness can be checked via exploring all states and transitions or mathematical proof. there are also some automatic or interactive tools to facilitate the process like spin, nusmv, uppaal,coq among many other excellent tools.



can follows the abstract open system interconnection(osi) reference model, and its protocol mainly defines the data link layer. in the first place, we present a formal model of the can protocol and the verification results of its properties based on timed automata. we employ uppaal to model the can system and implement not only the arbitration process and the transmission process, but also the fault confinement mechanism and the interframe space characteristic. besides, 11 important properties extracted from the can standard are also verified in uppaal.



and then shows the four submodels. section 4 presents the properties and the verification results, including the analysis. additionally, in section 5, we illustrate the modeling process of application layer and show the changes to the verification results. comparison with related work and conclusion are given in section 6 and section 7, respectively.



the error frame is composed of two fields. the first is the error flag, which is 6 consecutive dominant(error-active node) or recessive(error-passive node) bits. the second is the error delimiter, with a fixed format of 8 consecutive recessive bits. but the recessive bits can be submerged by dominant bits sent to the bus at the same time. any node can broadcast an overload message to delay the next transmission. its format is the same as the active error frame, but the overload frame only occurs right after the last bit of eof, while the error frame may occur whenever an error is detected.



the method used to solve the collision is the carrier sense multiple access/collision avoidance(csma/ca) mechanism. all nodes constantly monitor the bus in time. the nodes attempting to send messages start to write to the bus bit by bit when the bus is idle. the dominant bit(0) overwrites the recessive bit(1), which means zero has the higher priority. the data monitored on the bus is compared with the data sent by a transmitter. if one node sends a recessive bit but reads back a dominant bit, it means some other nodes are transmitting messages with higher priority identifiers. this node stops sending bits and immediately switches to listening-only mode.



messages with errors should be discarded and retransmitted when the bus turns to idle again. fault confinement mechanism is proposed to stop a node which causes too many faults from developing into a permanent malfunction. a transmit error counter(tec) and a receive error counter(rec) are assigned to every node. if the transmitter detects an error, the corresponding tec increases, while the receiver detecting an error increases its rec. the recs of all nodes receiving an error frame also increase. however, if a message is successfully transmitted and received, the tec of the transmitter and the rec of receivers decrease. a node starts in the error-active state with its counters initialized to zero. if any tec or rec reaches a certain value(128), the node enters the error-passive state, in which a node is unable to broadcast an error flag but writing to the bus is still possible if no error-active node wishes to write to the bus. if the tec of a node reaches the maximum value(256), the node should be disconnected from the network. the node can return to the network only via a software reset.



data frames and remote frames should be separated from preceding frames by a field called interframe space. but overload frames and error frames shall not be preceded by it. the interframe space contains the bit fields intermission(three recessive bits). but for error-passive nodes which have been the transmitter of the previous frames, eight recessive bits shall be sent following the intermission before trying to transmit its next message. however, the error-active node and the error-passive node that is not the transmitter of the previous message do not need to wait, which means these nodes may have already granted access during that period. the bus becomes idle after the interframe space, during which any node may access the bus.



in our models, we use uppaal to model the specification of can bus protocol. in this section, we only model the can bus and its properties based on the iso standard. however, to analyze its performance on the application layer, we further apply the dynamic priority algorithm and the bus-off recovery mechanism and verify the properties in the next section.



the arbitration solves the collision based on the message priority. either data frame or remote frame can be randomly generated at first, then the identifiers of messages attempting to be transmitted will be compared. once the winner is decided, the transmission process starts, which is synchronized by channels. furthermore, the arbitration also deals with the problem of error-passive nodes trying to send the next message.



in this can model, there are three nodes named 0, 1, 2 which transmit messages with identifiers 1, 2, 3 respectively. in a practical can system, the data is sent bit by bit, and monitored at the same time. however, to abstract the process, the frame is simplified as an integer, representing the identifier of a frame. in addition, the bus is declared as an integer variable bus, and the writing and reading process of data is abstracted as the assignment to the bus variable and the reading from it.



during the reading process, one or more errors may occur. the controller triggers the channel error[id] as soon as any error is detected and the array error detect[id] turns to 1. the occurrence of error, as well as the the broadcast of an error frame, is illustrated in the transceiver model.(see section 3.5)



during a whole transmission process, an ideal situation is that a message is successfully sent and received by all nodes and all nodes return to the idle state. however, errors may occur during the transmitting process, after which an error signal is broadcast. in addition, an overload frame may be sent and broadcast so that all nodes wait for additional time before the start of next transmission process. after all these processes are completed, all nodes return to the idle state and prepare for the next transmission.



in this model, the variable error counter is declared to record the errors. the error counters of all nodes are initiated to 0. for every node, on receiving the error frame, the variable error counter will increase by 1. however, if no error occurs, all nodes decrease their error counters in function error counter decrease(id). if the error counter reaches 4, the error passive[id] is set to 1, turning to error-passive state. of course, the error counters will decrease if a message is successfully sent and received. and the error passive[id] can be set to 0 once the error counter is less than 4. but a node turns to bus-off state if its error counter reaches 8. we assume the maximum limits for error-active nodes and error-passive nodes to be 4 and 8 respectively in order to simplify the models. for a bus-off node, the channel busoff[id] is triggered.



for the purpose of verifying whether the models obey the specifications and requirements of can protocol, 11 properties based on the standard are proposed. all these properties are specified using uppaal property specification language. the verification results and analysis are provided as well.



as for the sf, a node may never win the arbitration and successfully send its message when there are always other nodes sending messages of higher identifiers at the same time. a node attempting to send a message may never succeed because of its low priority. that is why this property fails the verification. the rdr cannot



in summary, the event-triggered and priority-based mechanisms of can lead to the starvation problem. to solve the problem, time triggered controller area network(ttcan) can be used as it is time-triggered. another problem results from the fault confinement mechanism. this mechanism is designed to ensure performance reliability and stop ill-performed nodes from sending and receiving messages. however, the verification results indicate that the error-passive and busoff nodes may cause the data loss or data inconsistency.



in our models, the algorithm is applied to the arbitration model by a function called dynamic compare(). two variables failure counter and dynamic priority are declared for each node. we assume that the dynamic priority is promoted by one when the failure counter reaches three, which means the message has lost the arbitration for three times. when the message finally gains access to the bus, the failure counter is reset to zero and the dynamic priority turns back to the initial number.



as for the es and bam, they cannot pass the verification because of the errorpassive nodes. the es refers to the property that errors can always be flagged by nodes detecting them. but according to the protocol, if only error-passive nodes detect the errors, the error flag cannot be broadcast. similarly, the bam does not hold for the implementation model because of the same reason we mentioned in section 4.2, the error-passive nodes cannot continuously send two frames regardless of its message priority.



from the analysis above, we can conclude that the critical problems occurred in the data link layer can be partially solved by designing algorithms in the application layer. with regard to the error-passive nodes, the fault confinement mechanism is designed to stop the badly-behaved nodes from disturbing the communication. when a node makes too many mistakes, it is thought to be error-prone and measures are taken to make it transmit as less messages as possible. our models are just strictly following the actual behavior rules of the error-passive nodes. the fault confinement mechanism tries to avoid the disturbance of badly-behaved nodes, but meanwhile some side effects may be brought out, such as the fact that the limitations to the behaviors of error-passive nodes may lead to data loss and data inconsistency.



in the future, we will research on modeling and verification of the probability of can communication. as we mentioned before, some properties do not hold due to the occurrence of some incidents. the proposal of probability models can better model the real situation of the system. for example, the errors in our models are randomly triggered, however, the probability of the occurrence of errors can be calculated, and integrated in the models. then properties could be verified on such probability models, which is more accurate and close to real situation.



this work was supported by shanghai knowledge service platform project no. zf1213), the natural science foundation of china under grant(no.91118008), 973 project(no.2011cb302904), the project of science and technology commitment of shanghai(no. 12511504205), and key lab of information network security, ministry of public security(no. c12604).



