performing accurate and automated semantic segmentation of vegetation is a first algorithmic step towards more complex models that can extract accurate biological information on crop health, weed presence and phenological state, among others. traditionally, models based on normalized difference vegetation index (ndvi), near infrared channel (nir) or rgb have been a good indicator of vegetation presence. however, these methods are not suit- able for accurately segmenting vegetation showing damage, which precludes their use for downstream pheno- typing algorithms. in this paper, we propose a comprehensive method for robust vegetation segmentation in rgb images that can cope with damaged vegetation. the method consists of a first regression convolutional neu- ral network to estimate a virtual nir channel from an rgb image. second, we compute two newly proposed veg- etation indices from this estimated virtual nir: the infrared-dark channel subtraction (idcs) and infrared-dark channel ratio (idcr) indices. finally, both the rgb image and the estimated indices are fed into a semantic seg- mentation deep convolutional neural network to train a model to segment vegetation regardless of damage or condition. the model was tested on 84 plots containing thirteen vegetation species showing different degrees of damage and acquired over 28 days. the results show that the best segmentation is obtained when the input image is augmented with the proposed virtual nir channel (f1=0.94) and with the proposed idcr and idcs veg- etation indices (f1=0.95) derived from the estimated nir channel, while the use of only the image or rgb indi- ces lead to inferior performance (rgb(f1=0.90) nir(f1=0.82) or ndvi(f1=0.89) channel). the proposed



several works have tried to correlate the ndvi and other vegetation indices (vis) based on light channels with vegetation coverage estima- tion (price, 1992; huete et al., 1997; wu et al., 2007; zhengwei et al., 2009; roth and streit, 2018; devia et al., 2019; ren and zhou, 2019). most of them are based on acquiring experimental data on soil and leaf reflectance of different light channels and correlate those reflec- tance with combinations of such channels (which are called vegetation indices). they also try to correlate those vegetation indices with the ac- tual biomass measurements (fresh weight, dry weight) by means of lin- ear and non-linear regressive analysis. the aforementioned research works correlate the different vis with the actual biomass weighting by means of pixel-wise linear or non-linear regression analysis.



some more modern research integrates the spatial information dis- tribution from the rgb pixels to infer the nir channel. for example, khan et al. (2018); lima et al., 2019 propose a method to estimate sev- eral vegetation indices by means of a neural network. however, they use a neural network that do not estimate the vegetation indexes at pixel level resolution, only the average vegetation index for the whole



to avoid bias, the distribution of images across the training, valida- tion and test datasets was selected by plots. this means that each crop field (plot) was assigned an identification number and all images be- longing to the same crop field (plot) were assigned to the same subset of data (train, validation, test). this ensures that images from the same plot taken on consecutive days are assigned to the same set, avoiding contamination of the training, validation and test sets. eighty percent of the crop fields (plots) were randomly chosen for training, while the remaining 20% were distributed into validation and test sets, and all images were incorporated into the set determined by their crop field (plot) number resulting into 24 plots for training, 2 for validation and 3 for testing.



in our approach, we propose the use of a semantic regression neural network to estimate a virtual nir channel from an rgb image. this vir- tual channel is then used to enrich the original rgb image to generate a multi-channel image that is used to train a multispectral vegetation seg- mentation convolutional neural network. this multichannel image in- cludes not only the original red, green and blue channels and the estimated virtual nir channel but also different multi-spectral indices derived from this four channels.



the last layer of this network has been substituted by a sigmoid ac- tivation function and the loss function has been replaced by a mean ab- solute error loss in order to learn a pixel-wise regression transformation that translates the image from the source to the target domain. the last layer consists of a 224x224x1 that performs nir reconstruction. the network is trained by minimizing a mean absolute error loss function which can be enhanced by an adversarial perceptual loss function fol- lowing a pix2pix architecture (isola et al., 2017). the addition of the per- ceptual adversarial loss functions ensures that the generated image is visually plausible and the estimated image cannot be distinguished from a real image by a specifically trained network. similar approach has been followed by aslahishahri et al. (2021); de lima et al., 2022 to include a perceptual adversarial loss. however, they use unet architec- ture as generator which increases the number of trainable parameters. proposed fully convolutional densenet network has 2,3 m parameters whereas its unet counterpart has 24 m instead.



a second network with similar structure as the one defined in section 4.1 is used for plant coverage estimation. in this case, the input layer of the network size is mxnxk, where m and n represents the height and the width of the input image and k the number of chan- nels used. in our case the number of input channels is k = 7. these channels are composed by the r, g, b channels of the original image and all the estimated channels by the previous methods (nir, ndvi, idcs and idcr). the final layer of this network is composed by two out- put channels of size m and n (mxnx2) resembling the original size of the image. one of the output channels maps the estimation for the plant coverage segmentation meanwhile the other contains the other classes. a softmax activation layer that ensures the mutually exclusive- ness of the two classes. this network is minimized over a categorical cross-entropy loss function.



neural network to get the estimated nir channel. additional vegetation indices (ndvi, idcs and idcr) are calculated from the r, g, b and the es- timated nir channels. training is performed over the training set of the dataset described in 3. after training, the validation subset of the dataset was used to calculate the optimal thresholds values that maximized the balanced accuracy (bac). these thresholds were applied over the test- ing set. in order to measure the effect of using estimated nir channels instead the real ones, specific experiments using real nir channel have been performed.



of the model. the precision is calculated as the number of true vegeta- tion pixels divided by the number of all predicted vegetation pixels whereas the recall is the number of true positive vegetation pixels di- vided by the number of all true vegetation pixels. for unbalanced datasets in semantic segmentation, f-score is normally preferred to bac as it ignores the effect of the true negative class (non vegetation pixels). tp, tn, fn and fp refers to true positives, true negatives, false negatives and false positives respectively.



we have proposed a convolutional semantic regression network to estimate a virtual near infrared channel from an rgb image (rgb2nir) that can optionally incorporate an adversarial loss. with this adversarial loss, the proposed network can accurately estimate the nir channel (p_value = 0.96, rms=4%). this demonstrates that the adversarial loss contributes to generate more efficient estimation for the nir chan- nel than just employing a convolutional semantic regression network.



we have introduced two novel vegetation indices such as infrared- dark-channel-substractive index (idcs) and the infrared-dark- channel ratio index (idcr). we have proven that these indices have good separability properties to differentiate vegetation regardless its damage. these vegetation indices can be used independently for vege- tation segmentation purposes independently.



