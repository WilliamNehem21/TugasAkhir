Available online at www.sciencedirect.com


Electronic Notes in Theoretical Computer Science 341 (2018) 321–344
www.elsevier.com/locate/entcs

Continuous Probability Distributions in Concurrent Games
Hugo Paquet1 Glynn Winskel2
Department of Computer Science and Technology University of Cambridge
Cambridge, UK

Abstract
We present a model of concurrent games in which strategies are probabilistic and support both discrete and continuous distributions. This is a generalisation of the probabilistic concurrent strategies of Winskel, based on event structures. We first introduce measurable event structures, discrete fibrations of event structures in which each fibre is turned into a measurable space. We then construct a bicategory of measurable games and measurable strategies based on measurable event structures, and add probability to measurable strategies using standard techniques of measure theory. We illustrate the model by giving semantics to an affine, higher-order, probabilistic language with a type of real numbers and continuous distributions.
Keywords: Game semantics, concurrency, event structures, probability, measure theory.


Introduction
In the 25 years since its conception, game semantics [18,1] has developed intoa pow- erful framework for modelling programming languages with computational effects such as state, control, concurrency, or nondeterminism. This range of applicability is due to the highly intensional nature of games models, where programs are inter- preted as strategies specifying their behaviour in all possible evaluation contexts.
Another use of game semantics is in probabilistic computation. As first shown by Danos and Harmer [12] in a probabilistic version of the original Hyland-Ong game model [18], programs with random features can be interpreted as probabilistic strategies carrying the extra quantitative information. This works particularly well for probabilistic programs with state: the model is fully abstract for Probabilistic Algol, an extension of PCF [21] with ground type references and probability.

1 Email: hugo.paquet@cl.cam.ac.uk
2 Email: glynn.winskel@cl.cam.ac.uk

https://doi.org/10.1016/j.entcs.2018.11.016
1571-0661/© 2018 The Author(s). Published by Elsevier B.V.
This is an open access article under the CC BY-NC-ND license (http://creativecommons.org/licenses/by-nc-nd/4.0/).

a1	a2
 
b
(a)
q
 
tt  ff
(b)

Fig. 1. Two event structures.


Recently, concurrent games [22] were introduced as an alternative framework for game semantics, based on event structures, a fundamental model for concur- rent processes. The framework has been used to model concurrent primitives in functional programs [6,10,11], and has been particularly successful at modelling nondeterminism in languages without state [5] (a problem known to be difficult in game semantics [16]).
In [28] the second author enriched concurrent games with probability, by in- troducing a notion of probabilistic event structures, extending previous work on probabilistic models for concurrency [24]. This made possible an analysis of Prob- abilistic PCF via games [7], including an intensional full abstraction result.
However, in all of the above models, all probability distributions are forced to be discrete. This makes those models unsatisfactory for practical probabilistic languages, in which continuous distributions are essential. V´ak´ar and Ong have recently announced [20] a generalisation of the Danos-Harmer model supporting continuous distributions, which they apply to a stateful language to obtain a defin- ability result, following [12].
In this paper, we propose a new probabilistic concurrent games model in which strategies are equipped to support arbitrary distributions on the real numbers. We rely on methods of measure theory and introduce measurable event structures. These generalise event structures and form the basis for a model of measurable concurrent games, to which one may adjoin probability. We illustrate the model by giving semantics to a higher-order, affine probabilistic language called PPCFR , for which
we prove an adequacy theorem.
Outline of the paper. In the next section, we introduce measurable event structures, independently of their application to concurrent games. Then, in Sec-

tion 3, we define PPCFR
and use it to motivate the development of a bicategory of

measurable games and measurable strategies, which we enrich with probability in

Section 4. Finally, in Section 5, we return to PPCFR
and prove adequacy.


Measurable Event Structures
Our model is based on a generalisation of event structures supporting arbitrary probability measures, including continuous distributions. We start by recalling some elements of the theory of event structures, and introduce our notion of ﬁbred event structures.

Fibred event structures
Event structures
Event structures are a model of concurrent processes in which occurrences of compu- tational events are partially ordered following the causal constraints between them.
Figure 1a displays an event structure in which two initial events a1 and a2 occur in parallel, followed by a third event b. Here the partial order has a1 ď b and a2 ď b, with the understanding that an event can only occur after each of its predecessors has occurred.
Processes modelled by event structures are potentially non-deterministic. An event structure carries information about which subsets of events are consistent, in which case they may occur together in an execution. For instance the diagram in Figure 1b represents a process in which an initial signal is followed by a boolean value chosen non-deterministically: in the corresponding event structure, ttt, ff u is not a consistent subset. Causality and consistency are subject to some axioms. Following [26]:
Definition 2.1 An event structure 3 is a tuple pE, ď, Conq where E is a set of events, ď a partial order on E representing dependency, and Con a non-empty set of finite subsets of E called consistent, such that
req “ te1 | e1 ă eu is finite for all e P E
teu P Con for all e P E
Y Ď X P Con ùñ Y P Con
X P Con and e ď e1 P X ùñ X Y teu P Con.

The diagrams of Figure 1 do not display ď and Con directly, but rather immedi- ate causality e d e1, defined as e ă e1 with no events in between, and immediate conflict e e1, defined as reqY te1u P Con, re1qY teu P Con and te, e1u R Con.
A configuration of E is a finite subset x Ď E which is consistent and downwards-closed. The set of all configurations is denoted CpEq and throughout the paper it is considered as a partial order under inclusion. For x, y P CpEq, we say that y is a covering of x, written x´Ăy, if there is e P E such that e R x and y “ x Y teu.

Fibres
We propose making the event structure E measurable by turning CpEq into a mea- surable space whose structure reflects that of E. We will review the basics of measure theory in the next section — for now let us introduce a crucial object of our approach: a form of ﬁbration of event structures which we call a ﬁbred event structure.
Consider a process outputting two real numbers ε and δ consecutively, each chosen non-deterministically in R. An event structure representation of it is pictured

3 Specifically we use prime event structures with general consistency.

a1
8
a2

Fig. 2. A fibred event structure f : E Ñ B.
as E on the left of Figure 2. Each ‘real line’ represents an uncountable set of events, all pairwise in immediate conflict. Only one ε-branch is displayed — there are in fact uncountably many such “δ” real lines, one for each ε P R.
Configurations of E can have one of three forms: H, tεu, or tε, δu where ε, δ P E and ε d δ. Our approach involves projecting them to the configurations of a base event structure B, displayed on the right of the figure. The goal is to encapsulate the uncountable non-deterministic branching in E in ﬁbres over the configurations of B: H, ta1u and ta1, a2u. The projection map f : E Ñ B is an instance of a map of event structures:
Definition 2.2 A function f : E Ñ E1 is a map of event structures if
it preserves configurations: for every x P CpEq, fx P CpE1q, and
it is locally injective: if e, e1 P x are such that f peq “ f pe1q, then e “ e1.
We say f is rigid if additionally e ď e1 implies f peq ď f pe1q. Rigid maps are appropriate in this context: as the next lemma shows they provide a well-behaved notion of ﬁbres:
Lemma 2.3 If f : E Ñ E1 is a map of event structures, then f is rigid if and only if the induced map CpEq Ñ CpE1q is a discrete ﬁbration of partial orders, i.e. for every x P CpEq, if y Ď fx for some y P CpE1q, then there exists a unique x1 P CpEq such that x1 Ď x and fx1 “ y.
Proof. (Only if). Suppose that f : E Ñ E1 is rigid and that we have x P CpEq and y P CpE1q such that y Ď fx. The restriction of f to x is injective by assumption, and pf |xq´1y is necessarily the only x1 Ď x such that fx1 “ y. It is a configuration, since it is consistent (as a subset of x) and down-closed (f preserves and reflects causal dependency, and y is down-closed).
(If). Suppose now that f is not rigid, so there are e, e1 P E such that e d e1 but

f peq d­
f pe1q. Consider x “ re1s and y “ rf pe1qs. Then y Ď fx, but since f pe1q P y

and f peq R y, there can be no x1 P CpEq such that x1 Ď x and f x1 “ y (such an x1
would not be down-closed).	l
Definition 2.4 A fibred event structure consists of a pair of event structures
E and BE, and a rigid map fE : E Ñ BE.
We use the same symbol to denote a map of event structures and the induced map on configurations. Accordingly, given a fibred event structure fE : E Ñ BE and a configuration p P CpBEq, the fibre over p is the preimage f ´1tpu “ tx P CpEq | fEx “ pu. If p Ď q P CpBEq, we write rp,q : f ´1tqu Ñ f ´1tpu for the
E	E
restriction map determined by Lemma 2.3.

Measurable event structures
In the example of Figure 2, the fibre structure is as follows: f ´1tHu “ t*u,
f ´1tta1uu – R, and f ´1tta1, a2uu – R ˆ R, with the restriction map rta u,ta ,a u
E	E	1	1 2
acting as the first projection. It is this structure that we leverage in order to make
E measurable. First we recall some definitions, for which a standard reference is
e.g. [15].
Measure theory
Given a set X, a σ-algebra on X is a set ΣX of subsets of X, containing X itself and closed under countable unions, and complements. (Any such ΣX is also closed under countable intersections.) A measurable space is a pair pX, ΣX q with X a set and ΣX a σ-algebra on it. A measurable function f : pX, ΣX q Ñ pY, ΣY q is a function X Ñ Y such that for any U P ΣY , f ´1U P ΣX .
Any set S of subsets of X generates a σ-algebra algpSq, as the smallest σ-algebra containing S. The Borel σ-algebra on the set R of real numbers is generated by the set of all intervals: we write ΣR “ alg ptpa, bs | a ď b P Ruq.
The category Meas of measurable spaces and measurable functions has fi- nite products:	in the binary case pX, ΣX q ˆ pY, ΣY q “ pX ˆ Y, ΣX b ΣY q, where the product σ-algebra is generated by the ‘measurable rectangles’: ΣX b ΣY “ alg ptUX ˆ UY | UX P ΣX, UY P ΣY uq . It also has countable coproducts 4 : iPI pXi, ΣXi q “ p		iPI Xi, Σ  iPI Xi q, where	iPI Xi “	iPI tiuˆ Xi and Σ iPI Xi “
alg pttiuˆ U | i P I and U P ΣXi uq .
Finally, given a measurable space pX, ΣX q and a subset S Ď X, we can turn S into a measurable space pS, ΣSq with the subspace σ-algebra ΣS “ tS X U | U P ΣX u.
Measurable ﬁbres
Definition 2.5 A measurable event structure E consists of a fibred event struc- ture fE : E Ñ BE and, for each p P CpBEq, a σ-algebra Σf ´1tpu on the fibre over
p, such that for every p Ď q P CpBEq, rp,q is measurable.
The fibred event structure in Figure 2 is naturally turned into a measurable
event structure by setting Σf ´1tta1uu “ ΣR and Σf ´1tta1,a2uu “ ΣR b ΣR. Note that
E	E
in any measurable event structure, the fibre over H is a singleton and necessarily
equipped with the trivial σ-algebra.
Remark 2.6 Via the standard correspondence between discrete fibrations and presheaves, a fibred event structure fE : E Ñ BE yields a functor CpBEqop Ñ Set, where the partial order pCpBEq, Ďq is seen as a category. Likewise, a measur- able event structure induces a ‘measurable presheaf’ CpBEqop Ñ Meas. Not all presheaves on CpBEq are representable by fibred event structures in this way (see

4 In fact Meas is a topological category [4] and has all small limits and colimits induced from those in Set. We only give explicit constructions for those needed in this paper.

[27] for a precise connection), but this presentation is more operationally intuitive and will facilitate the development of a game model in the next section.
A category of measurable event structures
To define maps of fibred event structures we adapt the standard notion of maps between discrete fibrations of categories:
Definition 2.7 A map of fibred event structures pfE : E Ñ BEq Ñ pfE1 :
E1 Ñ BE1 q is a pair of (not necessarily rigid) maps α : E Ñ E1 and αB : BE Ñ B1
of event structures, making the diagram


E	fE α
E1	fE1
BE
αB

BE1


commute. If E , E 1 are measurable event structures with underlying fibration fE and
fE1 , respectively, pα, αBq is a measurable map if for each p P CpBEq, the map

f ´1tpu Ñ f ´1tα
pu : x ÞÑ αx is measurable w.r.t. the σ-algebra on each fibre.

E	E1	B
We will give examples of such maps in the next section, when introducing mea- surable strategies. We call MES the category of measurable event structures and measurable maps, with the obvious identities and composition.
Observe that the usual category ES of event structures embeds fully and faith- fully into MES: the embedding disc : ES Ñ MES sends E to the unique object of MES whose underlying fibration is the identity map id : E Ñ E. A measurable event structure of this form is said to be discrete.
In the rest of the paper we use E, A, B, S, T ,... to denote measurable event structures with underlying event structures E, A, B, S, T, ... respectively. When making use of the underlying data (base event structures BE, fibration maps fE, etc. ) we use subscripts to avoid ambiguity. Similarly, we write α : E Ñ E 1 for the pair pα, αBq, and for p P BE, αp refers to the restriction of α to the fibre f ´1tpu,a 

measurable function f ´1tpu Ñ f ´1tα
pu.

E	E1	B
Measurable Games and Strategies
We proceed to give a presentation of our measurable games model, in which mea- surable event structures occupy a central place: once enriched with polarity they play the roles of both processes and types.
We aim in the rest of the paper to give an interpretation to a higher-order, affine probabilistic language called PPCFR . We start by importing a few additional concepts from measure theory, to do with probability.
A sub-probability measure on a measurable space pX, ΣX q is a map μ : ΣX Ñ r0, 1s such that μpHq “ 0 and such that for any countable family tUiuiPI Ď ΣX with Ui X Uj “ H for every i ‰ j, we have μp  i Uiq “  i μpUiq. For x P X, the Dirac

measure δx is defined as δx(U ) = 1 if x ϵ U , and 0 otherwise. Finally, given a sub- probability measure μ on X and a non-negative measurable function g : X → R, the integral xєX g(x)μ(dx) is a well-defined element of |0, œ).
A stochastic kernel [14] from (X, ΣX ) to (Y, ΣY ) is a map k : X <ΣY → |0, 1]
such that for every x ϵ X the map k(x, −) is a sub-probability measure, and for every U ϵ ΣY the map k(−,U ) is measurable with respect to Σ|0,1], the subspace σ-algebra of ΣR. Such a map provides a notion of probability measure on the space Y parametrised by elements of X. Stochastic kernels can be composed: given k : X < ΣY → |0, 1] and h : Y < ΣZ → |0, 1], their composition is the map h ◦ k : X < ΣZ → |0, 1] defined as (x, U ) '→ yєY h(y, U )k(x, dy).
A probabilistic language with continuous distributions
We introduce our main language of study, PPCFR , an affine version of PCF enriched with a real number type and both discrete and continuous probabilistic primitives. It has types and terms defined as
A, B ::= Real | Bool | A ( B	M, N ::= x | λx.M | MN | † | tt | ff | if M N P 
coin | r | M “ 0 | d
where r ranges over real numbers and d over a countable set D of stochastic kernels
R < ΣR → |0, 1].
Elements of D may be thought of as families of distributions with one real pa- rameter. In an example below we use r '→ normal(r, 1), the normal distributions

with standard deviation 1. Note that PPCFR
is designed to support a proof of

concept for measurable game semantics. It lacks some features desirable for prac- tical probabilistic programming, such as more general families of distributions, and primitives for observing data and performing inference.
The language is given an affine type system in the standard way, so that in a term of the form λx.M the variable x may appear at most once in M . We give some of the typing rules, with Gnd standing for either of the ground types Real or Bool:


Γ ) † : Real
Γ ) M : Bool	Δ ) N : Gnd	Ψ ) P : Gnd

Γ, Δ,Ψ ) if M N P : Gnd

	Γ ) M : Real			
Γ ) M “ 0: Bool	Γ ) coin : Bool
d ϵ D


Γ ) d : Real ( Real



Γ ) r : Real
To define operational semantics, we follow [3,13,23] and first turn the set of terms into a measurable space. We write T Γ)A for the set of terms M for which the typing judgment Γ ) M : A is derivable. Observe that every M ϵ T Γ)A can be canonically written as S|r1/x1,..., rn/xn], where the ri are real number constants, and S is a term without any sub-term of the form r, such that Γ, x1 : Real,..., xn : Real ) S : A.

Given such an S, let T Γ)A be the subset of T Γ)A containing terms of the form

M = S|r1/x1,..., rn/xn] for some r1,..., rn. There is a bijection T Γ)A
– Rn,

and we define ΣΓ)A to be the (unique) σ-algebra which makes it an isomorphism
(T Γ)A, ΣΓ)A) – (Rn, ΣRn ) in Meas. We then take ΣT Γ)A to be the σ-algebra

S	S
Γ)A
š	Γ)A

containing no sub-terms of the form r and such that Γ, x1 : Real,..., xn : Real )

S : A for some n ϵ N.
We then define a call-by-name, deterministic reduction relation → as

We also define evaluation contexts:
C|] ::= | ] | if C|] N P | C|] “ 0 | C|] N | d C|] 
The one-step reduction relation between terms is then expressed as a stochastic

kernel redΓ)A : T Γ)A < ΣT Γ)A → |0, 1] defined for each PPCFR
term M and

U ϵ ΣT Γ)A as follows:
$δC|N ](U )	if M = C|R] and R → N
1 δC|tt](U )` 1 δC|ff ](U )	if M = C|coin]
’&
0	if M = † 
’%δM (U )	otherwise.
That red is a stochastic kernel is a straightforward adaptation of [13]. Finally, for U ϵ ΣT Γ)A , the many-step probability of reduction is Pr(M → U ) = supnєN redn(M, U ). Note that if V ϵ ΣR, we write V for tr | r ϵ V u, an element of ΣT )Real .

Games and strategies as event structures
Terms as probabilistic strategies
In the concurrent games model presented here, the term M = λr. normal(r, 1) “ 0 will be interpreted as the strategy in Figure 3a, which combines all possible execution traces of M . Each trace is recorded a dialogue between Player, representing M , and Opponent, representing the execution environment. In this example every maximal trace is of the form q− d q` d r− d b` for some r ϵ R and b ϵ ttt, ff u, and the polarity (` or −) indicates which of the two players is responsible for a move, with the convention that Player = `, Opponent = −. We read such a dialogue as follows: the initial q− is an external call to the program, the following q` is a call by the program to its argument, whose value is then supplied by the environment as r−. Finally b` is the output of the function for this particular execution.

Real	(	Bool
q−

BReal	(	BBool

q−

q`
q`
 −	
´8	8
a−




´8

(a)
tt` |
0
ff `


(b)
tt` ff `

Fig. 3. An interpretation for M “ λr. normalpr, 1qď 0.
In our model the (uncountable) set of traces will arise as the conﬁgurations of a measurable event structure, as defined in Section 2, which we will further enrich with probability in Section 4. Figure 3b shows the corresponding base event structure, which acts as a discrete representation of the control flow of the program. We omit the details of the projection map from the event structure of 3a to that of 3b, as it is clear from the labelling of moves. To formalise this we must equip measurable event structures with the extra data of a polarity function, as in e.g. [22]:
Definition 3.1 An event structure with polarity (esp for short) is an event structure E together with a polarity function polE : E → t`, −u. A map of esps is a polarity-preserving map of event structures.
Accordingly, a measurable esp is a measurable event structure E , where in addition E and BE have polarity, and fE preserves it. A map α : E → E 2 is a map of measurable esps whenever both α and αB preserve polarity.
Configurations of an esp E are ordered by inclusion, as usual. In addition, we write x Ď` y (resp. x−Ă`y) when x Ď y (resp. x−Ăy) and every e ϵ y\x has pol(e) = `; the relations Ď− and −Ă− are defined similarly.
Measurable games
As usual in game semantics, strategies are constrained by the games they play on. In this setting a measurable game is simply a measurable esp. We will eventually build a bicategory [2] with measurable games as objects, the soon-to-be-introduced measurable strategies as morphisms, and a suitable notion of 2-cells.

First we give the interpretation of PPCFR
ground types as measurable games.

The game Bool) is a discrete measurable esp, defined as the image under the functor disc of the event structure of Figure 1b, with polarity defined as pol(q) = − and pol(tt) = pol(ff ) = `. The measurable game Real) is defined as

q−	q−
			
r`ϵ R 	a`

with the only non-trivial fibre, that over the configuration tq, au, defined to be the measurable space (R, ΣR).
Measurable strategies
We forget about probability for now and until Section 4. The rest of this section is dedicated to the development of our framework for game semantics in a measurable setting. We define measurable strategies on measurable games and describe their composition and organisation as a bicategory.
As mentioned earlier, a strategy in this framework is a measurable esp which is constrained by the game it plays on. In the same way as in [22], this constraint is expressed via a labelling map relating the two esps, subject to some conditions.
Definition 3.2 A measurable strategy on a measurable game A is a measurable esp S together with a measurable map σ : S → A (explicitly: two maps σ : S → A and σB : BS → BA), such that:
courtesy: If e, e2 ϵ BS are such that e d e2 and σB(e) ­d σB(e2), then pol(e) = − and pol(e2) = `.
measurable receptivity: If p ϵ C(BS), and σB p Ď− q for some q ϵ C(BA), then there is a unique q2 ϵ C(BS) such that p Ď q2 and σB q2 = q, and further- more the diagram

f −1tq2u
σq1
rS
p,q




rA
f −1tpu
σp

f −1tqu
σBp,q
f −1tσBpu

is a pullback in Meas (where recall the horizontal arrows are restriction maps induced by the fibred structure, and the vertical ones are restrictions of σ to the respective fibres).
We will see later that both conditions serve to ensure a well-behaved interaction with copycat, the identity strategy on a game. Informally, they prevent Player from constraining Opponent’s behaviour further than is allowed by the game.
It will be useful to have a characterisation of pullbacks in Meas. Suppose X, Y, Z are measurable spaces and g : X → Y and h : Z → Y are measurable functions. The pullback
P	Π2	Z
Π1 	h
g
X  Y
exists and has underlying set the pullback in Set: P = t(x, z) ϵ X < Z | g(x) = h(z)u, with Π1 and Π2 the usual projections. The associated ΣP is the subspace σ-algebra induced by ΣX b ΣZ, using that P Ď X < Z.
We take a closer look at the two conditions of Definition 3.2 in turn. The courtesy axiom says that a strategy may only specify additional causal dependencies of Player

moves on Opponent moves. It is a constraint on BS, and indeed on S: using that fA and fS are rigid maps of esps, it is easy to see that the condition still holds replacing BS, σB with S, σ. The purpose of the receptivity axiom is twofold. Restricted to the base BS, it is the receptivity axiom of [22], stating that at any stage Player must be prepared to let Opponent play the moves that BA makes available to them. In addition, the pullback condition is a way of encoding the same axiom for the S → A component of the strategy, while enforcing that for any such Opponent extension the fibre structure of S reflects that of A.

Morphisms of measurable strategies
Often it is not appropriate to compare measurable strategies up to strict equality, so (as in [22]) we introduce a notion of morphism between them. Such morphisms play the role of 2-cells in the bicategory we define below.

Definition 3.3 For measurable strategies σ : S → A and τ : T → A,a morphism of measurable strategies is a measurable map α : S → T which commutes with the labelling maps, i.e. τ ◦ α = σ. When α is an isomorphism, we write σ – τ .


Interaction of measurable strategies
We introduce two fundamental constructions on measurable esps:

Definition 3.4 Given esps E and E2, we define E  E2 to be the event structure with events E ` E2, causality and polarity induced from E and E2, and consistent subsets those of the form X ` X2 (the disjoint union, often written X  X2) for X ϵ ConE and X2 ϵ ConE1 . Thus, the parallel composition E  E 2 of measurable esps E and E 2 is defined to be the fibration fE  fE1 : E  E2 → BE  BE1 where
the fibres are obtained as product spaces: (f	f 1 )−1tp	p2u = f −1tpu< f −1tp2u.

E	E
This makes all restriction maps measurable.
E	E1

Next, the esp EK is defined as having events, consistency and causality those of
E, and the opposite polarity: polE1 (e) = −polE (e) for all e ϵ E. Given a measurable esp E , its dual E K is given by f K = fE : EK → BK, with fibres the same as in E .
E	E

Note the above use of  as an operation on maps of esps. We observe that this operation lifts to maps of fibred and measurable esps. Furthermore, it is functo- rial and makes (MES, , 1) a symmetric monoidal category, where 1 is the empty measurable event structure. We will make use of this functorial action, and write BE  E1 and fE  E1 for BE  BE1 and fE  fE1 .
We define a measurable strategy from A to B to be one on the game AK  B. Aiming for a notion of composition, our goal is now to investigate the interaction of measurable strategies σ : S → AK  B and τ : T → BK  C. Traditionally in concurrent games, this is done via a pullback construction in the category of event

structures, which must be adapted to the fibred setting. Consider the diagram

fT fS
T © S  BT fS

Π1	v	Π2
pΠ1qB	v
pΠ2qB

S  C	A	T	BS C	BA T


σ
A τ	pσ CqB	pA  τ qB
B	C	BA B C


in the category of event structures (without polarity), where T © S and BT fS are obtained as pullbacks as indicated on the diagram (pullbacks always exist in ES, see e.g. [8]). For readability we have left out labels for horizontal fibration maps; and fT fS is the canonical map induced by the universal property of BT fS. We write τ © σ : T © S → A  B  C and (τ © σ)B : BT fS → BA  B  C for the composite maps through the diagram.
Standard reasoning (using properties of pullbacks in ES) shows that fT fS is

rigid, so that T © S = (T © S fT fS
BT fS
) is a fibred event structure. Moreover,

given p ϵ C(BT fS), the fibre f −1
{p} corresponds to the following pullback diagram

in Set:


−1
T fS
v


{p}

f −1 {(Π1)B p}	f −1
{(Π2)B p}

S  C	σ	τ	A  T

−1
A B C
{(τ © σ)B p}



We define Σ ´1
T fS
tpu so that the above is also a pullback diagram in Meas. The

induced map τ © σ : T © S → A  B  C is measurable and it is the appropriate
notion of interaction of σ and τ .
Lemma 3.5 The tuple (T © S, Π1, Π2) is the pullback of σ  C and A  τ in MES.
A bicategory of measurable strategies
Finally we organise measurable games and strategies into a bicategory. We start with composition.
Composition via hiding
We have seen that the map τ © σ : T © S → A  B  C describes the outcome of the interaction of S and T , which synchronise via moves of the game B. In order to obtain from this a measurable strategy from A to C we hide the synchronisation events of T © S.
Specifically, we define T S to be the event structure with events those e ϵ T ©S whose image under τ © σ lies in either the A or the C component of A  B  C, and with all the data of an event structure induced from T © S. The base event structure BTS is obtained from BT fS analogously with respect to BA B C .

Lemma 3.6 The restriction of fT fS to T  S is a well-deﬁned rigid map fTS :
T  S → BTS.
Proof. We check that f maps events of T  S to events of BTS. By definition, for any e ϵ T S we have (τ © σ)e ϵ A or C, and therefore (fA  B  C ◦(τ © σ))e ϵ BA or BC. Since fA  B  C ◦ (τ © σ) = (τ © σ)B ◦ fT fS, the event fTSe is an element of BT fS mapped to BA or BC by (τ © σ)B. Therefore, by definition, fTSe ϵ BTS. Then we check that fTS is a rigid map of event structures. For any x ϵ C(T S), fTSx is a configuration, since it is the restriction of fT fS|x] to events of BTS. The restriction of fTS to any configuration x coincides with the restriction of fT fS to x, so it must be locally injective. Finally, fTS preserves order because fT fS does.	l
After this step of hiding, every configuration p ϵ C(BTS) has a unique witness
|p] ϵ C(BT fS), and similarly every x ϵ C(T  S) induces |x] ϵ C(T © S), satisfying
−1 {p} – f −1 {|p]} via x '→ |x]. It is therefore natural to define Σ ´1	=
f	tpu

Σ ´1
T fS
t|p]u, modulo the iso; we get a measurable esp T  S and a measurable map

τ  σ : T  S → AK  C.
Lemma 3.7 The map τ  σ : T  S → AK  C is a measurable strategy, called the
composition of σ and τ.
Proof. We rely on the corresponding arguments in standard concurrent games – this is detailed in [8]. Here, because (τ ◦ σ)B is the composition, in the traditional sense, of strategies τB and σB, it is necessarily courteous. The composition τ  σ is receptive because the interaction τ ©σ is, which can be verified via a simple diagram chase.	l

Measurable copycat
For a measurable game A, the identity strategy on A is the measurable copycat strategy ccA : CCA → AK  A, which acts as a forwarder of information from one copy of A to the other.
The components CCA and BCCA of the measurable esp CCA are instances of the same construction. Formally, the events, polarity and consistency of CCA are those of AK  A, and the causality is that of AK  A enriched with the pairs
{((a, 1), (a, 2)) | a ϵ A and polA(a) = `} Y {((a, 2), (a, 1)) | polA(a) = −}. The base BCCA is defined as CCBA ; the maps ccA and (ccA)B are identities on events, and fCCA has the same action as fA  fA.
Given p ϵ C(BCCA ), the fibre over p is equipped with the smallest σ-algebra
making the map ccA : f −1 {p} → f −1	{(ccA)B p} measurable.
CCA	AK A
Lemma 3.8 The map ccA : CCA → AK  A is a measurable strategy. Furthermore, if σ is a measurable strategy from A to B, then σ  ccA – σ.
The proof relies on existing composition results for concurrent strategies [8], along with an analysis of the fibre structure in the interaction σ © ccA. Similarly,

we can show that composition is only associative up to isomorphism, in such a way that:
Theorem 3.9 There is a bicategory MG with measurable games as objects, mea- surable strategies as morphisms, and morphisms of measurable strategies as 2-cells.

Probabilistic Strategies
We add probability to measurable strategies by introducing the notion of valuation on a measurable esp. Although the framework of the previous section works in full generality, valuations are only well-defined on a restriction of the model where esps satisfy two additional conditions.
First, say a measurable space (X, ΣX ) is a standard Borel space (see e.g. [19]) if it is measurably isomorphic to (R, ΣR), or if X is countable and ΣX = PX, the powerset of X. A measurable esp is said to be a standard Borel esp if all its fibres are standard Borel spaces.
The next condition is usually required in probabilistic concurrent games [28,7] and forbids any races (i.e. minimal conflicts) between Player and Opponent moves in a measurable esp:
Definition 4.1 A measurable esp E is race-free if for every p ϵ C(BE), if p Ď` q
and p Ď− p2, then p2 Y q ϵ C(BE) and moreover the diagram
f −1{p2 Y q} rp1 ,p1Yq f −1{p2}

E
rq,p1Yq
E
rp,p1

f −1{q}
rp,q
f −1{p}


is a pullback in Meas. Say an esp E is race-free if the measurable esp disc(E) is race-free.
Because standard Borel, race-free esps are closed under the various constructions of Section 3, there is a sub-bicategory of MG involving only such esps. We shall assume from now on that all measurable esps are race-free and standard Borel; in particular, we regularly make use of the property that in a standard Borel space all singleton subsets are measurable. We first introduce valuations on discrete esps.

Probabilistic esps: the discrete case
We are interested in representing the uncertainty with which some configurations of an esp E occur in an execution. The probabilistic event structures with polarity of
[28] takea global approach: a conﬁguration-valuation is a function v : C(E) → |0, 1], satisfying certain axioms, where for x ϵ C(E) the coefficient v(x) is the probability that the process will reach x, given that Opponent plays all the negative moves in x.

Here we instead adopt a more local (and marginally more general) approach, and for each x ϵ C(E) we assign coefficients to positive extensions of x, i.e. configurations y ϵ C(E) such that x Ď` y. We write v(x, y) for this coefficient, representing the conditional probability that y will occur given than x has. If v(−, −) is to make sense as a form of conditional probability, we must have v(x, x) = 1, and a chain rule: v(x, z) = v(x, y)v(y, z), when x Ď` y Ď` z.
We must also ensure that v(x, −) is a probability distribution on the positive extensions of x. If those extensions are pairwise incompatible, then indeed the sum xĎ`y v(x, y) must be “ 1; if instead extensions y1,..., yn are not pairwise mutu- ally exclusive then we must account for any overlap, using the inclusion-exclusion principle. This is condition (3) in the definition below, called drop condition in
[28]; condition (4) formalises the requirement that Player and Opponent, whenever they are causally independent, are also probabilistically independent.
Definition 4.2 A (discrete) valuation on an esp E is a family of coefficients
(v(x, y))xĎ`yєCpEq indexed by positive extensions, and satisfying:
for every x ϵ C(E), v(x, x) = 1;
if x Ď` y Ď` z, v(x, z) = v(x, y)v(y, z);
if x Ď` y1,..., yn, then
ÿ(−1)|I|`1v(x, ď yi) “ 1,
I	iєI
where I ranges over nonempty subsets of {1,..., n} such that	iєI yi is consis- tent;
if x Ď` y and x Ď− x2, then v(x, y) = v(x2,y Y x2) (recall that y Y x2 ϵ C(E)
by race-freeness).
Probabilistic measurable esps: the general case
Suppose now that E is a measurable esp. We generalise Definition 4.2 by considering
a family of stochastic kernels kE  from f −1{p} to f −1{q}, indexed by positive ex-
p,q	E	E
tensions p Ď` q in C(BE). Informally, for x ϵ f −1{p}, the sub-probability measure
kE (x, −) represents the conditional distribution on those positive extensions of x lying in the fibre over q — note that all such extensions are necessarily incompati- ble. More formally, the support of kE (x, −) should be included in r−1{x}, the set

p,q
of extensions of x, so we ask that kE (x, f −1{q}\r−1{x}) = 0.
p,q

p,q	E	p,q
Lifting stochastic kernels through pullback squares
The following technical lemma will be crucial, both for generalising condition (4) and when we study the interaction of probabilistic strategies in 4.3.
Lemma 4.3 Let X, Y, Z be standard Borel spaces, and let f : Z → X and r : Y →

X be measurable functions. Consider the pullback (Y
ÐΠ——1
W —Π—→2
of r along f,

where W is seen as a subspace of Y < Z as described in Section 3.3. Then:

For every y ϵ Y , z ϵ Z, and U ϵ ΣW , the sections Uy = {z ϵ Z | (y, z) ϵ U }
and Uz = {y ϵ Y | (y, z) ϵ U } are in ΣZ and ΣY , respectively.
If k : X < ΣY → |0, 1] is a stochastic kernel satisfying k(x, Y \r−1{x}) = 0 for every x, then the map k# : Z < ΣW → |0, 1] deﬁned by k#(z, U ) = k(f (z), Uz) is a stochastic kernel.
Proof. The proof of the first statement is standard. Let k : X < ΣY → |0, 1] be a stochastic kernel, and let z ϵ Z. Then k#(z, −) is a sub-probability measure, because k(z, −) is countably additive and (−)z commutes with countable disjoint union. Now, for each U ϵ ΣW , we must show that k#(−,U ) : W → |0, 1] is measurable. For any U of the form EY < EZ, and for any V ϵ Σ|0,1], we have k#(−,U )−1V = {z ϵ Z | k(f (z), Uz) ϵ V } = {z ϵ Ez | k(f (z), EY X r−1{f (z)}) ϵ V }Y {z ϵ Z\Ez | k(f (z), H) ϵ V } but by assumption k(f (z), EY X r−1{f (z)}) = k(f (z), EY ) for any z, so we get f −1(k(−, EY )−1V X EZ)Y f −1(k(−, H)−1V \EZ),a measurable set. So the set D of U ϵ ΣW such that k#(−,U ) is measurable contains all generating elements. To show D = ΣW , by the λ-π theorem [19] it is enough to show that D is closed under complements and countable disjoint unions. This is easily checked using standard measure-theoretic arguments.	l

General valuations
We can now generalise Definition 4.2 from the discrete case, by rephrasing conditions (1)-(4) in this setting:
Definition 4.4 A valuation on a race-free measurable esp E consists of a family

KE = (kE )pĎ`qєCpB
q of stochastic kernels



kE : f −1{p}< Σ ´1
→ |0, 1]

p,q	E
fE  tqu

such that for all x ϵ f −1{p}, we have kE (x, f −1{q}\r−1{x}) = 0, satisfying the

E
following conditions:
p,q	E
p,q

kE (x, −) = δx for every x ϵ f −1{p};

p,p
if p1 Ď` p2 Ď` p3, then kE
E
E
p2,p3
p1,p2 ;

if q Ď` p1,..., pn and x ϵ f −1{q}, then
ÿ(−1)|I|`1kEŤ


(x, f −1{ď pi}) “ 1,


where I ranges over nonempty subsets of {1,..., n} such that	iєI pi is consis- tent;

if p Ď` q and p Ď− p2 then kE
= (kE )#, the lifting of kE
through the

p1 ,qYp1
p,q
p,q

pullback of the race-freeness condition for E , as in Lemma 4.3.
Definition 4.5 A probabilistic strategy on a race-free measurable game A con- sists of a measurable strategy σ : S → A, and a valuation KS on S.
Note that this is well-defined: if A is race-free then by receptivity, so is S.

Interaction of probabilistic strategies
Probabilistic strategies (σ : S → AK  B, KS) and (τ : T → BK  C, KT ) interact and compose as measurable strategies; it remains to equip the composition T  S with a valuation, and we start by making the interaction T © S probabilistic.
While doing this, we must account for the fact that T © S is not an esp: the polarity of synchronisation events is not well-defined. We say that an event e ϵ BT fS is a σ-action if (Π1)Be is a positive element of BS, and that e is a τ -action if (Π2)Be is a positive element of BT (no event is both a σ-action and a τ -action, but some events are neither of the two). For p, q ϵ C(BT fS) with p Ď q, we write p Ďσ q (resp. p Ďτ q) if all events of q\p are σ-actions (resp. τ -actions). Whenever

p Ďσ q, we see that the fibre f −1
{q} extends f −1
{p} according to S:


Lemma 4.6 If p Ďσ q in C(BT fS), with (Π1)Bq = qS  qC and (Π1)Bp = pS  pC, then the diagram


−1
T fS
{q}
rp,q
−1
T fS
{p}

ΠS 	ΠS

f −1{qS}
rpS,qS
f −1{pS}


is a pullback, where ΠS is Π1 composed with the projection f −1 {qS  qC} → f −1{qS}

(and similarly for p).
S C	S


Of course the corresponding result holds for τ -extensions, and therefore using

Lemma 4.3 we can define a family of stochastic kernels kT fS
indexed by p, q ϵ

C(BT fS) such that p Ďσ q or p Ďτ q, by lifting through the pullback square the relevant kernel in KS or KT .
For p, q ϵ C(BT fS), write p Ď`,0 q if p Ď q and all events in q\p have ei- ther positive or neutral polarity. If p Ď`,0 q, then there exists a covering chain p−Ăλ1 u1−Ăλ2 ... −Ăλn un−Ăλn`1 q, with λi ϵ {σ, τ } for each i. With respect to this
chain we can define a kernel kT fS	= kT fS ◦ ¨¨¨ ◦ kT fS. In fact, we will see

p,u1,...,un,q
un,q
p,u1

that the properties of the valuations KS and KT ensure that this kernel does not
depend on the particular choice of chain. We first prove two auxiliary lemmas.

Lemma 4.7 Let λ ϵ {σ, τ } and suppose p−Ăλu−Ăλq in C(BT fS). Then kT fS =
kT fS ◦ kT fS.
u,q	p,u

Proof. It is enough to show that the lifting (−)# of Lemma 4.3 preserves compo- sition. It is a straightforward verification.	l


Lemma 4.8 If p−Ăσq and p−Ăτ p2 in C(BT fS
), then p2 Yq ϵ C(B

T fS
T fS q,p1Yq

kT fS = kT fS	◦ kT fS.

p,q
p1 ,p1Yq
p,p1

Proof. Using that S and T are race-free, it is easy to see that


−1
T fS
{q Y p2} rq,qYp1
−1
T fS
{q}

rp1 ,qYp1

−1
T fS


{p2}



rp,p1
rp,q
−1
T fS


{p}



is a pullback in Meas. Then, for x ϵ f −1
, we check that the sub-probability

measures kT fS
kT fS(x, −) and kT fS
kT fS(x, −) on f −1 {q Y p2} are the same.

q,p1Yq
p,q
p1 ,p1Yq
p,p1	T f

It is sufficient that they agree on all U ϵ Σf ´1 tqYp1u
such that U Ď r−1
{x}, and

an inspection of the pullback above shows that r−1
{x}, viewed as a subspace of

f −1 {q Y p2}, is isomorphic to the product r−1 {x}< r−1{x}.

T f
Moreover, using that the diagrams
p,p1
p,q



−1
T fS
ΠT
{p2}
rp,p1
−1
T fS
ΠT
{p}
−1
T fS
ΠS
{q}
rp,q
−1
T fS
ΠS
{p}

f −1{p2 }
rp ,p1 T
f −1{pT }
f −1{qS}
rpS

,qS
f −1{pS}

T	T	T	S	S


are pullbacks, we see that r−1 {x} – r−1
{x } and r−1{x} – r−1
{x }. So we let

p,p1
pT ,p1	T
p,q
pS,qS	S

U be of the form E < E2 for measurable sets E Ď r−1
1 {xT } and E2 Ď r−1
{xS}.

Then, we have


T fS q,p1Yq


kT fS(x, U )
pT ,pT
pS,qS

T fS
´1	q,p1Yq
(y, U )kT fS(x, dy)

yєfT fS tqu
=	kT	1

(yT , Uy)kS	(xS, dyS)

yєr´1txu
= ż	kT
qT ,pp YqqT

1 (rp,q(z), E)kS
pS,qS

(xS, dz)

zєE1
pT ,pT
pS,qS

= ż	kT

1 (xT , E)kS

(xS, dz)

zєE1
= kS
pT ,pT	pS,qS
(xS, E2)< kT	1 (xT , E2)

pS,qS
pT ,pT

and a symmetric calculation shows that kT fS	◦ kT fS(x, U ) has the same value.l
We can now show that any two parallel chains in T ©S yield the same composite kernel:
Lemma 4.9 If p Ď`,0 q ϵ C(BT fS) and we have two chains
p−Ăλ1 u1−Ăλ2 ... −Ăλn´1 un−1−Ăλn q
p−Ăρ1 u2 −Ăρ2 ... −Ăρn´1 u2	−Ăρn q
1	n−1

where λ ,ρ ϵ {σ, τ } for each i, then kT fS
= kT fS
. Thus we may write

i	i	p,u1,...,un,q
p,u1 ,...,u1 ,q

1	n
kT fS for the kernel obtained via any chain.
Proof. By induction on n. If n = 0, the result holds directly since there is only one possible chain from p to q. If n ą 0, consider v = u1 Y u2 . By the induction hypothesis, any chain from u1 to q yields the same kernel, so in particular
kT fS	= kT fS ◦ kT fS

u1,u2,...,un,q
v,q
u1,v



and similarly we have

kT fS

= kT fS ◦ kT fS.

u1 ,u1 ,...,u1 ,q
v,q
u1 ,v

1 2	n	1
Next, observe that p−Ăλ1 u1−Ăρ1 v and p−Ăρ1 u2 −Ăλ1 v. If λ1 = ρ1, then it follows from Lemma 4.7 that kT fS ◦ kT fS = kT fS ◦ kT fS, since both are equal to kT fS. If

u1,v
p,u1
u1 ,v
p,u1
p,v

instead λ1 ‰ ρ1, then Lemma 4.8 shows that the same equality holds. Thus

T fS p,u1,...,un,q
T fS u1,...,un,q
T fS p,u1

= kT fS ◦ kT fS ◦ kT fS

v,q
u1,v
p,u1

= kT fS ◦ kT fS ◦ kT fS

v,q
u1 ,v
p,u1

= kT fS ◦ kT fS ◦ kT fS

v,q
u1 ,v
p,u1

T fS	T fS
u1 ,...,u1 ,q	p,u1
1	n	1
= kT fS	.
p,u1 ,...,u1 ,q
1	n
l
Following the above process, we obtain a family KT fS = (kT fS)pĎ`,0q of kernels, indexed by the positive/neutral extensions in C(BT fS). The following lemma will be central to proving that probabilistic strategies are closed under composition.
Lemma 4.10 The family of kernels KT fS satisﬁes the following properties:

kT fS(x, −) = δx for every x ϵ f −1
{p};

p,p	T fS
if p1 Ď`,0 p2 Ď`,0 p3, then kT fS = kT fS ◦ kT fS ;
p1,p3	p2,p3	p1,p2
if q Ď`,0 p1,..., pn and x ϵ f −1 {q}, then

ÿ(−1)|I|`1kT ŤfS


(x, f −1
{ď pi}) “ 1,


where I ranges over nonempty subsets of {1,..., n} such that	iєI pi is consis- tent;

if p Ď`,0 q and p Ď− p2 then kT fS
= (kT fS)#, the lifting of kT fS
through

p1 ,qYp1
p,q
p,q

the pullback of the race-freeness condition for T © S, as in Lemma 4.3.
Proof. Properties (1) and (2) hold by definition, (4) is a straightforward verifi- cation, and the argument for (3) is similar to that in the discrete case, see e.g. [25].	l

Composition and copycat
Recall from 3.5.1 that every configuration p of the composition BTS has a unique interaction witness |p]  ϵ  BTS, and the fibre over p is defined as
−1 {p} = f −1 {|p]}. Whenever p Ď` q in C(BTS), it must be the case that
|p] Ď`,0 |q], and therefore we may set kTS = kT fS .	This defines a family

KT S = (kT S )pĎ`qєCpB
q, and it is a direct consequence of Lemma 4.10 that

this satisfies the axioms of Definition 4.4. Therefore:
Lemma 4.11 The family KT S is a valuation on T  S, so that (τ  σ, KT S) is a probabilistic strategy, called the composition of (σ, KS) and (τ, KT ).
Finally, for any measurable and race-free game A, we make the copycat strategy ccA : CCA → AK  A probabilistic.

Lemma 4.12 For p, q ϵ C(BCCA
) such that p Ď` q, for every x ϵ f −1 {p} there is
A

a unique y ϵ f −1 {q} such that rp,q (y) = x, and setting kCCA (x, U ) = δy(U ) deﬁnes

CCA
a stochastic kernel.
p,q

It is straightforward to check that the family KCCA made up by the kCCA is
a valuation. So as before, we proceed to construct a bicategory with race-free measurable games as objects, and probabilistic strategies as morphisms, and where copycat is the identity morphism. If σ : S → A to τ : T → A are probabilistic strategies, a map α : S → T is a morphism of probabilistic strategies if it is a morphism of measurable strategies such that for all p Ď` q ϵ C(BS), and for all

x ϵ f −1{p} and U ϵ Σ ´1
, we have kS
(x, α−1U ) “ kT
(αx, U ).

S	fT  tαB qu
p,q
αB p,αB q

Theorem 4.13 There is a bicategory PG with race-free standard Borel games as objects, probabilistic strategies as morphisms, and morphisms of probabilistic strate- gies as 2-cells.

Game Semantics for PPCFR

We define the semantics of PPCFR
in PG, or rather in the quotiented category

PG– where probabilistic strategies are considered up to isomorphism, as usual in concurrent game semantics.
Call a measurable esp E negative if the initial moves in BE (and therefore in E) are negative. Let PG− be the subcategory of PG– consisting of negative games and negative (isomorphism classes of) strategies. We can show that (PG−, , 1) is symmetric monoidal closed and, in a special case sufficient for our purposes, the function space A ( B can be characterised as follows:
Lemma 5.1 If A, B are negative esps such that B has a unique initial move b0, then A ( B has events, polarity and consistent sets those of AK  B, and causality the transitive closure of “AK  B Y{(b0, a) | a initial in A}. If A, B are measurable games where BA (and therefore A) has a unique initial move, then fA(B : (A (

B) → (BA ( BB) is deﬁned to have the same action as fAK B. For any p ϵ

C(BA ( BB), f −1
{p} = f −1
{p}.



The interpretation of PPCFR
ground types was given in 3.2, and for higher

types we set A ( B) =  A) ( B). The interpretation of the discrete part

of PPCFR
(that is, the PCF primitives and coin) follows the standard one (see

e.g. [9,7]) and is made measurable via the functor disc. The strategy †) is the unique (up to iso) strategy on Real) with no positive moves. The constant r is interpreted by r) : S → Real), where S is the measurable sub-esp of Real) with unique maximal configuration {q−, r`}, and with base BS = BJReal). It remains to define the kernel for the extension {q} Ď` {q, a}: given the unique element of
f −1{{q}}, it behaves like the Dirac measure on the singleton set f −1{{q, a}}.
S	S
Then, M “ 0 )Γ is defined as the composition of M )Γ with a strategy “ 0
from Real) to Bool). Similarly for each d ϵ D, d)Γ is a probabilistic strategy from Real) to Real) behaving like the kernel d. We omit their explicit definition, hoping that both of them are reconstructible from the example of Figure 3.
Probability of convergence of a strategy
We now aim to compare the probability of convergence of a closed term to that of its interpretation. The former was defined in 3.1, and we say here what we mean by the probability of convergence of a ground type strategy.
If σ : S → Bool) is a probabilistic strategy, then we observe that by receptivity, there is a unique p0 ϵ C(BS) such that σBp0 = {q−}, and necessarily f −1{p0} is a singleton, containing some x ϵ C(S). For b ϵ {tt, ff }, the probability of convergence Pr(σ → b) is a sum, indexed by configurations of BS mapping to
{q, b}, of the total measure of the corresponding fibre. That is,


Pr(σ → b) = 
pєCpBS q
σB p“tq,bu
S
p0,p
(x, f −1{p}).

Similarly, if τ : T →  Real), we write p0 and x for the unique configurations

over {q−}. If U ϵ ΣR, viewed as a measurable subset of the fibre f −1
{{q, a}}, we

set
Pr(τ → U ) = 
pєCpBT q
τB p“tq,au

T
p0,p

(x, σ−1U ),

where σ−1U  is well-defined since σp is a measurable function f −1{p}	→

−1
JReal)
p	S
{{q, a}}.

Soundness
Next, we prove that our semantics is sound by relating, in Theorem 5.3 below, the denotation of a closed term to the denotations of its reducts. As a special case of the result, we obtain that for a term ) M of type Real, if U ϵ ΣR, the following

equality holds:
Pr( M ) → U ) =	Pr( N ) → U )red(M, dN ).
N єT )Real
The next lemma ensures that the integral on the right-hand side is well-defined:
Lemma 5.2 Let A be a PPCFaff type of the form A1 → ¨¨¨ → An → Gnd for some ground type Gnd. Suppose αi : Ai), i = 1,..., n, are probabilistic strategies. Then the function h : T )A < ΣJGnd) → |0, 1] deﬁned as
(M, U ) '→ Pr( M )(αi)n	→ U


is a stochastic kernel, where M )(αi)n
is short for (Λ−1)n( M ))  ( n
αi).

Proof. That h(M, −) is a sub-probability measure for fixed M is straightforward, using the drop condition on probabilistic strategies. So we fix U ϵ ΣGnd and show that h(−,U ) is measurable. Recall that T )A is defined as a coproduct, so it is sufficient to show that for every term y1 : Real,..., ym : Real ) S : A containing

no constants of the form r, the map Rm → |0, 1] defined as (ri)m
'→ h(S|ri/yi],U )

is measurable. This follows from a more general result, stating that for any strategy

σ from Real)m to Real), the map (ri)m
'→ Pr(σ( ri))m
→ U ) is measurable.l

Theorem 5.3 (Soundness) Let A = A1 → ¨ ¨ ¨ → An → Gnd for some ground type Gnd, let αi be a probabilistic strategy on Ai) for each i = 1,..., n, and let U ϵ ΣGnd. Then


Pr( M )(αi)n
→ U ) = 
N єT )A
Pr( N )(αi)i=1 → U )red(M, dN ).

Proof. We examine each case in the definition of red. The details are standard.l
Adequacy
Our final result is adequacy, showing that the probability of convergence of a term and that of its interpretation coincide:

Theorem 5.4 (Adequacy) Let ) M : Bool be a PPCFR
term. Then for b ϵ

{tt, ff }, we have Pr(M → b) = Pr( M ) → b). Similarly, if ) M : Real is a

PPCFR
term and U ϵ ΣR, then Pr(M → U ) = Pr( M ) → U ).

The proof uses the soundness theorem and follows a standard argument based on logical relations. We omit the details.
Conclusion
The model we defined in this paper is strongly intensional. Compare, for instance, the primitive coin with the term M = if(normal(0, 1) “ 0) tt ff . Both give rise to the same probability distribution on {tt, ff }. But viewed as a strategy, coin) has

only two positive events, one for tt and one for ff , whereas M ) has a continuum of such events, with the probability equally spread between those labelled tt and those labelled ff , according to normal(0, 1). This level of intensionality informs our under- standing of probabilistic programs and will facilitate the addition of computational effects to the language.
There are many opportunities for further work. A sequel paper will combine the present work with the thin concurrent games of [10], already enriched with discrete probability in [7]. This gives rise to a cartesian closed category which one can use to give semantics to a non-affine probabilistic language. Furthermore, by moving to a call-by-value setting using standard game semantics techniques [17], one could apply the framework to those probabilistic programming languages designed for Bayesian modelling and inference. It may in particular be useful in connection with inference algorithms involving an exploration of the space of execution traces (e.g. [29]).

References
Abramsky, S., R. Jagadeesan and P. Malacaria, Full abstraction for pcf, Information and Computation
163 (2000), pp. 409–470.
B´enabou, J., Introduction to bicategories, in: Reports of the Midwest Category Seminar, Springer, 1967,
pp. 1–77.
Borgstr¨om, J., U. D. Lago, A. D. Gordon and M. Szymczak, A Lambda-Calculus Foundation for Universal Probabilistic Programming, CoRR abs/1512.08990 (2015).
URL http://arxiv.org/abs/1512.08990
Bru¨mmer, G., Topological categories, Topology and its Applications 18 (1984), pp. 27–41.
Castellan, S., “Concurrent structures in game semantics,” Ph.D. thesis, Universit´e de Lyon (2017).
Castellan, S. and P. Clairambault, Causality vs. interleavings in concurrent game semantics, , 59, Schloss Dagstuhl-Leibniz-Zentrum fuer Informatik, 2016.
Castellan, S., P. Clairambault, H. Paquet and G. Winskel, The Concurrent Game Semantics of Probabilistic PCF, in: Logic in Computer Science (LICS), 2018 33rd Annual ACM/IEEE Symposium on, ACM/IEEE, 2018, p. to appear.
Castellan, S., P. Clairambault, S. Rideau and G. Winskel, Concurrent Games.
Castellan, S., P. Clairambault and G. Winskel, The Parallel Intensionally Fully Abstract Games Model of PCF, in: Logic in Computer Science (LICS), 2015 30th Annual ACM/IEEE Symposium on, IEEE, 2015, pp. 232–243.
Castellan, S., P. Clairambault and G. Winskel, Concurrent hyland-ong games (2016), https://arxiv.org/abs/1409.7542.
Castellan, S., P. Clairambault and G. Winskel, Observably deterministic concurrent strategies and intensional full abstraction for parallel-or, in: 2nd International Conference on Formal Structures for Computation and Deduction, 2017.
Danos, V. and R. S. Harmer, Probabilistic game semantics, ACM Transactions on Computational Logic (TOCL) 3 (2002), pp. 359–382.
Ehrhard, T., M. Pagani and C. Tasson, Measurable cones and stable, measurable functions: a model for probabilistic higher-order programming, Proceedings of the ACM on Programming Languages 2 (2018),
p. 59.
Giry, M., A categorical approach to probability theory, in: Categorical aspects of topology and analysis, Springer, 1982 pp. 68–85.
Halmos, P.-R., “Measure Theory.” D. Van Nostrand Company, Inc., John Wiley & Sons, 1950.


Harmer, R., “Games and full abstraction for non-deterministic languages,” Ph.D. thesis, University of London.
Honda, K. and N. Yoshida, Game-theoretic analysis of call-by-value computation, Theoretical Computer Science 221 (1999), pp. 393–456.
Hyland, J. M. E. and C.-H. Ong, On full abstraction for PCF: I, II, and III, Information and computation 163 (2000), pp. 285–408.
Kallenberg, O., “Foundations of modern probability,” Springer Science & Business Media, 2006.
Ong, L. and M. Va´k´ar, S-finite Kernels and Game Semantics for Probabilistic Programming, in:
POPL’18 Workshop on Probabilistic Programming Semantics (PPS), 2018.
URL  https://pps2018.soic.indiana.edu/files/2018/01/pps18-game-sem-prob-prog.pdf
Plotkin, G. D., LCF considered as a programming language, Theoretical computer science 5 (1977),
pp. 223–255.
Rideau, S. and G. Winskel, Concurrent strategies, in: Logic in Computer Science (LICS), 2011 26th Annual IEEE Symposium on, IEEE, 2011, pp. 409–418.
Staton, S., H. Yang, C. Heunen, O. Kammar and F. Wood, Semantics for probabilistic programming: higher-order functions, continuous distributions, and soft constraints, arXiv preprint arXiv:1601.04943 (2016).
Varacca, D., H. V¨olzer and G. Winskel, Probabilistic event structures and domains, in: CONCUR 2004-Concurrency Theory, Springer, 2004 pp. 481–496.
Winskel, G., The ECSYM Notes .
Winskel, G., “Events in Computation,” Ph.D. thesis (1980).
Winskel, G., Event structures as presheavestwo representation theorems, in: International Conference on Concurrency Theory, Springer, 1999, pp. 541–556.
Winskel, G., Distributed probabilistic and quantum strategies, Electronic Notes in Theoretical Computer Science 298 (2013), pp. 403–425.
Wood, F., J. W. Meent and V. Mansinghka, A new approach to probabilistic programming inference, in: Artificial Intelligence and Statistics, 2014, pp. 1024–1032.
