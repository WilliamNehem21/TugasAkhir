Recent work has focused on selective transformations for different reasons. Reppy introduced a local CPS transformation in an otherwise direct-style compiler to improve the efficiency of nested loops [18]. Kim and Yi defined coercions between direct style and CPS terms with no other effects than non- termination, allowing arbitrary subexpressions to be transformed, and facili- tating interfacing to external code in both direct style and CPS. The selective

Section 2 gives the syntax and semantics of a small, typed functional language with control effects, and shows the traditional (non-selective) CPS transfor- mation. Section 3 extends the language with effect annotations which are verified by an effect system, and defines the selective CPS transformation guided by these annotations. Section 4 proves the correctness of the selective CPS transformation using Plotkin-inspired colon translations, and Section 5 concludes.

As stated in the previous section, we treat trivial and serious expressions dif- ferently. Trivial expressions are those that have no computational effects and serious expressions are those that might have effects. The safe approximation used by the standard CPS transformation assumes that any application might have effects, which is not unreasonable when one considers nontermination as an effect.

These are the minimal annotations needed for our purpose. We treat values and identifiers (the traditional trivial expressions) as if they were annotated as such, i.e., (e)T is a match for any trivial expression, just as (e)N matches the two control operators.

We have to treat functions and applications with special care. When a lambda abstraction is applied at an application point, the body of the abstrac- tion is also evaluated at that point. If the body is not trivial, then neither is the application, and after selective CPS transformation, the transformed application must pass a continuation to the transformed body, and the body should expect a continuation.

In a higher-order program, more than one abstraction can be applied at the same application point, and after transformation, all of these abstractions must either expect a continuation or not. That means that all functions that can end up in a given application must be transformed in the same way. That divides the abstractions into two groups, those transformed into CPS, i.e., expecting a continuation, and those kept in direct style, i.e., not expecting a continuation. Some abstractions with a trivial body might be transformed to expect a continuation in order to match the other abstractions that reach the same application points.

With these reduction rules, an expression marked non-trivial can reduce to one marked trivial, typically by reducing it to a value. If that happens to one of the subexpressions of an application, we can suddenly be in the situation where both of the subexpressions are trivial as well as the bodies of the functions expected to be applied there, and the entire application could now be consistently annotated as trivial. The weakening in the effect-typing rule for applications is there to avoid that such a change would mandate changes to annotations not local to the reduction taking place.

The idea of the colon translation is that in e : k, the k represents the context of e, which in the transformed program has been collected in a contin- uation: a function expecting the result of evaluating e. The colon separates the source program to the left and the transformed program to the right of it. In the selective CPS transform, some contexts are not turned into continua- tions, namely the contexts of expressions marked trivial, since such expressions are not transformed to CPS expressions, and as such does not expect a con- tinuation.

The e : E-translation is not as significant as the e : k-translation, since all it does is apply the St-function to the argument, i.e., if e is a trivial expression then e : E = E[St[e]]]. There are no administrative reductions to bypass in direct style.

It is possible to prove results similar to the present ones for other choices of effects and combinations of effects. A sensible choice would be a monadic effect of state and control, since it is sufficient to implement all other choices of layered monads [11]. A proof similar to the present one for both state and control effects would be a logical next step.

The method of extending the colon translation to selective CPS transformation was originally developed in cooperation with Jung-taek Kim and Kwangkeun Yi from KAIST in Korea, and with Olivier Danvy from BRICS in Denmark. The present work would not have been possible without their inspiration. Thanks are also due to Andrzej Filinski and to the anonymous referees for their comments.

Jung-taek Kim, Kwangkeun Yi, and Olivier Danvy. Assessing the overhead of ML exceptions by selective CPS transformation. In Greg Morrisett, editor, Record of the 1998 ACM SIGPLAN Workshop on ML and its Applications, Baltimore, Maryland, September 1998. Also appears as BRICS technical report RS-98-15.

