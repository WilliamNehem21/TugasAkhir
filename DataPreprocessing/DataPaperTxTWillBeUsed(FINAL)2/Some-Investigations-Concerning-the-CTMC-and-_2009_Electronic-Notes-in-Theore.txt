

Electronic Notes in Theoretical Computer Science 229 (2009) 145–163
www.elsevier.com/locate/entcs

Some Investigations Concerning the CTMC and the ODE Model Derived From Bio-PEPA
Federica Ciocchetta 1 ,a, Andrea Degasperi 2 ,b,
Jane Hillston 3 ,a and Muffy Calder 4 ,b
a Laboratory for Foundations of Computer Science, The University of Edinburgh, Scotland
b Department of Computer science, University of Glasgow, Scotland

Abstract
Bio-PEPA is a recently defined language for the modelling and analysis of biochemical networks. It supports an abstract style of modelling, in which discrete levels of concentration within a species are considered instead of individual molecules. A finer granularity for the system corresponds to a smaller concentration step size and therefore to a greater number of concentration levels. This style of model is amenable to a variety of different analysis techniques, including numerical analysis based on a CMTC with states reflecting the levels of concentration.
In this paper we present a formal definition of the CTMC with levels derived from a Bio-PEPA system. Furthermore we investigate the relationship between this CTMC and the system of ordinary differential equations (ODEs) derived from the same model. Using Kurtz’s theorem, we show that the set of ODEs derived from the Bio-PEPA model is able to capture the limiting behaviour of the CTMC obtained from the same system. Finally, we define an empirical methodology to find the granularity of the Bio-PEPA system for which the ODE and the CTMC with levels are in a good agreement. The proposed definition is based on a notion of distance between the two models. We demonstrate our approach on a model of the Repressilator, a simple biochemical network with oscillating behaviour.
Keywords: Systems Biology, process algebras, analysis, ordinary differential equations, Markov chains


Introduction
In the recent years there have been various applications of process algebras for the study of biochemical networks [18,17,3,8,1]. An attractive feature of process al- gebras is the simple abstraction they offer for representing biological entities. In the π-calculus and related calculi [18,17] each biochemical molecule is abstracted by a process and reactions are represented by means of communications between

1 fciocche@inf.ed.ac.uk
2 andrea@dcs.gla.ac.uk
3 jeh@inf.ed.ac.uk
4 muffy@dcs.gla.ac.uk

1571-0661/© 2009 Elsevier B.V. Open access under CC BY-NC-ND license.
doi:10.1016/j.entcs.2009.02.010

processes. In the recently defined Bio-PEPA formalism [5,6] a different view has been proposed: each component abstracts the behaviour of a species. In particu- lar, species concentrations are discretized into levels and the components capture concentration levels within a species. The granularity of the system is expressed in terms of the concentration step size h: when h decreases, the number of levels increases. This modelling style, based on discrete concentration levels, gives rise to an underlying continuous time Markov chain (CTMC) which we will call the “CTMC with levels” to distinguish it from the CTMC which underlies a stochastic simulation based on individual molecules.
Since Bio-PEPA is an intermediate, formal, compositional representation of the biological model it supports different kinds of analysis, including stochastic simulation [11], analysis based on ordinary differential equations (ODEs), numerical solution of the CTMC with levels and stochastic model checking using PRISM [16]. It is worth noting that each of these analyses can aid understanding different aspects of the behaviour of the system. Furthermore, when two analyses overlap in scope, the results obtained can used for verification.
This paper makes the following contributions:
a formal definition of the CTMC with levels;
an investigation of the relationship between CTMC with levels and ODEs ob- tained from the same Bio-PEPA system;
a proposal for a methodology to find the granularity h for which these two un- derlying models are in good agreement.
Whilst our work is presented in the context of Bio-PEPA it has potential appli- cation to a much wider class of models.
The CTMC with levels was introduced in [2] together with the PEPA reagent- centric view and was subsequently also used in [4]. One advantage of this approach is that it is based on discrete levels of concentration instead of exact numbers of molecules, allowing us to deal with incomplete information about molecular con- centrations, as given in real experimental settings. Furthermore, in comparison to the CTMC underlying a stochastic simulation, it leads to a reduction of the state space, leading to models which may be amenable to numerical solution and ap- proaches such as stochastic model checking. The authors of [2] focused on the case of reactions with mass-action kinetics and stoichiometry equal to one for all the reagents. Here we extend this approach to the general case and we investigate some properties of these Markov chains. Note that this approach is an approximation and does represent some loss of information compared to both the stochastic sim- ulation (in which all molecules are represented individually) and ODE model (in which concentrations vary continuously rather than in discrete jumps).
The second aspect of our work concerns an investigation of the relationship between the CTMC with levels and the set of ODEs obtained from the same Bio- PEPA system. Confidence in the compatibility between the two models is important since we can use them to perform different kinds of analysis. For instance we can check some properties of the system using model checking before simulating the

model using ODEs. The validity of the results depends on the agreement between the two approaches. The relationship between the ODEs and the CTMC derived from a process algebra model has been previously investigated in [10], but in that case the authors focused on the pathway centric-view in PEPA. Here we adapt their approach to the reagent-centric style modelling supported by Bio-PEPA. Using Kurtz’s theorem [13] we show that the set of ODEs derived from Bio-PEPA is able to capture the limiting behaviour of the CTMC with levels representing the discretised system. This involves showing that the CTMC belongs to the family of density dependent CTMCs, i.e. the rates of the CTMC may depend on a scaled representation of states, in our case the step size of the species concentrations.
The last challenge is to determine a value for the step size h which gives good agreement between the two models. In other words, for a fixed error ϵ, we want to find a value h for which the two models differ by less that ϵ. This leads us to consider how to express the difference between models and propose an approach based on the definition of a distance function between the models.
The rest of the paper is structured as follows. Section 2 gives a brief introduc- tion to Bio-PEPA, a description of the definition of discrete levels and transition rates in the language. In Section 3 the CTMC with levels is defined. The map- pings from Bio-PEPA to ODEs and CTMCs with levels are described in Section 4 and the relationship between these models is discussed in Section 5. In Section 6 the repressilator model, a genetic network with oscillating behaviour, is considered to illustrate and test our approach. Finally, in Section 7, some conclusions and directions for future work are reported.

Bio-PEPA
In this section we present a short description of Bio-PEPA [5,6] and then we discuss the definition of discrete levels of concentration and how to derive the transition rates from the reaction kinetic laws. Some auxiliary definitions for Bio-PEPA and the operational semantics are reported in the Appendix A.
The context of application is biochemical networks. A biochemical network is composed of n species that interact through m reactions in o compartments. The dynamics of reaction j is described by a kinetic law fj. The stoichiometric coefficients of the reactions are assumed to be integer and bounded. We make the following assumptions:
only irreversible reactions are considered: reversible reactions can be seen as the union of a pair of forward and inverse reactions;
the reactants of the reaction can only decrease their concentration whereas the products can only increase it. Enzymes and inhibitors do not change;
the same species in different situations (e.g. phosphorylated, free, bound...) are regarded as different species and represented by distinct Bio-PEPA components;
compartments are static and do not play an active role in reactions. Throughout this paper we assume that all reactions take place within a single compartment.

The syntax of Bio-PEPA is defined as:
S ::= (α, κ) op S | S+S | C	P ::= P D  P | S(l)	where op = ↓|↑ | ⊕| g|⊙ .

The component S is a sequential component (or species component ) and repre- sents the species; the component P , a model component, describes a system as the interactions between components. The parameter l ∈ N represents the discrete level of concentration. In the prefix term (α, κ) op S, κ is the stoichiometry coefficient of the species and the preﬁx combinator “op” represents the role of the element in the reaction. Specifically, ↓ indicates a reactant, ↑ a product, ⊕ an activator, g an inhibitor and ⊙ a generic modiﬁer. The operator “+” expresses the choice between
def
possible actions and the constant C is defined by an equation C = S. Finally,
the process P D  Q denotes the synchronisation between components: the set L
L
determines those activities on which the operands are forced to synchronise. We
can define a Bio-PEPA system as follows:
Definition 2.1 A Bio-PEPA system P is a 6-tuple ⟨V, N , K, FR,Comp,P ⟩, where: V is the set of compartments, N is the set of quantities describing each species, K is the set of parameters, FR is the set of functional rates, Comp is the set of definitions of sequential components, P is the model component describing the system.
Each element in the set N associates the step size, initial concentration, number of levels and compartment with a species. We denote the set of well-defined Bio- PEPA systems P˜ (see [6] for more details). The behaviour of the system is defined in terms of an operational semantics (see Appendix A). The derivation of the rate
is reported in Section 2.3.
Dimerization example
Let us consider the system composed of the following two reactions, representing the dimerization of a protein and its inverse process:

fMA(k1)	fMA(k2)
2A −−−−−→ B	B −−−−−→ 2A	(1)
The dynamics are mass-action kinetics (fMA(k1)= k1 · A2 and fMA(k2)= k2 · B, respectively). We assume that initially A = 10 mol/l and B = 0 mol/l and k1 = k2 = 1.0. This simple network will be used as a running example throughout the remainder.
In Bio-PEPA, we define for each species the step size (h), the number of levels (N ), the initial concentration (M0) and the compartment containing the species (cell):
A : h = 5, N = 2, M0 = 10, cell;	B : h = 5, N = 1, M0 = 0, cell;
The stoichiometry of A in the reactions is two and so we need at least two levels for
A. This is the coarsest granularity possible. We denote the two reactions α1 and α2
respectively, and define the functional rates: fα1 = fMA(k1) and fα2 = fMA(k2).

At this point we can define the set of species components:
A = (α1, 2)↓A + (α2, 2)↑A	B  =  (α1, 1)↑B + (α2, 1)↓B;

The model component is: A(2)  D 
{α1 ,α2}

B(0).


Discrete levels of concentration
Each species is characterised by a number of concentration levels, with step size (granularity) h. Specifically, we assume that all the species in the same compartment have the same step size 5 . This follows from the law of conservation of mass: there must be a “balance” between the number of molecules consumed (reactants) and the ones created (products). Note that a finer granularity of a Bio-PEPA system corresponds to a smaller step size.
We assign to each species different concentration levels, from 0 to a maximum number N. This ensures that the CTMC has a finite state space — a condition which is necessary to make numerical analysis feasible. The maximum level Ni for each species i is defined according to prior knowledge and experimental evidence. Given a maximum concentration Mi for the species i, the maximum level is given by [Mi/h|. If the maximum values are not available we can consider stochastic simulation to obtain an estimate for the upper bound of the concentration [7].
If li is the current level for species i, the concentration is taken to be xi = li · h.
The initial concentration and the initial level of i are xi,0 and li,0, respectively.

Derivation of rates
In the following we show how to derive the transition rates when discrete concentra- tions are used. The transition rate is defined by (Δt)−1, where Δt is the time taken to vary the concentration of reactants/products a number of levels in the CTMC. Stoichiometry equal to one: Let fj be the kinetic law and let y be one product of the reaction j. The rate equation for that species with respect to the given reaction is dy/dt = fj(x¯), where x¯ is the set (or a subset) of the reactants/modifiers of the reaction. Applying the Taylor expansion (up to two terms) we obtain:
yn+1 ≈ yn + fj(x¯n) · (tn+1 − tn)
We define yn+1 − yn =1 · h and then derive the respective time interval (tn+1 −
tn)= Δt as Δt =  h . From this we obtain the transition rate fj (x¯n) . Note that
fj(x¯n)	h
if stoichiometry one we have a variation of one level between the states.
Stoichiometry possibly different from one: We assume the kinetic law is mass- action in this case. Let y be a product of the reaction and let κ be its stoichiometric

5 For modifiers the step size can be chosen arbitrarily since their concentration is unchanged by a reaction.

coefficient with respect to that reaction. Applying the expansion again we obtain:


nr
κi i,n

· (tn+1 − tn)

i=1
where r is the rate constant, xi, with i = 1, ..., nr are the reactants of the reaction,
κi are the associated stoichiometric coefficients and nr is the number of distinct

reactants in the reaction.

Qnr	κi

Now we can fix y
n+1
— yn
r·
= κ · h. and derive the rate as
i=1 xi,n
h

To summarise, the rate associated with a transition (representing a reaction j)
from one state u to another state v can be calculated as: rj = fj [u] , where h is the step size of the reactants and fj[u] is the evaluation of the functional rate in the state u. When the stoichiometric coefficient of a reagent is κ then the reagent varies by κ levels as a result of the transition.
The kinetic law function fj for reaction j must satisfy some mild conditions:
it is continuously differentiable;
it is strictly positive.
The first condition is useful to prove some results about the CTMC, whereas the second one follows because we assume that the reactants decrease their concentra- tion and products increase it. All the most well-known kinetic laws satisfy these properties.

CTMC with levels
The term CTMC with levels indicates a CTMC whose states capture levels of con- centration of the species and the transitions from one state to another reflect changes of these levels.
Definition 3.1 A state of a CTMC with levels is defined as a vector of levels σ = (l1, l2, ..., ln), where li, for i = 1, 2, ..., n, is the level of the species i. The transitions of a CTMC with levels represent biochemical reactions. Each transition causes a change in the number of levels of one or more species, as determined by the stoichiometry. The transition rates are as defined in Section 2.3.
For the analysis, it is necessary that the CTMCs are finite. Starting from a finite number of levels, is possible to obtain an infinite CTMC only if there are some reactions of the kind “→ A” or “C → C + A”. We call these creation reactions. We term a biochemical network without creation reactions a bounded chemical network. We then have the following result.
Proposition 3.2 Let Xh be a CTMC corresponding to a bounded biochemical net- work with granularity h. Let σ0 = (l1,0, l2,0, ..., ln,0) be the initial state. If the values li,0(i = 1, ..., n) are ﬁnite then Xh is ﬁnite and the maximum value of the level depends on σ0 and the stoichiometric coefficients of the reactions.

In particular, if all stoichiometric coefficients are equal to one and there are no reactions with more than one product, in each state σ each component li satisfies:
li ≤ (Σn	lj,0).
If we allow creation reactions, it could happen that some species do not have a maximum concentration. In this case it is necessary to assume a maximum level also for the species that grows infinitely in order to guarantee a finite CTMC. Note that this is an approximation and we have to pay attention to the results obtained from the analysis (e.g. model checking). However, in many situations, unbounded network may have a pragmatic (average) bound value because of the quantitative relations between the molecules and the reactions composing the network.
Finally, the complexity of the CTMC is expressed in terms of the number of states. This number depends on the amount of levels of the species. An upper

bound for the number of states is given by  n
i=1
(Ni + 1), where Ni is the maximum

level of the species i and n the number of species.

From Bio-PEPA to CTMC with levels and to ODEs
In this section we outline how the CTMC with levels and the system of ODEs underlying a Bio-PEPA model are derived.

From Bio-PEPA to CTMC with levels (πCT MC)
Let πCT MC be the function that derives a CTMC with levels from a Bio-PEPA system. We do not define this function formally here, but states are derived from a labelled transition system, via the operational semantics, and transition rates are as described in Section 2.3. From any Bio-PEPA system we can apply the semantic rules to generate the labelled transition system where each node is a derivative of the system. We have the following result:
Theorem 4.1 For any ﬁnite Bio-PEPA system P = ⟨V, N , K, FR,Comp,P ⟩, if we deﬁne the stochastic process Xh(t) such that Xh(t) = Pi indicates that the system behaves as derivative Pi at time t, then Xh(t) is a CTMC.
The proof is analogous to that presented for PEPA [12]. The rate associated with each activity is obtained by evaluating the functional rate in the system.
The CTMC is characterised by an infinitesimal generator matrix Q whose off- diagonal entries are the transition rates, and whose diagonal entries are the negative row sums.
Dimerization example (continued)
Consider the dimerization example again; we derive the CTMC with levels for two values of h: h =5 and h = 1, as illustrated in Figures 1 and 2. When h =5 there are two states, (2, 0) and (0, 1), and two transitions with rates:
q1,2 = k1 · A2/h =1 · (10)2/5= 20,	q2,1 = k2 · B/h =1 · 5/5= 1.

q1,2

q2,1
Fig. 1. CTMC with levels for the dimerization example (h = 5).
100	64	36	16	4

8, 1	6, 2	4, 3
1	2	3	4	5
Fig. 2. CTMC with levels for the dimerization example (h = 1).
When h is smaller (h = 1) then there is a finer granularity. There are six states and ten transitions (see Figure 2). As a further example (not illustrated), when h = 0.1 there are 51 states and 100 transitions.
From Bio-PEPA to ODEs
Let πODE be the definition of the set of ODEs from a Bio-PEPA model. A crucial part is the derivation of the stoichiometry matrix D = {dij }. The entries of the matrix are obtained as follows: for each sequential component Ci consider the prefix subterms Cij representing the contribution of the species i to the reaction j. If the term represents a reactant we write the corresponding stoichiometry κij as −κij in the entry dij. In the case of a product we write +κij. All other cases are null.
πODE entails three steps: 1) definition of the stoichiometry (n × m) matrix D, where n is the number of species and m is the number of molecules; 2) definition of the kinetic law vector (m × 1) vKL containing the kinetic laws of each reaction; 3) definition of the vector (n × 1) x, with xT = (x1, x2, ..., xn).
The ODE system thus obtained has the form:
dx
= D × vKL
dt
where the vector of initial concentrations is x0, with xi,0 = li,0 · h, i = 1, ..., n.
Dimerization example (continued)
We define the vector xT = (xA, xB) and the kinetic vector vKLT = (k1 · x2 , k2 · xB).
The stoichiometry matrix D associated with the system is
−2 +2
⎝ +1 −1 ⎠
The system of ODEs obtained by πODE is:
dxA = −2 · k · x  +2 · k · x
dt	1	A	2	B
dxB = +k · x  − k · x
dt	1	A	2	B

with initial conditions (xA,0, xB,0)T = (10, 0).

Comparison of CTMC with levels and ODEs
In this section we consider how to compare the two models derived from a Bio- PEPA system P and how to define the granularity h so that the difference between the two models is acceptable.
First we apply Kurtz’s Theorem [13,15] to our case. This theorem tells us that, under some conditions, the limit of a sequence of density dependent CTMCs (the CTMCs with levels), as h approaches 0, is a set of ODEs.
Second we consider the difference between the two models. We define a distance measure and discuss the factors to consider when choosing h in order to ensure that the distance between the two models is less than an acceptable error ϵ.
In the following we introduce the notation used, then we show that the CTMC with levels derived from a Bio-PEPA system satisfies the conditions of Kurtz’s Theorem. Finally, we observe that the set of ODEs extracted from the Bio-PEPA system coincides with those in the theorem.

Application of Kurtz’s Theorem
Kurtz’s Theorem applies to a sequence of density dependent Markov chains. In the original theorem the dependency is expressed in terms of the volume V , but we express the dependency in terms of the granularity h. Note that when h decreases, the number of levels in the system increases. The formal definition of the Theorem with its conditions is reported in the Appendix B.
Let Xh be the CTMC describing the model with granularity h. Given a state of the CTMC σ, we denote by hσ the vector (h · l1,h · l2, ..., h · ln), where h is the step size and li is the level of the species i. Let D be the stoichiometry matrix obtained from the Bio-PEPA system and Dj the jth column of D. This vector represents the stoichiometric coefficients for all the species in a given reaction j. In the following the kinetic law associated with the reaction j is denoted by fj(hσ, Dj), where the dependency from both the state and the stoichiometric coefficients is expressed explicitly. This notation is different from the one generally used in Bio-PEPA. Here we focus on Bio-PEPA systems representing bounded biochemical networks, also pragmatically.
In order to apply Kurtz’s Theorem, we first show that the CTMC Xh is density dependent and that all the conditions of the theorem are satisfied.
Xh is density dependent From the definition of CTMC with levels, the entry
qu,v of the infinitesimal generator matrix is (according to the notation above):


qu,v =
A(σu |σv )
fj(hσu, Dj) · h—1	if u /= v	qu,u = −	qu,v	otherwise.
u/v=



where A(σu|σv) = {α | σu
−α→ σv} and fj(hσu, Dj) is the evaluation of the

functional rate in state σu. This definition of transition rates clearly satisfies the definition of density dependent reported in the Appendix B.
Conditions of Kurtz’s theorem Let x0 be the initial concentration vector for the ODEs. The initial level vector is l0 = [x0/h|. Thus limh→0 h · l0 = x0.
Consider the system of ODEs dX(t)/dt = F (x) where F (x)=  Djfj(x, Dj) with initial condition X(0) = x0. By hypothesis, the trajectory of X(t) is bounded, so we can assume it is bounded by some open set E. Since each ki- netic law is continuously differentiable (the first condition for the kinetic laws in Section 2.3), it follows that f is Lipschitz. This the first condition of Kurtz’s The- orem. The second and third conditions of Kurtz’s Theorem state that for each transition the rate of change is bounded and that there is a bound for the whole state space so that the impact of each transition is bounded. By the assumptions made for the kinetic laws and because stoichiometric coefficients are assumed to be integer and bounded, it is clear that both these conditions are also satisfied. In particular, for the third condition, we can observe that f (x, Dj) = 0 for all
|Dj| > C with C =  i,j dij.
ODE systems Consider the ODE system πODE(P), for a given Bio-PEPA system
P. We can observe that F (x)= D × vKL, as the kinetic law vector vKL contains all the functions fj for all the reactions. The ODE system πODE(P) coincides with the one in Kurtz’s Theorem, with initial condition xi,0 = li,0 · h, for i = 1, 2, ..., n.

Distances between the two models
The result in Section 5 confirms that, in the limit, the agreement between the ODEs and the CTMC with levels derived from a Bio-PEPA system is complete. However it does not tell us about the relationship between the two models for a given finite h. In [4] the authors showed experimentally that in some pathways the two models are indistinguishable for just few levels, for example when h =1 and h = 7, but these results are not generalised. Here we investigate the relationship between the step size h of the CTMC and the agreement with ODEs. In [14,15] Kurtz reported some estimates for the probability of convergence between the two models. However the estimation is complex and offers a poor guide for choosing h. In the following we propose a measure of distance between the two models. There are various possible ways to define this measure. One possibility is to define it in terms of the difference between the ODE simulation trajectory and the expected value (numerical solution) of the CTMC, for all the species in the biological network, with respect to a time interval. This gives the following definition of distance:



fdist =
Tsim  n


t=1 i=1
2
Xh(t) · h − xi(t)

where xi is the ODE trajectory for the species i, Xh(t) is the numerical solution of the CTMC for the species i at time t, n is the number of species in the network, Tsim is the simulation time and t indicates a simulation time point.

We propose the following empirical approach to find the value of h for which we have good agreement between the models.
Let us consider a well-defined Bio-PEPA system P, the CTMC Xh = πCT MC(P) and the ODEs solution X of the model πODE(P).
Let Tsim be the simulation time (this depends on the model) and ϵ > 0 the acceptable discrepancy between the two models.
Starting from an initial granularity we calculate the distance measure for the simulation time. If the measure is greater than ϵ then change h and try again.
Clearly the choice of ϵ is crucial. Furthermore, the numerical solution of the CTMC may be unfeasible for even moderately sized models. In this case, instead of considering the expected value from the numerical solution of the CTMC, we can define the distance in terms of the average (mean) of some value over repeated CTMC simulation runs. This leads to the following distance function:



fdist,avg =
Tsim  n


t=1 i=1
2
X¯ h(t) · h − xi(t)

where X¯ h(t) is the average level for species i in the CTMC at time t over Nrun runs and the other variables are as before. In this approach the main challenge is the definition of the number of simulation runs needed for a good approximation of the expected value. Increasing the number of runs we obtain a better approximation of the expected value for the CTMC, however the calculations become more expensive. Generally we obtain indistinguishable curves for a relative small number of runs.
In both the definitions, the distance between the two models generally decreases with the step size h. However, note that for very small h the number of states becomes large and even the simulation of the CTMC may become prohibitively expensive. Thus there is a trade-off between accuracy (in terms of both number of runs and step size) and tractability. The resolution of this trade-off is left to the modeller.

Dimerization example (continued)
In Figure 3 we report some analysis results for the dimerization example. The ODE simulation is reported at the top. The other two graphs show the time evolution of the expected value of the CTMC with levels for h = 5, h = 1, h = 0.1 and h = 0.01. By comparing the ODE trajectory and the numerical solutions, we can observe that for a large step sizes (h = 5) there is a discrepancy between the two curves, both for A and B. When we decrease the step size h, the discrepancy between the two curves becomes smaller and for h = 0.1 (corresponding to 100 levels) the expected value of the CTMC (almost) coincides with the ODE. This is as predicted by Kurtz’s Theorem. If we consider the average of some simulation runs instead of the expected value, we obtain similar results for 100 runs. However, for h =5 and
h = 1 there is a large variability between the different simulation runs.


ODE time evolution
10


8


6


4


2


0
0	0.1	0.2	0.3	0.4	0.5
time



Concentration of A expected value
10

Concentration of B expected value
10



8	8


6	6


4	4


2	2



0
0	0.1	0.2	0.3	0.4	0.5
time

0
0	0.1	0.2	0.3	0.4	0.5
time



Fig. 3. Dimerization example. On the top: ODE simulation. The other two graphs represent the numerical solution for the CTMC for A (on the left) and B (on the right) for h = 5, h = 1, h = 0.1 and h = 0.01.

In the table below we report the distance fdist between the ODE and CTMC for different values of h. If we fix the admissible distance between the models as ϵ = 1.05, then we have h = 0.1.


The repressilator
The repressilator is a synthetic genetic regulatory network with oscillating behaviour [9]. It consists of three genes (denoted G1, G2, G3 ) connected in a feedback loop, such that the transcription of a gene is inhibited by one of the other proteins (de- noted P1, P2, P3 ). A schema of the network is reported in Figure 4.
The reactions are: the transcription of the three mRNAs with inhibition by one of the proteins (reactions tr1, tr2, tr3), the translation of mRNAs into the proteins (trl1, trl2, trl3), degradation of both mRNAs and proteins (di with i = 1, ..., 6).
Note that this network contains some creation reactions (transcription and trans- lation reactions) therefore it is an unbounded network according to our definition. However, it is pragmatically bounded, This is due to the regulatory effect of degra- dation and inhibition.
This network is described in Bio-PEPA as follows:


	




		

tr3	d3
trl3	d6
tr1
d1
trl1
d4


Fig. 4. Repressilator model.


mRNA1 mRNA2 mRNA3
P 1
P 2
P 3
= (d1, 1)↓mRNA1+ (tr1, 1)†mRNA1+ (trl1, 1) ⊕ mRNA1
= (d2, 1)↓mRNA2+ (tr2, 1)†mRNA2+ (trl2, 1) ⊕ mRNA2
= (d3, 1)↓mRNA3+ (tr3, 1)†mRNA3+ (trl3, 1) ⊕ mRNA3
= (d4, 1)↓P 1+ (trl1, 1)†P 1+ (tr3, 1) g P 1
= (d5, 1)↓P 2+ (trl2, 1)†P 2+ (tr1, 1) g P 2
= (d6, 1)↓P 3+ (trl3, 1)†P 3+ (tr2, 1) g P 3


while the model is defined as:
((((mRNA1(0) D  mRNA2(2)) D  mRNA3(0))	D 

∅	∅	{trl1,tr3}
P1 (1 ))	D 
{trl2,tr1}
P2 (0 ))	D 
{trl3,tr2}
P3 (3 )

The parameters and the initial concentrations are defined as in [9] i.e. the initial levels are defined according to the initial values of the model. There are no com- partments defined explicitly in the model. So we consider the default compartment vCell : 1. The step size, the number of levels, the initial concentration and location of species are declared as:

mRNA1: h = 5,N = 2, M0 = 0, , vCell;	mRNA2: h = 5,N = 2, M0 = 0, , vCell;
mRNA3: h = 5,N = 2, M0 = 0, , vCell;	P 1: h = 5,N = 50, M0 = 5, , vCell;
P 2: h = 5,N = 50, M0 = 0, , vCell;	P 3: h = 5,N = 50, M0 = 15, , vCell;
For all the species we consider the step size h = 5. The numbers of levels are derived in terms of the concentration in the biological model. The set of functional rates is:

α
ftr1 = 1+ P 32 + α0;	ftr2  =
α
1+ P 12 + α0;	ftr3 =
α
1+ P 22 + α0;

ftrl1 = fMA(β);	ftrl2 = fMA(β);	ftrl3 = fMA(β);

fdi = fMA(1) i = 1, 2, 3, 4, 5, 6.



350

300

250

200

150

100

50

0

ODE evolution

0	5	10	15	20
time


350

300

250

200

150

100

50

0

100 simulations with h=5

0	5	10	15	20
time





350

100 simulations with h=0.1


350

100 simulations with h=0.01


300	300

250	250

200	200

150	150

100	100

50	50


0
0	5	10	15	20
time

0
0	5	10	15	20
time


Fig. 5. Some analysis results for the Repressilator.


fMA(r) denotes mass-action with rate constant r. All three repressors have same behaviour except for their DNA-binding specificities. We assume that all the degra- dation reactions have rate 1. The other parameters are: α = 250, α0 = 0, and β = 5. From the Bio-PEPA system we can derive the CTMC and the ODE model as usual (reported in the Appendix C). For each temporal point we show the mean and the standard deviation of the 100 runs. In Figure 5 we report some analysis results. The ODE simulation is reported at the top, left. The other graphs show the time evolution of the average of 100 simulation runs for the CTMCs with h = 5, h = 0.1 and h = 0.01. For the Repressilator the numerical calculation of the expected value
of the CTMC is too expensive.
For relatively large h, there is a great variability among the different simulation runs and the mean value is very different from the ODE results. For smaller h this variability decreases and the mean value approaches the ODE trajectory.
In the Table below we report the distances between ODE and CTMC for different values of h. We consider the definition of distance in terms of the mean value. Note that these distances are not normalised and the sum is over all the six species of the system. By observing these values we can see that the distance between the two models decreases with smaller step sizes.


Discussion and conclusions
There are three main contributions of this work. Firstly, we gave a formal definition of the CTMC derived from a Bio-PEPA system. We called it the CTMC with levels, as its states are characterised in terms of the concentration levels for each of the species of the system. Secondly, we investigated the relationship, at the limit, between the ODE model and the CTMC obtained from the same Bio-PEPA system using Kurtz’s Theorem. Thirdly, we proposed a distance measure between the CTMC and ODE models and this has been used for finding a “good” granularity for the system. We tested our approach against a simple example describing a dimerization reaction and the Repressilator network.
Based on our results, in the case of a low number of levels (i.e. coarse granu- larity), the behaviour shown by the expected value of the CTMC might or might not agree from the ODE time evolution. We use a smaller h in order to decrease the variability of the CTMC model, and as predicted by Kurtz’s Theorem, obtain a global behaviour that is closer to that given by the deterministic approach. This can allow more flexibility to the modeller. For instance, in the presence of experimental observations that suggest a certain degree of uncertainty, we can choose the model that better agrees with those observations.
We proposed a distance measure between the CTMC and ODE models and this has been used for finding a “good” granularity for the system. The definition of distance is based on the numerical solution of CTMC. As observed in the paper, the derivation of the numerical solution is often impractical. In order to overcome this drawback we proposed an alternative definition of distance based on the average of a number of simulation runs. The selection of the appropriate number of runs remains an open problem. A deeper investigation of this point and the study of other definitions of distance between models is planned.
Finally, other future investigations concern the validation of the system against experimental data and existing knowledge.

References
Bortolussi, L. and A. Policriti. Modeling Biological Systems in Stochastic Concurrent Constraint Programming. Constraints, volume 13, Issue 1-2, pages 66–90, 2008.
Calder, M., S. Gilmore, and J. Hillston. Modelling the influence of RKIP on the ERK signalling pathway using the stochastic process algebra PEPA. In the Proc. of BioConcur’04, London, Sept. 2004.
Calder, M., S. Gilmore, and J. Hillston. Modelling the influence of RKIP on the ERK signalling pathway using the stochastic process algebra PEPA. T. Comp. Sys. Biology, VII, volume 4230 of LNCS, pages 1–23, Springer, 2006.
Calder, M., V. Vyshemirsky, D. Gilbert and R. Orton. Analysis of Signalling Pathways using Continuous Time Markov Chains. T. Comp. Sys. Biology, VI, volume 4220 of LNCS, pages 44–67, Springer, 2006.
Ciocchetta, F. and J. Hillston. Bio-PEPA: an extension of the process algebra PEPA for biochemical networks. Proc. of FBTC 2007, Electronic Notes in Computer Science, volume 194, number 3, pages 103–117, 2008.
Ciocchetta, F. and J. Hillston. Bio-PEPA: a framework for the modelling and analysis of biological systems. Technical Report of the School of Informatics, University of Edinburgh, EDI-INF-RR-1231, 2008.


Ciocchetta, F., S. Gilmore, M. L. Guerriero and J. Hillston. Integrated Simulation and Model-Checking for the Analysis of Biochemical Systems. Proc. of PASM 2008, to appear in ENTCS.
Danos, V. and J. Krivine. Formal molecular biology done in CCS-R. Proc. of Workshop on Concurrent Models in Molecular Biology (BioConcur’03), 2003.
Elowitz, M.B. and S. Leibler. A synthetic oscillatory network of transcriptional regulators. Nature, volume 403, number 6767, pages 335–338, 2000.
Geisweiller, N., J. Hillston and M. Stenico. Relating continuous and discrete PEPA models of signalling pathways. Theoretical Computer Science, volume 404, number 1-2, pages 97–111, 2008
Gillespie, D.T.. Exact stochastic simulation of coupled chemical reactions. Journal of Physical Chemistry, volume 81, pages 2340–2361, 1977.
Hillston, J.. A Compositional Approach to Performance Modelling, Cambridge University Press, 1996.
Kurtz, T.G.. Limit Theorems for Sequences of Jump Markov Processes Approximating Ordinary Differential Processes. Journal of Applied Probability, volume 8, number 2, pages 344–356, 1971.
Kurtz, T.G.. The Relationships between Stochastic and Deterministic Models for Chemical Reactions.
The Journal of Chemical Physics, volume 57, number 7, pages 2976–2978, 1971.
Kurtz, T.G.. Solutions of Ordinary Differential Equations as Limit of Pure Jump Markov Processes.
Journal of Applied Probability, volume 7, number 1, pages 49–58, 1971.
Prism web site. http://www.prismmodelchecker.org/
Priami, C. and P. Quaglia. Beta-binders for biological interactions. Proc. of CMSB’04, 2004.
Priami, C., A. Regev, W. Silverman and E. Shapiro, Application of a stochastic name-passing calculus to representation and simulation of molecular processes, Information Processing Letters, 80 (2001), 25–31.

Auxiliary definitions for Bio-PEPA
In the following we report some auxiliary definitions. For more details see [5,6].
Definition A.1 The set of current action types enabled in the model component P, denoted A(P ), is defined as:
A((α, κ) op S)= {α}	A(S1 + S2)= A(S1) ∪ A(S2)
A(S(l)) = A(S)	A(C)= A(S) where C = S
A(P1 D  P2)= A(P1)\L ∪ A(P2)\L ∪ (A(P1) ∩ A(P2) ∩ L)
If P is a Bio-PEPA system with model component P , the set of current action types enabled in P is A(P)= A(P ).
The behaviour of the system is defined in terms of an operational semantics. We define two relations over the processes. The former, called the capability relation (indicated with −→c), supports the derivation of quantitative information and it is auxiliary to the latter which is called the stochastic relation (indicated with −→s). The stochastic relation gives us the rates associated with each action.
The formal definition of these relations in terms of structured operational rules is presented in Table A.1.
The following definitions concern the derivative of a component, the derivative set and the derivative graph. We refer to the relation −→s. The case of −→c is analogous.




(α,[S:↓(l,κ)])
prefixReac	((α, κ)↓S)(l) —————————→c S(l — κ) κ ≤ l ≤ N

(α,[S:↑(l,κ)])
prefixProd	((α, κ)↑S)(l) —————————→c S(l + κ) 0 ≤ l ≤ (N — κ)

(α,[S:op(l,κ)])
prefixMod	((α, κ) op S)(l) ——————————→c S(l)	with op = ⊙, ⊕, g and
< l ≤ N if op = ⊕,  0 ≤ l ≤ N otherwise


(α,w)
S (l)
(α,w)	'  '

1	————→c S1 (l )	S2(l) ————→c S2(l )
choice1			choice2		

(α,w)
(S + S )(l)
(α,w)	'  '

1	2	————→c S1(l )	(S1 + S2)(l) ————→c S2(l )
(α,S:[op(l,κ)])
S(l)

——————————→c S (l )
constant		
with C d=ef S

(α,C:[op(l,κ)])
C(l)
——————————→c S (l )
(α,w)
P
1 ————→c P1
coop1		 with α ∈/ L 

P D  P
(α,w)
P ' D P

L	2 ————→c 1 L	2
(α,w)
P
2 ————→c P2
coop2		 with α ∈/ L 

P D  P
(α,w)
P D  P '

L	2 ————→c 1 L	2

(α,w1 )
P
(α,w2 )	'

1 —————→c P1 P2 —————→c P2
coop3		 with α ∈L 

P D  P
(α,w1 ::w2 )
P ' D P '

1 L	2 ————————→c 1 L	2
(αj,w)
P —————→cP
Final		

⟨V , N , K, F ,Comp, P
(αj ,rα)
⟩—————→s ⟨V
, N , K, F ,Comp, P '⟩

Table A.1
Axioms and rules for Bio-PEPA.

Definition A.2 If
(α,r)
P−−−→sP
' then P' is a one-step −→s
system derivative of P.

(α1,r1)
If
(α2,r2)
(αn,rn)	'	'

P−−−−→sP1−−−−→s	−−−−→sP
then P
is a system derivative of P.

Definition A.3 The system derivative set ds(P) is the smallest set such that:
P ∈ ds(P);

if P' ∈ ds(P) and there exists α ∈ A(P') such that
(α,r)
P −−−→sP
''	''
then	ds( ).

Definition A.4 The system derivative graph D(P) is the labelled directed multi- graph whose set of nodes is ds(P) and whose multi-set of arcs are elements in ds(P) × ds(P) × Γ, with Γ the set of labels for −→s.
In the following definition we identify the actions describing the transitions from one state to another.
Definition A.5 Let P be a Bio-PEPA system and let P be the associated model component. Let Pu, Pv be two derivatives of a model component P with Pv a one- step derivative of Pu. The set of action types associated with the transitions from

the process Pu to the process Pv is denoted A(Pu|Pv).

Kurtz’s theorem
In the following we report the main theorem described in [13]. First of all we give the definition of Density Dependent Markov Chain, as here we limit our attention to this kind of CTMCs.
Definition B.1 A family of CTMCs XV , for some parameter V , is called density dependent if and only if there exists a continuous function f (x, s), x ∈ Rn, s ∈ Zn, such that the entries of the infinitesimal generators are given by:
qk,k' = f (σV	, s) · V	s /=0 
with σ the state vector and s a transition vector containing the modifications to element of each state (i.e. the number of copies to add or substract) when the transition is taken.
Theorem B.2 Let XV be a family of density dependent CTMCs with the inﬁnites- imal generator matrix as in the deﬁnition above. Assume X(t) is the solution of the ODE system dX/dt = F (X), where F (X)=  s sf (x, s) and let X(0) = x0.
If there exists an open set E ⊂ Rn such that X(t) ∈ E and
∃M, ∀x, y ∈ E	| F (x) − F (y) |< M | x − y |;
sup	| s | f (x, s) < ∞;
limd→∞ supx∈E	|s|>d | s | f (x, s)= 0
then


lim
V →∞
V —1XV (0) = x0 =⇒ ∀δ > 0, ∀t > 0	lim
V →∞
P(sup | V —1XV (z)−X(z) |> δ)=0 
z<t

The theorem states that, under the given conditions, the system of ODEs can be defined as the limit of a sequence of density dependent CTMCs. As the theorem phrased above the states represent numbers of individuals and are normalised with respect to a parameter V (in this case, the volume). Therefore V —1XV (z) represents the scaled Markov process with concentrations. In our case the scaling factor is in terms of h instead of V .

ODEs and CTMC for the Bio-PEPA Repressilator
From the Bio-PEPA system in Section 6 we can derive both the CTMC and the ODE system corresponding to the Repressilator. In the former case we obtain a CTMC with 23·503 states (not reported), where 50 is the number of levels considered for the proteins and 2 is the number of of levels for the mRNAs.
Concerning the derivation of the ODE system, the first step is the derivation of

the stoichiometry matrix D. For this model we have:




Each row describes the stoichiometry for a given species in each reaction. The last column reports the name of the variables associated with the species in the network (mi stands for mRNAi and pi for P i, i = 1, 2, 3). The kinetic vector vKL is:


α
1+xp3
+ α ,	α
1+xp1
+ α − 0,	α2
1+xp2
+ α0,β · xm1,β · xm2,β · xm3,
 T





The ODE system is:
dxm1		α	
=+	+ α


— 1 · x

dxm2 = +	α


+ α − 1 · x

dt	1+ x2	0
m1	dt


1+ x2	0	m2

dxm3		α	
=+	+ α0
dt	1+ x2
— 1 · x
dxp1
m3	dt
= +β · x
m1 − 1 · xp1

dxp2 = +β · x
— 1 · x
dxp3
= +β · x
— 1 · x

dt	m2	p2	dt
m3	p3

with the initial conditions (xm1, xm2, xm3, xp1, xp2, xp3)T = (0, 0, 0, 5, 0, 15).
