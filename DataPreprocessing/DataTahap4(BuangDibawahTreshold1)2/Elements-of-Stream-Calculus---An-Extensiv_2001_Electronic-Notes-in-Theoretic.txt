not usually present in analysis. Later we shall see variations on both the notion of stream derivative and the operator of multiplication, which have more familiar properties. Let it be noted, however, that in stream calculus, both the operations of stream derivative and of convolution product, with their non-standard properties, are of central importance.

and coinduction does the rest. Identity (15) clearly follows from (14) and the commutativity of convolution product (9). A direct coinductive proof not using the latter is also possible and is interesting in itself, since it will also apply to the inverse operator in the multivariate case in Section 15, where product will no longer be commutative. So we let

The stream (0!, 1!, 2!,.. .) is the prototypical example of a divergent stream, in the sense that if one were to define a function f (x) = 0! + 1!x + 2!x +  , it would satisfy f (0) = 0, and would be undefined everywhere else. Therefore, the above recurrence cannot be solved with the use of generating functions (as in [30]), which is the traditional approach in mathematics. The problem can be solved with the help of formal power series, but computing the solution of the present example leads to fairly complicated calculations, involving so-called hypergeometric series (cf. [11, pp.346-348]).

Let us emphasize, however, that for the stream calculus we are developing, it is of crucial importance to have both structures present at the same time. Notably the interplay between the various operators from both worlds, turns out to constitute the most interesting part of the calculus. The following iden- tities clearly illustrate this point, since they involve both the shuffle product and the (convolution) inverse. They all have in common that they provide a

The output function o assigns to each state q in Q a real number o(q) in R. The transition function t assigns to a state q in Q a function t(q) : Q  f R, which specifies for any state q' in Q a real number t(q)(q') in R. This number can be thought of as the weight (cost, multiplicity, duration, etc.) with which the transition from q to q' occurs. The following notation will be used:

A multivariate R-weighted stream automaton, or multivariate weighted au- tomaton for short, is a pair Q = (Q, o, t ) consisting of a set Q of states, together with an output function o : Q   R, and a transition function t : Q   (Q  f R)A, where, as before, (Q  f R) contains only functions of finite support. The output function o assigns to each state q in Q a real number o(q) in R. The transition function t assigns to a state q in Q a function t(q) : (Q  f R)A, which specifies for any variable X  A and state q' in Q a real number t(q)(X)(q') in R. As before, this number can be thought of as the weight (cost, multiplicity, duration, etc.) with which the (X-)transition from q to q' occurs. The following notation will be used:

The definition of bisimulation-up-to is a variation on a similar notion by Milner [20] (see also [27]). In [3], variations and coalgebraic generalisations of coinductive proof methods are given. The present notion of bisimulation- up-to (identity and sum), can be easily generalised along the lines of [3], to a version which would allow derivatives to be bisimilar up to arbitrary contexts (including product, inverse, and the other operators). The proofs of for instance identities (15) and (26) could be simplified if we would have used bisimulation-up-to product.

The present paper extends [25], repeating part of its basic definitions and results on streams. A number of new operators have been added, as well as many new identities (including those on exponentiation and shuffle elimina- tion). Moreover, all of the applications are new.

-the way such automata are constructed by means of splitting derivatives (as in the proof of Theorem 13.3); -and our use of infinite weighted automata (as in the example of (tan)). Part of all this can already be found in [25]. New with respect to the latter is the use of continued fractions, and the application in Section 17 to coinductive counting. Theorem 17.1 is a (slightly more general) variation on a classical result by Flajolet [10, Theorem 1], phrased here in terms of weighted automata and with a somewhat simpler coinductive proof. Weighted automata seem to offer an interesting alternative to the structures

Another approach to counting is the categorical theory of species [4]. It offers a framework that is far more general than the present calculus of streams, but there are many connections. It would be worthwhile, more generally speaking, to investigate the possible role of coinduction in the world of species in some detail.

I am much indebted to Alexandru Baltag, Falk Bartels, and Alexander Kurz for numerous stimulating discussions, suggestions, and corrections. Special thanks are due to Falk Bartels for detailed comments on a draft of this paper. I am also grateful to the following persons for various types of comments, suggestions, and pointers to the literature: Jan Komenda, Gilbert Labelle, Doug McIlroy, Dusko Pavlovic, Andy Pitts, Jan van Schuppen, Nico Temme, and the members of the ACG Colloquium, headed by Jaco de Bakker.

