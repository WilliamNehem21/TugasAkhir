aspect-oriented programming(aop) provides new programming languages constructs for improving the separation of concerns with the goal of enhancing design modularity. aspects are new units of modularisation for encapsulating crosscutting concerns, i.e., system features or properties that naturally affect many system modules. aop is therefore expected to be an effective technique to enhance software maintainability through the modularisation of crosscutting concerns. however, there is a need for a systematic migration of existing object-oriented(oo) systems towards the aspect-oriented decompositions in order to reap the benefits of aop.



the recognition that concern identification and refactoring are important issues through the software maintenance activities is not new. actually, with the emergence of aop, there is a growing body of relevant work in the software engineering literature focusing on concern analysis techniques and refactoring of crosscutting concerns. however, there is a lack of work integrating those techniques to enhance refactoring of crosscutting concerns based on concern analyses. in addition, only initial works have classified common crosscutting structures using metaphors and explored how taming these structures help in software maintenance activities, such as refactoring.



in this context, the main contributions of this paper are threefold. first, an initial set of metaphors is defined in order to characterise concerns regarding their crosscutting structures. heuristics are used to identify occurrences of two concern metaphors, namely octopus and black sheep. second, taking advantages from the crosscutting structure defined by concern metaphors, refactorings are presented to modularise octopus and black sheep crosscutting concerns. third, an empirical study involving concerns of 23 design patterns is used to evaluate(i) the accuracy of our heuristic classification and(ii) the applicability of the metaphor-based refactorings. based on our experience, we also determine a catolog of additional categories and heuristics for refactoring crosscutting concerns.



this section presents a review of existing object-oriented(oo) refactorings that have been extended to become aspect-aware(section 2.1). it also discusses refactorings tailored for supporting the extraction and modularisation of crosscutting concerns(section 2.2). section 2.3 summarises the shortcomings of existing refactoring approaches for aspect-oriented(ao) systems and section 2.4 demonstrates some of those shortcomings in an illustrative example.



some authors have recently identified limitations when applying wellknown oo refactorings in the presence of aspects. for example, one problem arises from the fact that oo refactoring usually changes the structure of join points of the program and, thus, potentially changes how the aspects affect classes. to address this problem, hanenberg, oberschulte, and unland proposed preconditions which have to be respected when applying a conventional refactoring in the presence of aspects. they use extract class in order to exemplify the preconditions which make the refactoring aspect-aware. in addition, they propose some new refactorings to extract concerns from an existing design to aspects.



the previously discussed refactoring approaches in their own nature look individually at each code fragment and do not consider the crosscutting sturcture of the target concern. therefore, hannemann and his colleagues proposed the notion of role-based refactoring to describe transformations based on an abstract model of the target crosscutting concern. the underlying idea is that refactoring instructions are the same for all concrete program elements playing a given role in the concern realisation. the strategy for role-based refactorings is composed of three main stages. first, the developer chooses an appropriate refactoring. then, it is necessary to map the roles defined by the chosen refactoring to elements of the design realising those roles. finally, a tool opens dialogue boxes in order to confirm the user choices and automatically performs the refactoring steps.



inconsistent terminology of the concern structure. role-based refactoring and refactoring based on concern type try to address the previous problem by assigning abstract names to a set of similar crosscutting concerns. nonetheless, they fail due to the lack of a unified terminology of concerns. for example, in role-based refactoring, names for roles are intended to be abstract and not tied to any specific concern implementation. however, apart from design patterns, hannemann uses application-specific names, such as currencycontrol, when presenting the role-based refactorings. furthermore, although marin et al. compiled an initial list of concern classifications, their concern types are usually tied to implementation-specific constructs of programming languages. for example, the declare throws clause and exception propagation refactorings are related to exception handling mechanisms.



lack of support to detect concern-related bad smells. recent empirical studies have highlighted that crosscutting concerns are key factors to the observance of bad smells in the system design. a bad smell is any symptom that indicates something may be wrong and it generally indicates that the overall design should be refactored. metrics-based analyses are traditionally the fundamental mechanisms for assessing design modularity and detecting design flaws. in fact, a number of papers have associated bad smells with modularity metrics, such as coupling, cohesion, and conciseness. for example, marinescu proposed a mechanism called design heuristic rule(or detection strategy) for formulating metrics-based rules that capture bad smells. however, to the best of our knowledge, there is no work which integrates those three prominent techniques: metrics-based analysis for assessing design modularity; heuristic rules for detection of concernrelated bad smells; and ao refactorings driven by holistic-detected anomalies.



heuristic classification. the target concern is classified according to its structural pattern by the use of metrics-based heuristic rules(section 3.2). a terminology of concerns, based on metaphors, is used to provide an unified and intuitive vocabulary of crosscutting concerns. we believe that this vocabulary allows developers to use meaningful terms when referring to a concern.



selection of refactoring steps. a set of fine-grain ao refactorings, such as those ones discussed in sections 2.1 and 2.2, are selected to modularise the specific concern structure identified in step 1. in some cases, it might be possible to select one refactoring from two or more alternatives. this flexibility allows developers to choose the best transformations in that application-specific context.



code transformation. the code transformations which implement the refactoring can be automated by appropriate tools. since each heuristicbased refactoring of crosscutting concern is also composed of smaller aspect-aware refactorings, existing tools for the latter can be also used to support the former.



recent research work has classified concerns in different ways. generally, if a concern is not well-encapsulated it assumes a crosscutting structure over the system. this crosscutting structure might have different shapes depending on each concern. in our approach we use concern metaphors as instances of concern-related bad smells, i.e., concerns with a particular harmful crosscutting structure for the system modularity.



this section focuses on an initial classification proposed by ducasse, girba and kuhn which is based on how a given concern is distributed over the system. these authors identified two metaphors, namely black sheep and octopus, representing patterns of concern manifestation over a system. we extend this classification in section 5 with new concern metaphors. black sheep is described as a specialised category of crosscutting concerns that touch only few points of the system. on the other hand, octopus is a crosscutting concern which is partially well modularised by one or more classes, but it is also spread across a number of other classes.



the goal of this refactoring is to better modularise concerns classified as octopus by our metaphor-based heuristics(section 3.2). the following refactoring steps aim at moving to aspects parts of code composing the body or touched by tentacles of an octopus. the body and tentacles are the main characteristics of this kind of crosscutting concerns.



refactoring steps to the octopus body. the following steps target at separating the octopus body structure. there are two possibilities of classes composing the body:(a) those entirely dedicated to the octopus concern, and(b) those mainly dedicated to this concern, but they mixed it with other concerns.



the goal of this refactoring is to better encapsulate concerns classified as black sheep by our heuristics. first, it identifies classes implementing parts of the black sheep concern and, then, it modularises those parts into aspects. using metaphors, each class is called sheep(or black sheep) and the whole system is a herd. alternatively, each part of the class realising the target concern is called a sheep slice.



refactoring steps to separate black sheep. the following six steps(labelled 2.a to 2.f) aim to separate sheep slices into aspects. some of those steps might not be applied to specific instances of black sheep. furthermore, those steps assume an pre-existing aspect(empty or not) assigned to this concern. in case this aspect does not exist, a preliminary step is its creation.



our evaluation is divided in two parts according to our goals. the first part(section 4.1) aims to evaluate the metaphor-based heuristics by applying them to a set of concerns and analysing the results. in the second part(section 4.2), we applied the proposed refactorings to the subset of concerns classified as octopus or black sheep in the first part. our case study involves concerns of relevance to the 23 gang-of-four(gof) design patterns.



the crosscutting structure of the gof design patterns has already been detected and explored in previous studies. these studies enable us to compare our heuristic classification to their findings. our comparison focuses mainly on the h&k study and on our previous experience on design patterns assessment.



garcia et al. confirmed these findings for all eight aforementioned patterns, except for the template method pattern. regarding template method, garcial et al. refuted h&k claims and verified that the aspectj solution brings no improvement in relation to the oo one. to support this observation, garcial et al. performed a quantitative study using a plethora of modularity metrics.



this comparison between our heuristic classification and previous knowledge also allowed us to find at least one false positive of our technique. in other words, we confirmed that template method should not be classified as octopus since the oo solution cannot be improved by the use of aspects. despite this false positive, we believe all other classifications are correct. if so, our metaphor-based heuristics would present an accuracy of about 85%. of course, further empirical investigation is needed to confirm or refute this percentage.



the results of the first part of our evaluation(section 4.1) brings to us a set of concerns classified as octopus or black sheep. this set is used as input to the application of the proposed refactorings(sections 3.3 and 3.4). in this second part of our evaluation we applied the proposed refactorings to those design patterns classified as octopus and black sheep.



in this part, we decided to take two sets of design pattern instances in order to assess the scalability of refactorings. the first set contains the original versions from h&k and the second one includes extended pattern instances used in a more complex empirical study. the difference between them is that garcia et al.



although different numbers of refactorings were used, the refactored version of each design pattern instance was successfully obtained by following the refactorings steps and by selecting the appropriate fine-grained refactorings. the template method pattern was the only exception as described in section 4.1. although the template method structure matches the octopus structure, we decided to not aspectise it due to our previous knowledge that the oo solution cannot be improved with the use of aspects.



in this section we aim to provide some discussions about our study relating to the liabilites of previous refactoring approaches. a briefly explanation is given regarding additional metaphors besides those ones explored in section 3. we also present the study constraints and the ongoing work at the end of this section.



in section 2.3 we pointed out three liabilities found in previous refactoring approaches: inconsistent terminology of the concern structure, the lack of support to detect concern-related bad smells, and lack of holistic treatment of scattered changes. the metaphor-based refactoring approach helps to address these shortcomings in a number of ways.



tent and unified terminology to classify crosscutting concerns manifested as design flaws. hence, it addresses this problem in existing refactorings of crosscutting concerns. for example, the role-based approach uses application-specific names, such as currencycontrol, while the refactoring based on concern types is usually tied to implementation-specific constructs of programming languages. on the other hand, our metaphor-based refactorings are based on a terminology that is abstract enough to be applied in different application domains, technologies and programming languages.



second, we claim that our approach of concern classification based on metaphors is an efficient way to express concern-related bad smells. as far as we are concerned, existing refactoring approaches which deals with crosscutting concerns modularisation do not use metrics-based analysis for design modularity assessment. although a number of papers have associated bad smells with modularity metrics and heuristics, existing refactorings do not explore heuristic rules for detection of concern-related bad smells. on the contrary, our refactoring technique copes with this limitation by applying concern-oriented metrics and, then, using the collected data as input to design heuristic rules.



a climbing plant is a concern which affects the root of an inheritance tree and, then, propagates its structure to all children of this root. the concern can be totally or partially propagated to the root descendents. however, all descendents of the concern root are somehow affected. as climbing plant, a hereditary disease concern affects the root of an inheritance tree and, then, propagates its crosscutting structure to some root descendents. however, a hereditary disease does not manifest in all nodes of a tree, i.e., some nodes are disease-free. copy cat is a concern with replicated code in many places. a special type of copy cat occurs when the



aspect-oriented refactorings have been proposed to deal with the modularisation of crosscutting concerns. we recommend the use of those low-level refactorings after the proposed octopus and black sheep aspectisation in order to modify the internal structure of aspects and prepared them for reuse. we should highlight that the aspectised versions of concerns following our technique are not expected to directly be considered as optimal solutions. the proposed refactorings(sections 3.3 and 3.4) are aimed to be generic and applied into any octopus or black sheep concern. thus, they are not specific enough to obtain the best ao solutions of those design patterns. although we have not evaluated whether the refactored concerns represent optional solutions, the patterns in our evaluation(section 4) had their respective crosscutting structure eliminated by the aspectisation which is our main goal.



we are planning as future work to develop a refactoring tool that supports our approach. this tool would help the developer to follow the workflow presented on section 3.1. basically, it encompasses the identification of design flaws through the metaphor-driven heuristics and the application of the metaphor-based refactorings for each detected concern metaphor. automation of the refactoring application involves three steps: selection of refactoring steps, human calibration as input parameter, and code transformation.



this paper proposes aspect-oriented refactorings to better modularise crosscutting concerns classified by metaphor-based heuristic rules. our refactoring technique complements previous research work, such as role-based refactoring and refactoring of crosscutting concerns types, which has similar goals. in fact, all these approaches target at aspectising crosscutting concerns by using a higher level representation of concerns. however, we explicitly provide a set of heuristics(section 3.3) to classify concerns before refactoring them. in addition, the concern metaphors used in this paper are more abstract and intuitive than previous categories, such as roles and crosscutting concern types.



in our evaluation, we used the gof design patterns and organised them according to our heuristic-based concern classification(section 4.1). the heuristic classification presented an accuracy of about 85% in our preliminary evaluation(section 4.1). in addition, we applied our refactoring technique to design patterns which match the octopus and black sheep metaphors(section 4.2). although the refactorings presented in this paper derive from studies of design patterns, they aim to be general-purpose, rather than case specific or pattern specific. finally, we proposed five additional metaphors(section 5.2) to describe recurring structures of crosscutting concerns.



