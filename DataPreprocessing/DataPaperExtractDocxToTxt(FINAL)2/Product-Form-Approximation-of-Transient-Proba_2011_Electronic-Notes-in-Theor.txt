Available online at www.sciencedirect.com



Electronic Notes in Theoretical Computer Science 277 (2011) 3–14
www.elsevier.com/locate/entcs

Product Form Approximation of Transient Probabilities in Stochastic Reaction Networks
Alessio Angius and Andr´as Horva´th
Department of Computer Science, University of Torino, Torino, Italy angius@di.unito.it, horvath@di.unito.it

Abstract
Most Markov chains that describe networks of stochastic reactions have a huge state space. This makes exact analysis infeasible and hence the only viable approach, apart from simulation, is approximation. In this paper we derive a product form approximation for the transient probabilities of such Markov chains. The approximation can be interpreted as a set of interacting time inhomogeneous Markov chains with one chain for every reactant of the system. Consequently, the computational complexity grows only linearly in the number of reactants and the approximation can be carried out for Markov chains with huge state spaces. Several numerical examples are presented to illustrate the approach.
Keywords: stochastic reaction network; Markov chain; transient analysis; product form approximation.

Introduction
In [9,10], Gillespie provided a stochastic description of the evolution of a general chemical reaction system. This description corresponds to a simple stochastic pro- cess, namely, a continuous time Markov chain (CTMC). Consequently, in principle, we have the possibility of analysing such systems by constructing the infinitesi- mal generator matrix of the CTMC and computing its exponential. Computing the exponential of a matrix is not straightforward in general [17] but for matrices representing Markov chains efficient and numerically stable techniques have been developed [12,19]. Even these technique can fail however if the number of states of the Markov chain is very large or infinite, which is often the case when reaction systems are considered.
Several approximation techniques have been proposed to overcome the problem of the huge state space. The mean-field approach, based on the relation of the tra- jectories followed by the CTMC and the differential equation-based description of the system [13,14], provides a deterministic approximation of the system behaviour. The approximation provided by the mean-field approach can be seen as the approx- imate average behaviour of the model. The idea can be extended to higher order

1571-0661 © 2011 Elsevier B.V. Open access under CC BY-NC-ND license.
doi:10.1016/j.entcs.2011.09.031

and joint moments of the population levels leading to more precise approximations [8].
Other techniques obtain approximations by operating directly on the state space of the model. As the state space can be infinite it is natural to bound the set of states that are considered [7]. Moreover, as the system evolves, it can be necessary to apply dynamic bounding in order to take into account at any transient time the most probable region of the state space. As the calculations can be slow even on the reduced state space, recently, faster approximate uniformisation methods have been proposed [16,23]. A further possibility to deal with the huge state space consists in aggregation. One natural option is to aggregate nearby states [22,5] while a somewhat more intricate aggregation can be obtained by applying flow equivalence [4,6].
Another approach to the analysis of large (or infinite) Markov chains represent- ing reaction networks is simulation. Because of the huge state space and the fact that a large amount of reactions can occur in a short time interval, even simulation is not straightforward. Starting from [9], several papers have proposed approaches to increase the efficiency of simulation of reaction systems. The most used among these approaches are explicit [11] and implicit [18] tau-leaping, which uses an approxima- tion to “leap over“ many reactions in a single step, and the slow-scale stochastic simulation algorithm [3], which aims at facing stiffness of the dynamics of the model by distinguishing fast and slow reactions.
In this paper we present a novel approximation technique. We leave the state space of the model unchanged (i.e., we do not perform reductions and aggregations) but we simplify the analysis by making assumptions on the transient probabilities of the model. In particular, we assume that the transient probabilities are of product form. This assumption allows us to have a compact description of the transient probabilities and hence to analyse systems whose state space would otherwise be of prohibitive size.
The result most related to our technique is the one presented in [2] where the authors provide a necessary and sufficient condition for a network of Markovian queues to have transient product form. The condition is that the network is com- posed of infinite server queues. Clearly, not all reaction networks correspond to a network of infinite server queues and hence the product form assumption does not hold in general. We will show however, through numerical experiments, that the closer the reaction network is to a queueing network of infinite servers, the better the approximation will be.
The paper is organised as follows. In Section 2 the considered system of reactions are described in brief. In Section 3 we introduce our approximation approach. Properties of the approximation are discussed in Section 4. Numerical examples are provided in Section 5. In Section 6 conclusions are drawn.

Model formulation
We consider a system of M reactants (called also species), R1, R2, ..., RM , interacting through N reactions:


M
anmRm −λ→n
m=1
M
bnmRm,  1 ≤ n ≤ N.	(1)
m=1

The nth reaction uses up anm units of reactant Rm and produces bnm units of it. Both anm and bnm are non-negative integer values and will be organised into vectors as an = |an1, ..., anM | and bn = |bn1, ..., bnM |. We will denote by cnm = bnm − anm the overall effect of reaction n on reactant m and the corresponding vector will be denoted by cn = |cn1, ..., cnM |. The speed of the nth reaction is given by λn. There are two classical approaches to associate a temporal behaviour with the reactions in (1).
The stochastic approach associates a continuous time Markov chain (CTMC) with the system [9]. The CTMC is discrete state, i.e., the quantity of a given reactant at any time t is given by an integer and the state of the chain is given by a vector of integers. In state X = |X1, ..., XM | reaction n is possible if Xm ≥ anm, 1 ≤ m ≤ M . We will apply the relation ≥ to vectors meaning that X ≥ an if and only if Xm ≥ anm, 1 ≤ m ≤ M . If reaction n is possible in state X then its intensity is given by



λn
m=1
Xm anm
(2)

and the corresponding transition takes the CTMC from state X to state X + cn. We will denote by p(X, t) the probability that the CTMC is in state X at time t and this quantity satisfies the following well-known Chapman-Kolmogorov ordinary differential equation (ODE)


dp(X, t)
Σ	  Xm 

= − p(X, t)
dt
λn
n:X≥an

m=1
+
anm

n:X−Σc ≥a
p(X − cn, t)λn



m =1
Xm − cnm anm
.	(3)

The second, deterministic approach describes the reactions not as discrete tran- sitions but by assuming that the reactions are modifying infinitesimal quantities of the involved species. Consequently, the quantities of the reactants are given by continuous values and ODEs describe the evolution of the system. By applying mass action kinetics [20], the ODEs are

N	M	a
Rm(t)	Σ	  Ri(t) ni

		






λ3
1, 0
λ1
λ3
2, 0
2λ1

(i − 1)λ1
λ3
i, 0
iλ1
Fig. 1. Boundaries and a generic state of the Markov chain of the Lotka-Volterra model (each state is labelled by the number of preys and predators).
where Rm(t) ∈ R≥0 is the quantity of reactant Rm at time t. Having set the initial values, Rm(0), 1 ≤ m ≤ M , the set of ODEs in (4) can be solved by numerical integration and results in a deterministic temporal behaviour.
The deterministic approach described above happens to be the mean-field ap- proximation of the CTMC of the stochastic approach. Moreover, Kurtz has shown
[14] that, as the initial population levels are increased and the reaction intensities are adjusted accordingly (giving rise to a series of so-called level-dependent Markov chains), the trajectory followed by the CTMC tends to the trajectory described by the ODEs of the deterministic approach.
Throughout the paper we will use the well-known Lotka-Volterra model to illus- trate the approach. This model, proposed independently by Lotka [15] and Volterra [21], uses three reactions to describe the evolution of two populations in competition. The three reactions are

growth of prey: R1 −λ→1
2R1,

growth of predator: R1 + R2 −λ→2
2R2,

death of predator: R2 −λ→3  ∅
and the Markov chain of the model is depicted in Figure 1. The mean-field approx- imation of the model is provided by the ODEs
R1(t) = λ R (t) − λ R (t)R (t),  R2(t) = λ R (t)R (t) − λ R (t)

dt	1  1
2  1	2
dt	2  1	2	3  2

which leads to oscillation along closed curves except if the system is started in equilibrium state.
Product form approximation
In order to derive the proposed approximation, we assume that the transient prob- abilities of the model are of product form. This means that, denoting by p(x, m, t) the probability that at time t there are x units of reactant m, the transient probabil-
ity of a state can be written as p(X, t)=  M	p(Xm, m, t). The quantity p(x, m, t)

satisfies the ODE
dp(x, m, t) = d ΣX:Xm=x p(X, t) =	Σ


dp(X, t)




(5)

dt	dt
dt
X:Xm=x

which by applying (3) and the product form assumption becomes


dp(x, m, t)
Σ	⎡	Σ	 

 Xi 

=	−
dt
X:Xm=x
λn
n:X≥an

i=1
p(Xi, i, t)
+
ani

Σ		 Xi − cni ⎤

λn
n:X—cn≥an

i=1
p(Xi − cni, i, t)
ani
⎦ .	(6)

The order of the summation in (6) can be inverted which leads to

dp(x, m, t)
= −
dt

n:xΣ≥a

x
λn
anm

 p(x, m, t)



i=1 ,i/=m

f (i, ani, t)+

Σ	 x − cnm	 

λn
n:x—cnm≥anm
anm
p(x − cnm, m, t)

i=1,i/=m
f (i, ani, t)	(7)

where the quantity f (i, j, t) is strongly related to the jth factorial moment of the quantity of the ith reactant at time t and is defined as

∞
f (i, j, t)= 
k=j

 k p(k, i, t) .	(8)

Properties of the approximation
The ODEs in (7) describing our product form approximation can be interpreted as M interacting, time inhomogeneous Markov chains in which a chain corresponding to a given reactant models the reactions in which the reactant is involved by taking into account the quantities given in (8) of the other chains. This interpretation is depicted in Figure 2 for the Lotka-Volterra model. It follows that numerical solution techniques developed for time inhomogeneous Markov chains, like the one proposed in [1], can be applied to calculate the transient probabilities.
Let us denote by rm, 1 ≤ m ≤ M the number of values of x for which the probability p(x, m, t) is not negligible. Then the number of ODEs describing the
approximation is ΣM	rm. This quantity grows linearly with the number of reac-
tants and hence the method scales well.
As mentioned in Section 2, if we consider a series of level-dependent Markov chains with increasing initial state, the transient behaviour tends to the mean-field approximation of the model [13,14]. The same holds for the approximation we pro- posed. Increasing initial population levels gives rise to a series of level-dependent,



λ1	2λ1	(i − 1)λ1	iλ1

f (2, 1, t)λ2 2f (2, 1, t)λ2 3f (2, 1, t)λ2	if (2, 1, t)λ2 (i + 1)f (2, 1, t)λ2
f (1, 1, t)λ2  2f (1, 1, t)λ2 (j − 1)f (1, 1, t)λ2 jf (1, 1, t)λ2
		
λ3	2λ3	3λ3	jλ3	(j + 1)λ3
Fig. 2. Approximating time inhomogeneous Markov chains for the Lotka-Volterra model; upper part: preys, lower part: predators.

100f (2, 2, t) 99f (2, 2, t)	98f (2, 2, t)	2f (2, 2, t) f (2, 2, t)



⎛100⎞
⎛98⎞	⎛96⎞
⎛4⎞

⎝ 2 ⎠f (1, 1, t)
⎝ 2 ⎠f (1, 1, t) ⎝ 2 ⎠f (1, 1, t)
⎝2⎠f (1, 1, t)
f (1, 1, t)

100	98	96

Fig. 3. Approximating time inhomogeneous Markov chains for the R1 + 2R2 —1→ ∅ model; upper part: R1, lower part: R2.
interacting, time inhomogeneous Markov chains and the transient behaviour for this series tends to the mean-field approximation. This means that the same rela- tion holds between the proposed product form approximation and the mean-field approximation as between the original Markov chain model and the mean-field ap- proximation.
Numerical examples
As a first example we consider an exceedingly simple model to show when the approximation fails to provide accurate results. The model is composed of the single reaction R1 + 2R2 −1→ ∅ and the starting state is (100, 100). It is obvious that the model satisfies the invariant 2(100 − R1) = 100 − R2 and hence the state space is composed of 51 states which are (100, 100), (99, 98), (98, 96),..., (50, 0). The two interactive, time inhomogeneous Markov chains representing our product form approximation is depicted in Figure 3. There are two important differences between the original model and its approximation. The approximation does not maintain the invariant of the original model. Moreover, in the original model the quantity of reactant R1 cannot decrease below 50 while it can happen in the approximating model. Consequently, the approximation works with 152 differential equations and requires more computation than the original model. This is, however, not the case in general. In case of models containing more reactants and not having very restrictive invariants, the approximation requires much less calculation than the original model. In Figure 4 we depicted the exact and the approximated mean and variance of the involved quantities as function of time. The approximation describes precisely the mean of both reactants and provides good estimate of the variance of R2 while it fails on the variance of R1. Figure 5 shows the distribution of the quantity of the reactants for a few different transient times. For distributions as well, the


100	35
90	30
80

10
0
0	0.0005	0.001	0.0015	0.002	0.0025
time
5

0
0	0.0005	0.001	0.0015	0.002	0.0025
time


Fig. 4. Mean (left) and variance (right) for the R1 + 2R2 —1→ ∅ model.


0.4
0.35
0.3
0.25
0.2
0.15
0.1
0.05
0


0	20	40	60	80	100
time
0.4
0.35
0.3
0.25
0.2
0.15
0.1
0.05
0


0	20	40	60	80	100
time


Fig. 5. The R1 + 2R2 —1→ ∅ model: distribution of R1 (left) R2 (right) for different transient times (for R2
every odd value is of zero probability; in order to have a clean figure we plotted only non-zero probabilities).


0.0014

0.0012

0.001

0.0008

0.0006

0.0004

0.0002

0


0	0.0005  0.001  0.0015  0.002  0.0025
time
0.02
0.018
0.016
0.014
0.012
0.01
0.008
0.006
0.004
0.002
0


0	0.0005  0.001  0.0015  0.002  0.0025
time


Fig. 6. The R1 + 2R2 —1→ ∅ model: relative error of the mean provided by the proposed product form approximation and of the mean-field approximation; left R1, right: R2.

approximation is good for R2 and it is bad for R1. The result is not surprising as the model is far from being product form and for R1 it introduces values which are not possible in the original model. In Figure 6 we compare the precision of the mean obtained by the product form approximation and the precision of the mean-field approach. It can be seen that the approach we proposed, even if the model is unfavourable for it, provides more precise mean values than the mean-field approximation.
As a second example we consider the preys-predators model of Lotka and Volterra. First, we start the model in state (2000, 2000) and use reaction rates λ1 = 10, λ2 = 0.01, λ3 = 10. The mean and the variance of the number of predators obtained by simulation and by the product form approximation are depicted in Fig-



3000

2500

2000

1500

1000

500

0


0	0.5	1	1.5	2	2.5	3	3.5	4
time
800000
700000
600000
500000
400000
300000
200000
100000
0


0  0.5  1  1.5  2  2.5  3  3.5  4
time


Fig. 7. The Lotka-Volterra model with λ1 = 10, λ2 = 0.01, λ3 = 10 and initial state (2000, 2000): mean value (left) and variance (right) of the number of predators by simulation and by product form approximation.



300

250

200

150

100

50

0


0	0.5	1	1.5	2	2.5	3	3.5	4
time
80000
70000
60000
50000
40000
30000
20000
10000
0


0	0.5	1	1.5	2  2.5	3	3.5	4
time


Fig. 8. The Lotka-Volterra model with λ1 = 10, λ2 = 0.1, λ3 = 10 and initial state (200, 200): mean value (left) and variance (right) of the number of predators by simulation and by product form approximation.


ure 7. Even if the population levels are high, the mean deviates away soon from the stable oscillation pattern. The product form approximation predicts instead stable oscillation of the mean and provides very similar mean to that of the mean-field ap- proach (which is not depicted in Figure 7 because it cannot be distinguished from the mean provided by the product form approach). The variance pattern provided by the product form approximation gives instead a more precise picture of what happens in the original model.
In Figure 8 we depicted the same quantities as in Figure 7 but starting the model from state (200, 200) and with rates λ1 = 10, λ2 = 0.1, λ3 = 10. The mean- field approximation of the model with these parameters is the same as with the parameters used before. However, as the number of preys and predators are lower, the model deviates from stable oscillation faster. The product form approximation is not able to capture this behaviour and provides imprecise estimate of both the mean and the variance. Figure 9 shows the probability of extinction of predators as function of time obtained by simulation and the proposed approximation. The reason that the approximation fails to give precise estimates is that the behaviour of the system depends strongly on the correlation of the population levels which is not captured by the product form probabilities.
Our third example is an extended version of the Lotka-Volterra model. We consider two types of prey and two types of predators. The set of reaction are the



0.45
0.4
0.35
0.3
0.25
0.2
0.15
0.1
0.05
0


0	0.5	1	1.5	2	2.5	3	3.5	4
time


Fig. 9. The Lotka-Volterra model with λ1 = 10, λ2 = 0.1, λ3 = 10 and initial state (200, 200): extinction of predators by simulation and by product form approximation.


600

500

400

300

200

100

0












appr. mean, R1 sim. mean, R1 appr. mean, R2 sim. mean, R2
0	0.5	1	1.5	2
time
35000

30000

25000

20000

15000

10000

5000

0


0	0.5	1	1.5	2
time


Fig. 10. The extended Lotka-Volterra model: mean (left) and variance (right) of the number of both types of preys by simulation and by product form approximation.


following:

growth of preys: R1 −1→0

2R1, R2 −1→0

2R2,

growth of predators: R1 + R3 0−.0→15 2R3, R1 + R4 −0.→03 2R4,
R2 + R3 −0.→02 2R3, R2 + R4 0−.0→25 2R4,
death of predators: R3 −1→0 ∅, R4 −1→5 ∅ .
The mean-field approach associates stable oscillation with model. This model, as there are more species and more reactions than in the original Lotka-Volterra model, maintains the oscillation for more time. In Figure 10 and 11 we show the mean and the variance of all the species involved in the system. The mean provided by the mean-field approach is not shown as it is indistinguishable from the mean provided by the product form approximation. For this model the product form approach gives good estimate of the mean and illustrate well the behaviour of the variance of the species. Note that, since there are four species involved, the original Markov chain is huge even if the states with negligible probability are not considered. The product form approach requires instead to solve a system of ODEs with about 6000 equations which took about 2 minutes on an ordinary laptop using the odeToJava package 1 .
As the last example we consider models which are close to networks of infi-

1 Available at http://www.netlib.org/ode/ and developed by M. Patterson and R. J. Spiteri.



400
350
300
250
200
150
100
50
0












appr. mean, R3 sim. mean, R3 appr. mean, R4 sim. mean, R4
0	0.5	1	1.5	2
time
35000

30000

25000

20000

15000

10000

5000

0


0	0.5	1	1.5	2
time


Fig. 11. The extended Lotka-Volterra model: mean (left) and variance (right) of the number of both types of predators by simulation and by product form approximation.



14	7


12

10

8

6
appr. mean, R2, =0.1
4	sim. mean, R2, =0.1
appr. mean, R2, =0.5
2	sim. mean, R2, =0.5 	 appr. mean, R2, =1
0	sim. mean, R2, =1
0	2	4	6	8	10
time

6

5

4

3

2

1

0
0	2	4	6	8	10
time

Fig. 12. Perturbed network of infinite queues: mean of R2 (left) and R4 (right).


16
14
12
10
8
6
4
2
0
0	2	4	6	8	10
time
7

6

5

4

3

2

1

0
0	2	4	6	8	10
time

Fig. 13. Perturbed network of infinite queues: variance of R2 (left) and R4 (right).

nite server queues and hence their transient probabilities are approximated well in product form. We consider the reactions


∅ −2→0
R1, R1 −0→.5
R2, ∅ −2→ R3, R2 −1→ R3, R3 −1→ R4, R4 −1→ ∅, R2 + R4 −λ→ ∅


where only the last reaction causes the system not to be a network of infinite servers. The larger the rate associated with this reaction the worse the product form approximation. The initial state is |0, 0, 0, 0|. In Figures 12 and 13 we show the mean and the variance of the quantity of R2 and R4. The mean is approximated well for both reactants while the variance is captured well for R4 and is underestimated for R2. The calculations required less than two seconds.

Conclusions
In this paper we derived a product form approximation for the transient proba- bilities of Markov chains representing reaction networks. The computational effort of the method grows only linearly with the number of reactants and hence it can be applied to reaction networks for which the exact analysis of the corresponding Markov chain is unfeasible. We tested the method on several examples and found that if the average behaviour of the system is captured well by the mean-field ap- proach or the transient system behaviour is close to product form then the proposed approximation provides a good picture of the variance and the distribution of the quantity of the reactants.

References
Arns, M., P. Buchholz and A. Panchenko, On the numerical analysis of inhomogeneous continuous-time Markov chains, Informs Journal on Computing 22 (2010), pp. 416–432.
Boucherie, R. J. and P. Taylor, Transient product form distributions in queueing networks, Discrete Event Dynamic Systems: Theory and Applications 3 (1993), pp. 375–396.
Cao, Y., D. T. Gillespie and L. R. Petzold, The slow-scale stochastic simulation algorithm, J Chem Phys 122 (2005).
Chandy, K. M., U. Herzog and L. S. Woo, Parametric analysis of queueing networks, IBM Journal of
R. & D. 19 (1975), pp. 36–42.
Ciocchetta, F., A. Degasperi, J. Hillston and M. Calder, Some investigations concerning the ctmc and the ode model derived from bio-pepa., Electron. Notes Theor. Comput. Sci. 229 (2009), pp. 145–163.
Cordero, F., A. Horv´ath, D. Manini, L. Napione, M. D. Pierro, S. Pavan, A. Picco, A. Veglio, M. Sereno,
F. Bussolino and G. Balbo, Simplification of a complex signal transduction model by the application of invariants and flow equivalent server, Submitted to Theoretical Computer Science (2011).
Dayar, T., L. Mikeev and V. Wolf, On the numerical analysis of stochastic Lotka-Volterra models, in:
Proc. of the Workshop on Computer Aspects of Numerical Algorithms (CANA10), 2010, pp. 289–296.
Engblom, S., Computing the moments of high dimensional solutions of the master equation, Appl. Math. Comput 180 (2006), pp. 498–515.
Gillespie, D. T., Exact stochastic simulation of coupled chemical reactions, J. Phys. Chem. 81 (1977),
pp. 2340–2361.
Gillespie, D. T., A rigorous derivation of the chemical master equation, Physica A 188 (1992), pp. 404– 425.
Gillespie, D. T., Approximate accelerated stochastic simulation of chemically reacting systems,J Chem Phys 115 (2001), pp. 1716–1733.
Jensen, A., Markoff chains as an aid in the study of Markoff processes, Skandinavisk Aktuarietidskrift
36 (1953), pp. 87–91.
Kurtz, T. G., Solutions of ordinary differential equations as limits of pure jump Markov processes, Journal of Applied Probability 1 (1970), pp. 49–58.
Kurtz, T. G., The Relationship between Stochastic and Deterministic Models for Chemical Reactions, J Chem Phys 57 (1972), pp. 2976–2978.
Lotka, A. J., “Elements of Mathematical Biology,” Williams and Wilkins Company, 1924.
Mateescu, M., V. Wolf, F. Didier and T. A. Henzinger, Fast adaptive uniformisation of the chemical master equation, IET systems biology 4 (2010), pp. 441–452.

Moler, C. and C. V. Loan, Nineteen dubious ways to compute the exponential of a matrix, twenty-five years later, SIAM Review 45 (2003), pp. pp. 3–49.
Rathinam, M., L. R. Petzold, Y. Cao and D. T. Gillespie, Stiffness in stochastic chemically reacting systems: The implicit tau-leaping method, J Chem Phys 119 (2003), pp. 12784–12794.
Stewart, W. J., “Introduction to the Numerical Solution of Markov Chains.” Princeton University Press, 1995.
Voit, E. O., “Computational Analysis of Biochemical Systems,” Cambridge University Press, 2000.
Volterra, V., Fluctuations in the abundance of a species considered mathematically, Nature (1924).
Zhang, J., L. T. Watson and Y. Cao, Adaptive aggregation method for the chemical master equation, Int. J. of Computational Biology and Drug Design 2 (2009), pp. 134–148.
Zhang, J., L. T. Watson and Y. Cao, A modified uniformization method for the solution of the chemical master equation, Computers & Mathematics with Applications 59 (2010), pp. 573 – 584.
