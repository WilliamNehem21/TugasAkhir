Technology

Revealing spatial multimodal heterogeneity in tissues with SpaTrio


Graphical abstract

Highlights
d  Spatial deconvolution with single-cell multi-omics data

d Reconstruction of spatial distribution patterns of various biomolecules
d SpaTrio reveals spatial regulatory patterns of genes

d Inference of cellular multimodal interactions
Authors
Penghui Yang, Lijun Jin, Jie Liao, ..., Xiao Xu, Xiaoyan Lu, Xiaohui Fan

Correspondence luxy@zju.edu.cn (X.L.), fanxh@zju.edu.cn (X.F.)

In brief
Single-cell multi-omics methods have improved our ability to profile diverse cell features. However, tissue dissociation leads to the loss of spatial information. To address this, we introduce SpaTrio, a tool that integrates multi-omics and spatial data to map single cells, explore multimodal tissue landscapes, and study gene regulation and cell communication. SpaTrio was validated using simulations and real data from different tissues, providing spatial insights at the cellular level.













Yang et al., 2023, Cell Genomics 3, 100446
December 13, 2023 ª 2023 The Author(s). https://doi.org/10.1016/j.xgen.2023.100446

ll
OPEN ACCESS

Technology
Revealing spatial multimodal heterogeneity in tissues with SpaTrio
Penghui Yang,1,2,6 Lijun Jin,1,2,6 Jie Liao,1,2,6 Kaiyu Jin,1 Xin Shao,1,2 Chengyu Li,1,2 Jingyang Qian,1,2 Junyun Cheng,1 Dingyi Yu,1 Rongfang Guo,1 Xiao Xu,3 Xiaoyan Lu,1,4,5,* and Xiaohui Fan1,2,4,5,7,*
1College of Pharmaceutical Sciences, Zhejiang University, Hangzhou 310058, China
2National Key Laboratory of Chinese Medicine Modernization, Innovation Center of Yangtze River Delta, Zhejiang University, Jiaxing 314103,
China
3Key Laboratory of Integrated Oncology and Intelligent Medicine of Zhejiang Province, Department of Hepatobiliary and Pancreatic Surgery,
Affiliated Hangzhou First People’s Hospital, Zhejiang University School of Medicine, Hangzhou 310006, China
4Jinhua Institute of Zhejiang University, Jinhua 321016 China
5Westlake Laboratory of Life Sciences and Biomedicine, Hangzhou 310024, China
6These authors contributed equally
7Lead contact
*Correspondence: luxy@zju.edu.cn (X.L.), fanxh@zju.edu.cn (X.F.) https://doi.org/10.1016/j.xgen.2023.100446

SUMMARY

Capturing and depicting the multimodal tissue information of tissues at the spatial scale remains a significant challenge owing to technical limitations in single-cell multi-omics and spatial transcriptomics sequencing. Here, we developed a computational method called SpaTrio that can build spatial multi-omics data by inte- grating these two datasets through probabilistic alignment and enabling further analysis of gene regulation and cellular interactions. We benchmarked SpaTrio using simulation datasets and demonstrated its accuracy and robustness. Next, we evaluated SpaTrio on biological datasets and showed that it could detect topolog- ical patterns of cells and modalities. SpaTrio has also been applied to multiple sets of actual data to uncover spatially multimodal heterogeneity, understand the spatiotemporal regulation of gene expression, and resolve multimodal communication among cells. Our data demonstrated that SpaTrio could accurately map single cells and reconstruct the spatial distribution of various biomolecules, providing valuable multi- modal insights into spatial biology.


INTRODUCTION

The development of single-cell multi-omics sequencing methods has revolutionized our ability to profile multiple modal- ities of every cell in a single experiment, including gene expres- sion, protein abundance, and chromatin accessibility.1–4 How- ever, the tissue dissociation step results in the loss of spatial information, which is critical for understanding cell states, cellular microenvironments, and cell-cell interactions.5–7 In recent years, significant technological advancements have been made to incorporate omics data in the context of space to address this challenge.8–13 Despite these advancements, cur- rent spatial transcriptomics (ST) sequencing technologies are limited to transcriptome measurements and cannot achieve cellular-level resolution. Existing deconvolution tools primarily focus on inferring cell-type proportions or mapping cell positions using transcriptomic data. While they excel in single-modal data scenarios, their capability to effectively capture and delineate differences between diverse modalities in spatial contexts is limited.7,14–16 The lack of spatial multimodal insights into tissues has become an obstacle to a better understanding of the spatio- temporal control of gene expression and the multidimensional transmission of cellular communication in tissues.
To overcome these challenges, we present SpaTrio, a compu- tational tool for spatial mapping of single cells based on single- cell multi-omics and ST data. By integrating these datasets, SpaTrio can generate spatial maps of single cells, construct spatial patterns of cell populations, and investigate the multi- modal topography of tissues on a spatial scale. Moreover, SpaTrio can analyze the spatial co-expression of various molec- ular features and perform gene regulation analysis or cell-cell communication inferences at a spatial resolution. SpaTrio was benchmarked using simulation datasets with different spatial patterns and biological datasets.2,17–20 Furthermore, we applied SpaTrio to actual data from the mouse brain to the human liver18 and human breast cancer21 to investigate the spatial organiza- tion of various biomolecules at the cellular level.

DESIGN

In summary, SpaTrio is a computational tool that enables the spatial mapping of single-cell multi-omics data, preserving the spatial topology of tissue sections and the local geometry of modal data (Figure 1). SpaTrio achieves this by constructing a k-nearest neighbor (k-NN) graph and calculating distance matrices for each dataset. Specifically, for single-cell multi-omics



Cell Genomics 3, 100446, December 13, 2023 ª 2023 The Author(s). 1
This is an open access article under the CC BY-NC-ND license (http://creativecommons.org/licenses/by-nc-nd/4.0/).

ll
OPEN ACCESS

 
Technology




Figure 1. Spatial mapping of single-cell multi-omics data with SpaTrio
SpaTrio takes in single-cell multi-omics data and ST data as input (left). Using the optimal transport algorithm and considering the gene expression, spatial graph, and modal graph constructed by k-NN, SpaTrio calculates a probabilistic alignment between cells and spots. This alignment allows SpaTrio to build the spatial multi-omics data (middle), achieving the deconvolution of spots and reconstruction of the multi-omics patterns. Moreover, through its downstream analysis functions, SpaTrio can perform spatial gene regulation analysis and multi-omics cell-cell communication inference (right).


data, a modal graph was constructed with a low-dimensional rep- resentation of the modality assay, and for ST data, a spatial graph was constructed using spatial coordinates. Employing the fused Gromov-Wasserstein optimal transport,22 SpaTrio computes an optimal probabilistic alignment between cells in single-cell multi- omics data and spots in ST data, which minimizes both the tran- scriptional dissimilarity between two datasets and the difference in graph distance between pairs of aligned cells/spots from the same data. Finally, SpaTrio assigns the expected number of cells to each spot according to the alignment results and corrects the cell coordinates based on the transcriptional similarity between the mapped cells and the surrounding spots.
During the alignment, hyperparameter a controls the relative weight of transcriptional dissimilarity and graph distances. When a = 0, the spatial alignment only considers transcript infor- mation and ignores graph information, whereas the spatial align- ment is calculated only based on graph information when a = 1. The optimal probabilistic alignment is a one-to-many match be- tween the cells and the spots in the two datasets, corresponding to a spot containing several cell types. The flexible tuning of hy- perparameters in SpaTrio enables the consideration of multiple modalities and location information during alignment, leading to more accurate reconstruction results. This approach is partic- ularly well suited to account for the co-existence of spatial het- erogeneity and modality differences in cells.
In addition, SpaTrio offers the capability to explore the spatial co-expression distribution of various molecules via its spatial feature module analysis functionality. To achieve this, SpaTrio applies the k-NN algorithm to smooth molecular expression, calculating the spatial-weighted expression matrix using a spatial kernel. The feature modules were identified using a consensus clustering (CC) algorithm. The scores of the modules determined from the identified modules can be utilized for further analysis of spatial regulation and inference of cell-cell interac- tions based on multi-omics data.
RESULTS

Benchmarking          of         SpaTrio To assess the performance of SpaTrio, we conducted a series of evaluations on simulation single-cell multi-omics data and ST data with distinct spatial patterns derived from the mouse cere- bral cortex data (single-nucleus chromatin accessibility and mRNA expression sequencing, SNARE-seq)2 (Figure S1). The simulations of ST data involved sampling, merging, and coordi- nate assignment, followed by adding a pseudocount d read to all genes in all spots and resampling the read count. Adding a pseudocount reduces the heterogeneity of the transcriptome, which can simulate scenarios where gene expression is similar but another modality has a spatially specific distribution (Figures S2A and S2B). Subsequently, we leveraged SpaTrio to reconstruct single-cell multi-omics data. We evaluated its per- formance with various indicators, including the mapping accu- racy of cells (average percentage of cells correctly assigned to a spot of matching type), the adjusted Rand index (ARI) of the de- convolved cell type, the root-mean-square error (RMSE) of the deconvolved cell-type proportions, and the Pearson correlation coefficient (PCC) and Spearman correlation coefficient (SCC) of gene expression (Figure 2A).
Whether in pattern 1 or pattern 2, it can be seen from multiple indicators that the performance of SpaTrio (a = 0.1) became more stable as d gradually increased (Figures 2B and S3). In comparison, relying solely on gene expression (a = 0) results in a more rapid decay in mapping performance. When predicted solely on graph data (a = 1), only a minute fraction of the cells are correctly mapped, underscoring the indispensability of shared modality for precision integration. Notably, even with low transcriptome heterogeneity (d = 5), SpaTrio can accurately restore the spatial location of >87% of cells according to another modality (epigenome), and the spatial profiles of chromatin accessibility are also highly correlated with the ground truth


 
Technology
ll
OPEN ACCESS




Figure 2. SpaTrio results on simulated and biological data
Schematic of data simulation using the SNARE-seq dataset. We extracted three types of cells (L2/3 IT, L4, and L5 IT) from the SNARE-seq data and randomly sampled 250 cells from each type as a simulation single-cell multi-omics dataset (cell types 1, 2, and 3). Each cell type was then randomly assigned to groups of five for merging, and the simulated spots were assigned to the corresponding regions according to two spatial patterns (pattern 1 and pattern 2) to obtain a simulation ST dataset. We measured the performance of SpaTrio for spatial reconstruction according to cell type, gene expression, and chromatin accessibility.
The average root-mean-square error (RMSE) of SpaTrio using a = 0 (gene expression only), a = 1 (graph information only), and a = 0.1 (both) with pseudocount
d in patterns 1–4. Thirty simulation replicates were performed for each setting.
SpaTrio demonstrates superior performance compared to the other tools. The RMSE of the deconvolved cell-type proportions was calculated by comparing them with the ground truth. For simulated data, a pseudocount of 5 was set, while for biological datasets, a pseudocount of 0 was used. In the boxplots, the range
(legend continued on next page)

ll
OPEN ACCESS

 
Technology



(Figures S4A and S4B). Furthermore, we conducted simulations to replicate scenarios with a more complex distribution of cells (Figure S1). In pattern 3, 15.4% of the spots contained multiple cell types, while in pattern 4, this percentage increased to 67.8%. In both of these complex scenarios, SpaTrio (a = 0.1) demonstrated consistently stable performance, particularly when a large pseudocount was used, highlighting its significant advantages (Figure S3). In more complex biological datasets, setting the parameter a to 0.1 often resulted in optimal perfor- mance (Figure S5).
Finally, we conducted a comparison of SpaTrio with several other integration methods. These methods included ST integra- tion methods such as PASTE and Tangram, as well as CARD. Additionally, we also compared SpaTrio with single-cell RNA sequencing (scRNA-seq) integration methods, namely Seurat and Scanorama.15,23–26 Our analysis, using a range of metrics to quantify performance, shows that, across four sets of simu- lated data (patterns 1–4), SpaTrio outperforms all other tools on all evaluated pseudocount values. When transcriptome heterogeneity is low (d = 5), the gap between other tools and SpaTrio is particularly significant (Figures 2C and S6). At the same time, we compared SpaTrio with other tools (pseudo- count = 0) on multiple biological datasets (datasets 1–6). Even in complex, real scenes, SpaTrio still maintains superior perfor- mance, which is obviously better than other tools (Figure 2C). This may be because these methods were not initially designed for single-cell multi-omics data and failed to adequately account for the complex nature of integrating multimodal profiles. How- ever, this does not suggest that these methods are flawed in their ability to address integration problems.

Evaluation      of     biological      data Given the complexity and variability of the spatial organization of cells in biological scenarios, we evaluated whether SpaTrio can maintain superior performance in real-world scenarios with more complex organizational structures. To this end, we assessed the performance of SpaTrio on multi-omics data and ST data gener- ated by mouse embryo data (deterministic barcoding in tissue for spatial omics sequencing, DBiT-seq).17 These included spatial, transcriptomic, and proteomics information (Figures 3A and S7A). From these results, we found that SpaTrio successfully restored the spatial patterns of significant cell clusters, even for clusters with irregular or complex spatial patterns (Figures 3B and S7B), such as clusters 1 and 2. In the original DBiT-seq data, cluster 3 exhibited a fine loop pattern, which was not evident in the input ST data due to pixel merging inter- ference; however, SpaTrio precisely reconstructed this pattern. Similarly, cluster 4 was mixed with neighboring clusters in the ST data. However, SpaTrio recognized its correct spatial pattern (Figure 3C). These results suggest that SpaTrio can infer topo- logical heterogeneity based on subtle modal differences to achieve a structural refinement of the spatial pattern. Concerning gene expression, the SpaTrio results followed those of previous
reports. For instance, Pax6 and Lhx2 were enriched in the MAdCAM1+ region of the forebrain, whereas Myh6 and Pbn2 were enriched in selected regions that were negative for MAdCAM1 (Figures 3D and S7C). The expression of the most variable 2,000 genes was highly similar to the ground truth, and the average PCC was 0.947 (Figure 3E). At the same time, the reconstruction results of protein expression were equally accurate. For example, CD63 was expressed extensively except in a portion of the forebrain; pan-endothelial cell-antigen (PECA) was distributed in regions containing microvasculature; EpCAM, as a pan-epithelial marker, was mainly expressed in the heart region; and MAdCAM-1 was mainly expressed in the forebrain region (Figures 3D and S7D). All protein expression levels were similar to the ground truth, with an average PCC of 0.991 (Figure 3E). These findings underscore the effectiveness of SpaTrio for accurately reconstructing spatial patterns and multi- modal information in biological scenarios with complex and var- iable organizational structures.
Next, we evaluated the performance of SpaTrio on datasets generated from mouse liver slice (103 Visium with highly multi- plexed protein).18 These contained both the spatial transcrip- tome and proteome (Figure 3F). We observed that SpaTrio accu- rately reconstructed the spatial patterns of gene and protein expression (Figures 3G, 3H, and S8A). For example, Glul and Cyp2e1 were mainly expressed in the central zones, whereas Ass1 and Gls2 were mainly expressed in the portal and periportal zones (Figure 3G). Both Cd107a and Cd73 showed low expres- sion in the portal zone (Figure 3H), consistent with the input ST data. The expression levels of the top 500 genes with the highest spatial variability, as well as all proteins, exhibited a strong pos- itive correlation with actual measurements, as indicated by the high PCC (Figure 3I); specifically, gene expression reached 0.953, and protein expression reached 0.946 (Figures 3I, S8B, and S8C). These data divided the liver slice into four main zones with different functions and metabolic activities: portal, peripor- tal, mid, and central. We found that the expression of Glul and Cyp2e1 gradually increased, whereas that of Ass1 and Gls2 gradually decreased, as the location moved from the portal to the center, both in the original and mapped data (Figure 3J). Furthermore, SpaTrio accurately mapped the compartmental- ized protein expression (Figure 3K). In addition, we investigated the signal patterns of cell populations expressing surface pro- teins. For example, hepatocytes (CD1d) are mainly located in the periportal, mid, and central regions, portal vein cells (Ly6A– Ly6E) in the portal region, and central vein cells (CD105) in the central region. These results were consistent with prior knowl- edge of the distribution of cell populations in the mouse liver18 (Figures 3L and S8D).
Besides, we also evaluate the performance of SpaTrio in data- sets 3–6 (Figures S9–S12). In the mouse spleen data (dataset 3), SpaTrio accurately restored gene expression and protein distri- bution in different regions, such as genes Cd24a and Vcam1 and proteins CD163 and CD68 in the macrophage-enriched region;



of each box extends from the first to the third quartile, with the horizontal line representing the median. The whiskers extend to 1.5 times the interquartile range beyond the lower and upper bounds of the box. Dataset 1: mouse embryo data (DBiT-seq); dataset 2: mouse liver data (103 Visium with highly multiplexed proteins); dataset 3: mouse spleen data (SPOTS); dataset 4: breast tumor data (SPOTS); dataset 5: mouse embryo data (spatial ATAC-RNA-seq); dataset 6: human hippocampus (spatial ATAC-RNA-seq).


 
Technology
ll
OPEN ACCESS





(legend on next page)

ll
OPEN ACCESS

 
Technology



genes Ly86 and Ebf1 and proteins CD19 and immunoglobulin D (IgD) in the B cell-enriched region; and genes Trbc2 and Cd8b1 and proteins CD3 and CD4 in the T cell-enriched region. In the human breast tumor data (dataset 4), SpaTrio’s restoration of cell-type and multimodal information in the five regions is still very accurate. In a mouse embryonic day 13 (E13) embryo (data- set 5), Sox2 and Pax showed high gene expression and high chromatin accessibility in the embryonic field of view and the ventricular layer containing neural stem/progenitor cells, and Six6, a key gene involved in eye development, was found in the eye region and showed the highest gene activity. In the hu- man hippocampus data (dataset 6), the accessibility of THY1 and BCL11B appears in the granule cell layer (GCL), and PROX1 is highly expressed in GCL but shows moderate chro- matin accessibility.

Topological organizations and regulations of mouse brain cortex cells
We first applied SpaTrio to the public mouse brain single-cell multi-omics dataset (in situ sequencing hetero RNA–DNA-hybrid after assay for transposase-accessible chromatin-sequencing, ISSAAC-seq)27 (Figures S13A and S13B) and the ST dataset (Visium, 103 Genomics) (Figure S13C). SpaTrio accurately re- constructed the layer (L)-specific features of excitatory neuron subpopulations, arranged in the exact order of L2/3 (L2/3 IT, L2/3 IT Act), L4/L5 (L4/5 IT, L5 PT), and L6 (L6 CT, L6 IT Bmp3,
L6b) (Figures 4A, 4B, S13D, and S13E), consistent with prior knowledge of the organization of the cortex. We observed the distribution of cell populations in different cortical regions, such as L2/3 IT in region 2 (L2/3); L4/5 IT in region 3 (L4); L5 PT in region 4 (L5); L6 CT, L6 IT Bmp3, and L6b in region 5 (L5); and Oligo in region 6 (Oligo) (Figure 4C). To validate the ac- curacy of the reconstructed spatial expression patterns, we selected region-specific genes from ST data. We compared their spatial expression patterns before and after reconstruction (Fig- ure 4D). Their high consistency demonstrated that SpaTrio suc- cessfully preserved the transcriptional differences between the cortical layers in the input data.
Consequently, we explored the spatial patterns of gene regu- lation in mouse cerebral cortex organization using gene expres- sion and chromatin accessibility. Transcription factors play a determinative role in cell differentiation, critical for determining cell fate during brain aging and development by regulating
gene expression.28–34 We inferred transcription-factor-associ- ated accessibility from an epigenomic assay of spatial multi- omics data constructed by SpaTrio and performed transcription factor regulation analysis based on the correlation between mo- dalities (Figure S13F and S13G). Our findings revealed distinct gene regulation relationships for the mouse brain’s cortical marker genes Rorb and Cux2 (Tables S1 and S2). Specifically, the activation regulator RORB demonstrated a synchronous change in gene and motif activity across different layers, with a close spatial pattern of gene expression and motif activity peak- ing at L4/5. In contrast, the inhibitory regulator CUX2 exhibited the opposite trend and spatial distribution (Figure 4E). These re- sults demonstrate that regardless of the gene regulatory relation- ship, SpaTrio effectively recovers the spatial pattern of gene regulation, preserving the differences and connections between the modalities.
In the ISSAAC-seq data, L4/5 IT cells were considered a pop- ulation based on the transcriptome but were divided into three subpopulations based on the epigenome, indicating higher het- erogeneity in the chromatin accessibility of these cells (Figures S14A and S14B). The differences between these two modalities are essential for studying gene regulation. From the results of SpaTrio, we observed that the three major clusters (A2, A3, and A9) of the transposase-accessible chromatin (ATAC) assay were roughly distributed in layers, with the inner, middle, and outer layers represented in turn (Figure 4F), indi- cating that SpaTrio can identify differences in multiple modalities to infer the differentiated topological arrangement of cells comprehensively. We analyzed the spatial modules of the tran- scriptome and identified two gene modules in L4/5 IT cells. Mod- ule 1 contained genes such as Fezf2 and Sox5,29,35 which are markers of L5, whereas module 2 contained Cux2 and Rorb, which are markers of L434 (Figure 4G). Importantly, the signal of module 1 was highly activated in the inner layer, whereas that of module 2 was predominantly expressed in the outer layer, consistent with the spatial distribution of L5 and L4 cells (Fig- ure 4H). We re-clustered the L4/5 cells. We obtained two cell subpopulations, which, respectively, highly expressed two gene modules (Figures S14C and S14D), and the two groups of cells can be annotated as L4 and L5 based on marker genes and spatial position (Figure 4I). This demonstrates that SpaTrio can infer the topological heterogeneity of the same cell type by recognizing subtle transcriptional differences.27,35



Figure 3. SpaTrio results on embryonic mouse brain (DBiT-seq) and mouse liver datasets (103 Genomics)
Schematic diagram of input dataset construction using DBiT-seq data from the embryonic mouse brain. We merged the four adjacent pixels in the DBiT-seq data, removed the protein assay as input ST data, and used SpaTrio to perform spatial reconstruction of the DBiT-seq data, with the spatial position removed.
Spatial location of clusters 1 and 2 in the DBiT-seq and SpaTrio-predicted data.
Comparison of the spatial location of clusters 3 and 4 in the input spatial dataset, the DBiT-seq data, and the SpaTrio reconstruction.
Spatial expression of key genes and proteins in DBiT-seq measurements and SpaTrio mapping results.
The PCCs between the measured and SpaTrio-predicted expression of 2,000 highly variable genes (left) and all proteins (right).
Schematic diagram of input datasets using 103 Visium data of mouse liver data. We divided the liver slice into two parts—one part removed the spatial coordinates, and the other removed the protein assay—and then used the two as the input data for SpaTrio.
(G and H) Spatial expression of test genes (G) and proteins (H) in actual measurements and SpaTrio mapping results.
The PCCs between the measured and SpaTrio-predicted expression of 500 highly variable genes (left) and all proteins (right) in different liver zones.
Violin plot of expression levels of region-specific genes in the liver. Normalized expression values are indicated on the y axis.
The scaled PCCs between the measured and SpaTrio-predicted expression of cell-type-specific proteins in different zones.
Zonated expression pattern of cell-type-specific proteins from SpaTrio mapping results. KCs, Kupffer cells; LSECs, liver sinusoidal endothelial cells; Heps, hepatocytes; PV, portal vein; CV, central vein.


 
Technology
ll
OPEN ACCESS





(legend on next page)

ll
OPEN ACCESS

 
Technology



Finally, the spatial distribution of motif activity in the mouse brain was investigated. Our analysis revealed four distinct motif modules, each exhibiting a unique spatial distribution pattern (Figures 4J and S14E). Module 1 displayed a predominant distri- bution in the inner and middle layers of the cortex, comprising transcription factors such as CUX1 and CUX2, which regulate neurons in the upper cortex.32,36 In contrast, module 2 was pre- dominantly located in the middle and outer layers and included RORB and RORA, which have been reported to be specific reg- ulators of L4.30,31 Module 3, enriched in the middle layer, included motifs that regulate the development of the nervous system. Specifically, NEUROD2 is considered a key epigenome remodeler,33 while Atoh1 and Tcf4 cooperate to realize the func- tion of regulating nervous system development28 (Figures 4K and S14F). Overall, transcriptional and epigenetic information have many similarities. For example, the results of the module analysis were closely related to the depth of the cortical layer. The module related to L4 is located in the outer layer, and the module related to L5 is located in the inner layer. This is also consistent with the objective fact of cortical distribution. Howev- er, the ATAC assay exhibited richer spatial and cellular heteroge- neity and clustered cell subpopulations that could not be distin- guished based on the transcriptome. The spatial mapping and transcription factor analysis results showed that the middle layer cells (A3) might play an essential role in developing L5 and L4 in the mouse brain.

Spatial cellular heterogeneity and signal transmission in steatosis liver
We applied SpaTrio to both the public ST dataset (Visium, 103
Genomics) and single-cell multi-omics dataset (cellular indexing of transcriptomes and epitopes, CITE-seq) of human steatotic livers (Figures 5A and S15A). The reconstructed cell-type distri- bution approximated the input ST data. A high correlation was observed in the expression of known marker genes and the per- centage of each cell type across spots, including hepatocytes (CYP3A4), cholangiocytes (ANXA4), and fibroblasts (ACTA2)18 (Figures 5B, 5C, and S15B). Notably, in the periportal, mid, and central regions, hepatocytes dominated the cell composition, a finding consistent with recently published liver ST data.37 Conversely, in the portal region, fibroblasts constituted most of the cells across the spots (Figure S15C). Fibroblasts are a critical component of liver tissue, forming fibrous structures in the portal
area and playing an essential role in blood distribution and artery support.38
Because hepatocytes constitute most of the cellular composi- tion in several liver zones, we first focused our analysis on this population. Using module analysis of the transcripts, we identi- fied two gene modules with distinct expression patterns. One module was highly expressed in the central region and included CYP3A4 and GLUL, which are associated with central hepato- cytes. In contrast, the other module was highly expressed in the periportal region and included ASS1 and other genes asso- ciated with periportal hepatocytes (Figures 5D, 5E, and S15D– S15F). We re-clustered all hepatocytes to further elucidate het- erogeneity within the hepatocyte population, resulting in two subpopulations (clusters 1 and 2). These corresponded to the two gene modules (Figures 5F and S16A). At the same time, dif- ferential gene analysis, regional subpopulation distribution, and pathway analysis also proved that these two types of cells were central and periportal hepatocytes (Figures S16B–S16G). We further inferred hepatocyte trajectories to investigate spatial expression dynamics and mapped their pseudotime using SpaTrio (Figures S16H and S16I). We observed continuous spatial trajectories from the center to the periportal between the two hepatocyte subpopulations, along with continuous spatial trends in the marker genes of central hepatocytes (CYP3A4, CYP2E1, and GLUL) and periportal hepatocyte genes (GLS2, ASL, and ASS1)39 (Figures 5G and S16J). These results indicated that SpaTrio successfully restored the spatial structure of continuous transcriptional programs in tissues.
Next, we selected hepatocytes in the portal and periportal areas and performed spatial multimodal interaction analysis of gene expression and protein abundance (Figure 5H). Through analysis of protein modules, we identified two activated modules in the portal periportal regions (Figures 5I and 5J). We used the proteins contained in these modules as region-specific proteins to infer cellular interactions. Our analysis revealed that for infor- mation transmitted from the portal to the periportal regions, cell communication in the transcriptome contained important infor- mation related to fibrosis, consistent with steatosis-induced fibrosis occurring in the portal vein and its surrounding area.40 Ligand and receptor genes are involved in the SMAD protein phosphorylation and extracellular matrix (ECM) organization pathway (Figures 5K and S17A), which play critical roles in devel- oping  liver  fibrosis.41,42  Taking  specific  ligand-receptor



Figure 4. SpaTrio reconstructed spatial organization and regulation in mouse cortex tissue
Single-cell deconvolution of lower-resolution mouse cortex ST data. There were six regions in the input ST data, and the predicted single cells were colored based on the cell type.
SpaTrio-based Euclidean distance of selected cell populations to the R21 Oligo.
The proportion of selected cell types distributed in different regions of the mouse cortex.
Zonated expression levels of test region-specific genes in real measurements and SpaTrio mapping results.
The scaled expression and activity of the activation (left) and inhibitory (right) regulators in different layers of the cortex and SpaTrio-predicted spatial patterns of gene expression and motif activity.
SpaTrio spatial mapping of R2 Ex-L4/5 IT cells.
Spatial gene modules of R2 Ex-L4/5 IT cells were identified using SpaTrio.
SpaTrio maps of the activity score of the spatial gene modules of R2 Ex-L4/5 IT cells.
Spatial locations of re-clustered R2 Ex-L4/5 IT cells using SpaTrio (right) and the dot plot of the expression of layer-specific genes (left).
Spatial motif modules of R2 Ex-L4/5 IT cells identified using SpaTrio.
Activity score of motif modules in ATAC clusters. Boxplots depict the median and interquartile range, spanning the 25th to 75th percentile. The whiskers extend to a distance of 1.5 times the interquartile range from the box. p values were calculated using the Wilcoxon test. ****p % 0.0001.


 
Technology
ll
OPEN ACCESS




Figure 5. SpaTrio reconstructed spatial organization and cellular multimodal interactions in human steatosis liver tissue
Single-cell deconvolution of lower-resolution human liver ST data. Four liver zonations were in the input ST data, and the predicted single cells were colored based on the cell type.

ll
OPEN ACCESS

 
Technology



interaction pairs as an example, GDF5 is a signaling protein that regulates cell growth, differentiation, and survival. The ligand ACVR2A activated by GDF5 is a transmembrane receptor protein that regulates hepatic fibrosis.43 COL1A2, COL4A4, COL4A1, and COL1A1 encode different types of collagen, which are components of the ECM in the liver, and their receptor ITGAV, which is part of an essential pathway that regulates the fibrotic liver.44 In addition, the ITGAL receptor in protein-protein interactions is associated with immune responses in the ECM and fibrosis in the liver.45 Our multimodal cell-cell interaction analysis revealed that the portal vein influences the fibrosis of cells in the peripheral area through intercellular communication involving multiple modalities.
The transcriptional communications transmitted from the periportal to the portal were mainly related to the regulation of inflammation, hypoxic stress, and lipid metabolism (Figures 5L and S17B). For instance, TGFBR1 is involved in modulating the cellular reactive oxygen species (ROS) level, which was closely related to lipotoxicity and inflammatory response during nonalcoholic steatohepatitis (NASH).46 ITGAV can activate the PI3K-Akt signaling pathway by recruiting PI3K to the plasma membrane, activating Akt, and regulating downstream tar- gets.47 It has been shown that the PI3K/Akt pathway is activated in response to hypoxia and inhibits oxidative stress in the stea- tosis liver. Additionally, LGALS9 plays a role in cell adhesion, apoptosis, and immune response, and CD47 helps protect healthy cells from being engulfed and destroyed by the immune system48 (Figure 5L). Previous studies have demonstrated an association between these two proteins and tissue hypoxia. Thus, our analysis indicates that the periportal region responds to inflammation and hypoxia in the portal vein through specific ligand-receptor pairs of genes and proteins.

Spatial multimodal immune microenvironment of a breast cancer tissue
SpaTrio was applied to publicly available single-cell multi- omics and ST datasets (Visium, 103 Genomics) of human breast cancer21 (Figures 6A and S18B). Using SpaTrio, all sin- gle cells were mapped to histologically defined regions of breast cancer tissue (Figure 6B). We selected multiple cell- type-specific marker genes to calculate the abundance of cell types for each spot in the input ST data (Table S3). We compared it with the proportion of cell types mapped using SpaTrio. From the perspective of spatial arrangement, it was
evident that there was a good agreement between cell abun- dance and type ratio (Figure 6C).
Considering the critical role of T cells in the tumor microenvi- ronment and their wide distribution in various regions21 (Fig- ure S18C), we performed a comprehensive analysis of T cells. We categorized T cells into five subgroups, among which natural killer T (NKT) cells were the most prominent in the invasive can- cer + lymphocyte area. It constitutes a much higher proportion than any other region (Figure 6D). This finding suggests that this region may be recognized and surveyed by the immune sys- tem and exhibit antitumor activity49 (Figure S18D). We then calculated the cytotoxicity and exhaustion scores for each T cell and found higher cytotoxicity scores. The exhaustion score was lower in the invasive cancer + lymphocytes area, suggesting a higher activation of T cells in the infiltrated area (Figures 6E, S18E, and S18G). Nevertheless, this difference in T cell function was not pronounced in the input ST data (Figures S18F and S18G), likely because of multiple cells in the spots. In addition, we examined the expression of related proteins. It was apparent that proteins related to T cell activation (CD3, PD-1, CD45, and TCRab)50,51 had significantly higher signal intensity in the inva- sive cancer + lymphocytes area (Figures 6F and S18H). Further- more, we performed a spatial module analysis on the proteome of T cells in the main regions and obtained two main modules (Figure 6G). Module 1 contained several proteins related to T cell inhibition or exhaustion, including PDPN, TIM-3, and CD62L.52–54 In contrast, module 2 comprises several proteins associated with T cell activation, such as PD-1, CD45RO, CD45,50,51,55 and others. Regarding spatial distribution, module 1 was highly abundant in the stroma, lymphocytes, and invasive cancer areas, whereas module 2 mainly enriched in the invasive cancer + lymphocytes area (Figures 6H and 6I). Based on the spatial pattern of the protein modules, we confirmed that T cells in the infiltrating area exhibited significant immune activity and participated in antitumor immune responses.
We selected the major cell types in the invasive cancer + lymphocytes area and performed multimodal interaction anal- ysis (Figure 6J). The interaction information between the tran- scriptome and the proteome was consistent, indicating the reliability of the results. We observed that myeloid, perivascu- lar-like (PVL), and endothelial cells affected T cells’ CD3D/ CD3G genes and CD3D/TLR4 proteins. These genes play essential roles in T cells’ recognition and signaling of antigens and are critical for T cell activation and function.56,57 TLR4 is a



Scaled PCCs between gene expression of cell markers and percentage of each cell type.
Spatial expression of test genes in real measurements and SpaTrio mapping results.
Spatial gene modules of hepatocytes identified by SpaTrio.
SpaTrio maps of liver zonation (left) and activity scores of the spatial gene modules of hepatocytes (right).
UMAPs of re-clustered hepatocytes showing cell subpopulations (left) and scores of spatial gene modules (right).
Dot plot of gene expression in periportal hepatocytes (GLS2, ASL, and ASS1) and central hepatocytes (CYP3A4, CYP2E1, and GLUL) across the three regions. The circle size indicates the ratio of cell expression, and the color indicates the average expression level.
Spatial maps of selected hepatocytes in the portal and periportal regions.
Spatial protein modules of selected hepatocytes identified by SpaTrio.
SpaTrio maps (top) and boxplots (bottom) of selected hepatocytes’ protein module activity score. p values were calculated using the Wilcoxon test.
****p % 0.0001.
Significantly enriched gene-gene interactions from the portal to periportal inferred by SpaTrio mapping (left) and protein-protein interactions inferred from the spatial protein modules of hepatocytes (right). The circle size indicates the score of the ligand-receptor interaction.
Gene-gene and protein-protein interactions from the periportal to the portal, inferred by SpaTrio.


 
Technology
ll
OPEN ACCESS




Figure 6. SpaTrio reconstructed the spatial organization of the immune microenvironment with multimodal communication in human breast cancer tissue
103 Visium ST dataset of human breast cancer with six pathological regions.
Single-cell deconvolution of lower-resolution human breast cancer ST data. The predicted single cells are colored based on the cell type. PVLs, perivascular- like cells; CAFs, cancer-associated fibroblasts.
Spatial abundance of cell types in actual measurements and proportions mapped using SpaTrio.
UMAPs of re-clustered T cells and the proportion of T cell subpopulations across pathological regions.
Dot plot of cytotoxicity score and exhaustion scores of T cells.
Violin plot of the expression of proteins related to T cell activity.

ll
OPEN ACCESS

 
Technology



TLR expressed on the surface of various immune cells and can trigger their activation of immune cells.58 These results sug- gest that multiple cell types in the microenvironment contribute to T cell activation. We found that PVL cells might play an important role in cellular communications in this re- gion. PVL can affect the immune environment by stimulating the CXCR4 and TREM2 genes in myeloid cells.59,60 Interaction with CD40LG as a ligand can activate the immune response of myeloid cells and indirectly support the expansion and migra- tion of T cells.61,62 Myeloid cells regulate cell growth, division, and angiogenesis through gene and protein interactions. Stim- ulation of T cells by EGFR may affect the activity of the NOTCH pathway in PVL cells.63 At the same time, FASLG on the surface of T cells and the FAS of PVL cells interacted, and the FAS receptor regulated NOTCH pathway signaling by activating the ERK-JAG1 axis,64 which provides further ev- idence of the effect of T cells on PVL cells (Figure 6K). The NOTCH pathway promotes angiogenesis and breast cancer metastasis. PVL cells were also involved in the RHO pathway associated with tumor progression (Figure S19A), and clinical samples with high expression of the PVL marker gene (IGFBP5) have a poor prognosis (Figures S19B and S19C). Hence, PVL cells may play a vital role in promoting the devel- opment and metastasis of breast cancer by engaging in multi- modal messaging with immune cells.

DISCUSSION

We introduced SpaTrio, a computational tool that leverages transcriptome similarity and modal/spatial graph distance to integrate single-cell multi-omics data and ST data to recon- struct a multimodal spatial map of cells. Furthermore, SpaTrio facilitates downstream analysis of the reconstructed spatial multi-omics data. SpaTrio offers several benefits over existing computational methods. First, it is currently the most advanced computational tool capable of reconstructing the spatial distribution of multiple modalities of single cells, enabling the generation of cell maps using spatial and modal graphs as inputs. Second, it enables the study of cell types and states from the perspective of single cells on a spatial scale, which is more flexible and informative. Third, SpaTrio features spatial module analysis and spatial cell-cell interac- tion analysis functions, which enable the exploration of the spatial regulation of gene expression and multidimensional transmission of cellular communication in tissues. Finally, with the development of single-cell multi-omics sequencing technology, SpaTrio can simultaneously restore the states of various biomolecules on a spatial scale to provide more diverse and in-depth omics insights into tissues.
First, we performed benchmarks on SpaTrio using simulated datasets to evaluate accuracy and robustness with different spatial patterns, noise levels, and hyperparameters. These re-
sults indicate that the spatial arrangement of cells based only on transcriptome similarity should be treated with caution. The topological features of slices and the local geometry of omics can help produce more reliable results. In comparison with other integration tools, SpaTrio shows superior performance. In bio- logical datasets, SpaTrio can also refine the spatial patterns of irregularly distributed cell populations and preserve the gradient distribution characteristics of various biomolecules among tis- sue regions. We demonstrated that SpaTrio could maintain cell alignment in real complex tissue structure scenarios.
SpaTrio is then applied to several real datasets. SpaTrio accu- rately identified the cortical layers in the mouse cerebral cortex data and revealed the gene regulatory relationships of different modes at a spatial resolution. Moreover, SpaTrio resolved high-resolution substructures of cell populations and modality- specific spatial heterogeneity. In mouse liver data, SpaTrio accurately mapped major cell types and subdivided hepatocyte classifications through the spatial detection of gene modules. Analysis of the interaction between the portal and periportal regions revealed gene and protein interactions between them under steatotic conditions. In human breast cancer data, SpaTrio analyzed the differences in cell composition among pathological regions and highlighted the higher immune activity of T cells in the invasive cancer + lymphocytes area. Further anal- ysis of this region revealed the multimodal communication preferences of immune and other cell types in the tumor microenvironment.
In the future, the continuous development of single-cell multi- omics sequencing technology will provide additional omics per- spectives for understanding the intricate states of individual cells. By incorporating data from the central dogma of gene regulation, SpaTrio can potentially unravel the complex interplay network between the gene and protein regulatory layers in tissues.
In general, single-cell analysis has entered the multi-omics age, and single-cell multi-omics technology and ST technology are increasingly used in biological research. Therefore, we antic- ipate that SpaTrio will become a valuable tool for investigating tissues’ physiological and pathological states on a spatial scale, thereby providing new insights into the complex mechanisms underlying tissue development and disease progression.

Limitations of the study
SpaTrio has certain requirements for the type of input data and can only perform spatial reconstruction on paired single-cell multi-omics data. It also requires single-cell data to have clear clustering labels, and spatial transcriptome data also require clustering labels or regional annotations.
Additionally, SpaTrio currently does not support inputting im- age data. As a result, it cannot utilize image information to refine the accuracy of individual cell coordinates or estimate the num- ber of cells in specific locations. Nevertheless, we are of the



Spatial protein modules of selected T cells identified using SpaTrio.
Activity scores of protein modules of selected T cells. p values were calculated using the Wilcoxon test. ****p % 0.0001.
SpaTrio maps of selected T cells and spatial pattern of protein module activity scores.
SpaTrio maps and the number of invasive cancer + lymphocytes cell types.
Gene-gene and protein-protein interactions between major cell populations inferred using SpaTrio.


 
Technology
ll
OPEN ACCESS



opinion that incorporating advanced image recognition and seg- mentation techniques into SpaTrio in the future will substantially augment its functionality.

STAR+METHODS

Detailed methods are provided in the online version of this paper and include the following:
d KEY RESOURCES TABLE
d RESOURCE AVAILABILITY
B Lead contact
B Materials availability
B Data and code availability
d METHODS DETAILS
B SpaTrio toolkit B Simulation data B Biological data
B Mouse brain cortex data analysis
B Human liver data analysis
B Human breast cancer data analysis
B Transcription factor regulation analysis
B Pathway and biological process enrichment analysis
d SURVIVAL ANALYSIS
d QUANTIFICATION AND STATISTICAL ANALYSIS

SUPPLEMENTAL INFORMATION

Supplemental information can be found online at https://doi.org/10.1016/j. xgen.2023.100446.

ACKNOWLEDGMENTS

This work is supported by the National Natural Science Foundation of China (81973701); the Natural Science Foundation of Zhejiang Province (LZ20H290002); the Innovation Team and Talents Cultivation Program of the National Administration of Traditional Chinese Medicine (no. ZYYCXTD- D-202002); and the Fundamental Research Funds for the Central Universities (no. 226-2022-00226, no. 226-2023-00114, and no. 226-2023-00059). The
authors thank the High-Performance Computing Cluster of Zhejiang Univer- sity Innovation Center of Yangtze River Delta and Alibaba- Zhejiang University Joint Research Center of Future Digital Healthcare for their technical support.

AUTHOR CONTRIBUTIONS

X.F. and X.L. conceived the study. P.Y. drafted the manuscript. L.J., K.J., J.L., and X.S. collected and analyzed the single-cell multi-omics data and ST data. J.Q., C.L., and J.C. implemented the algorithm of SpaTrio. P.Y. and L.J. devel- oped the package of SpaTrio. J.L. and K.J. provided important advice on cell- type annotation and regulation analysis of brain tissue. D.Y. provided impor- tant advice on the application of algorithms in tumors. X.X. and R.G. provided important advice on liver tissue cellular communication analysis. All authors wrote the manuscript and read and approved the final manuscript.

DECLARATION OF INTERESTS
The authors declare no competing interests. Received: March 28, 2023
Revised: July 28, 2023
Accepted: October 26, 2023
Published: November 27, 2023
REFERENCES

Ma, S., Zhang, B., LaFave, L.M., Earl, A.S., Chiang, Z., Hu, Y., Ding, J., Brack, A., Kartha, V.K., Tay, T., et al. (2020). Chromatin Potential Identified by Shared Single-Cell Profiling of RNA and Chromatin. Cell 183, 1103– 1116.e20.
Chen, S., Lake, B.B., and Zhang, K. (2019). High-throughput sequencing of the transcriptome and chromatin accessibility in the same cell. Nat. Bio- technol. 37, 1452–1457.
Stoeckius, M., Hafemeister, C., Stephenson, W., Houck-Loomis, B., Chat- topadhyay, P.K., Swerdlow, H., Satija, R., and Smibert, P. (2017). Simulta- neous epitope and transcriptome measurement in single cells. Nat. Methods 14, 865–868.
Park, J., Kim, J., Lewy, T., Rice, C.M., Elemento, O., Rendeiro, A.F., and Mason, C.E. (2022). Spatial omics technologies at multimodal and single cell/subcellular level. Genome Biol. 23, 256.
Liao, J., Lu, X., Shao, X., Zhu, L., and Fan, X. (2021). Uncovering an Organ’s Molecular Architecture at Single-Cell Resolution by Spatially Resolved Transcriptomics. Trends Biotechnol. 39, 43–58.
Janiszewska, M. (2020). The microcosmos of intratumor heterogeneity: the space-time of cancer evolution. Oncogene 39, 2031–2039.
Longo, S.K., Guo, M.G., Ji, A.L., and Khavari, P.A. (2021). Integrating sin- gle-cell and spatial transcriptomics to elucidate intercellular tissue dy- namics. Nat. Rev. Genet. 22, 627–644.
Sta˚ hl, P.L., Salme´ n, F., Vickovic, S., Lundmark, A., Navarro, J.F., Magnus- son, J., Giacomello, S., Asp, M., Westholm, J.O., Huss, M., et al. (2016). Visualization and analysis of gene expression in tissue sections by spatial transcriptomics. Science 353, 78–82.
Rodriques, S.G., Stickels, R.R., Goeva, A., Martin, C.A., Murray, E., Van-
derburg, C.R., Welch, J., Chen, L.M., Chen, F., and Macosko, E.Z. (2019). Slide-seq: A scalable technology for measuring genome-wide expression at high spatial resolution. Science 363, 1463–1467.
Deng, Y., Bartosovic, M., Ma, S., Zhang, D., Kukanja, P., Xiao, Y., Su, G., Liu, Y., Qin, X., Rosoklija, G.B., et al. (2022). Spatial profiling of chromatin accessibility in mouse and human tissues. Nature 609, 375–383.
Fan, R., Zhang, D., Deng, Y., Kukanja, P., Bartosovic, M., Su, G., Bao, S., Liu, Y., Xiao, Y., Ma, S., et al. (2022). Spatially resolved epigenome-tran- scriptome co-profiling of mammalian tissues at the cellular level. Review).
Deng, Y., Bartosovic, M., Kukanja, P., Zhang, D., Liu, Y., Su, G., Enninful, A., Bai, Z., Castelo-Branco, G., and Fan, R. (2022). Spatial-CUT&Tag: Spatially resolved chromatin modification profiling at the cellular level. Sci- ence 375, 681–686.
Vandereyken, K., Sifrim, A., Thienpont, B., and Voet, T. (2023). Methods and applications for single-cell and spatial multi-omics. Nat. Rev. Genet. 24, 494–515.
Moncada, R., Barkley, D., Wagner, F., Chiodin, M., Devlin, J.C., Baron, M., Hajdu, C.H., Simeone, D.M., and Yanai, I. (2020). Integrating microarray- based spatial transcriptomics and single-cell RNA-seq reveals tissue ar- chitecture in pancreatic ductal adenocarcinomas. Nat. Biotechnol. 38, 333–342.
Ma, Y., and Zhou, X. (2022). Spatially informed cell-type deconvolution for
spatial transcriptomics. Nat. Biotechnol. 40, 1349–1359.
Kleshchevnikov, V., Shmatko, A., Dann, E., Aivazidis, A., King, H.W., Li, T., Elmentaite, R., Lomakin, A., Kedlian, V., Gayoso, A., et al. (2022). Cell2lo- cation maps fine-grained cell types in spatial transcriptomics. Nat. Bio- technol. 40, 661–671.
Liu, Y., Yang, M., Deng, Y., Su, G., Enninful, A., Guo, C.C., Tebaldi, T., Zhang, D., Kim, D., Bai, Z., et al. (2020). High-Spatial-Resolution Multi- Omics Sequencing via Deterministic Barcoding in Tissue. Cell 183, 1665–1681.e18.
Guilliams, M., Bonnardel, J., Haest, B., Vanderborght, B., Wagner, C., Re- mmerie, A., Bujko, A., Martens, L., Thone´ , T., Browaeys, R., et al. (2022).

ll
OPEN ACCESS

 
Technology



Spatial proteogenomics reveals distinct and evolutionarily conserved he- patic macrophage niches. Cell 185, 379–396.e38.
Ben-Chetrit, N., Niu, X., Swett, A.D., Sotelo, J., Jiao, M.S., Stewart, C.M., Potenski, C., Mielinis, P., Roelli, P., Stoeckius, M., and Landau, D.A. (2023). Integration of whole transcriptome spatial profiling with protein markers. Nat. Biotechnol. 41, 788–793.
Zhang, D., Deng, Y., Kukanja, P., Agirre, E., Bartosovic, M., Dong, M., Ma, C., Ma, S., Su, G., Bao, S., et al. (2023). Spatial epigenome–transcriptome co-profiling of mammalian tissues. Nature 616, 113–122.
Wu, S.Z., Al-Eryani, G., Roden, D.L., Junankar, S., Harvey, K., Andersson, A., Thennavan, A., Wang, C., Torpy, J.R., Bartonicek, N., et al. (2021). A single-cell and spatially resolved atlas of human breast cancers. Nat. Genet. 53, 1334–1347.
Vayer, T., Chapel, L., Flamary, R., Tavenard, R., and Courty, N. (2019). Optimal Transport for structured data with application on graphs. Preprint at arXiv 53.
Zeira, R., Land, M., Strzalkowski, A., and Raphael, B.J. (2022). Alignment and integration of spatial transcriptomics data. Nat. Methods 19, 567–575.
Biancalani, T., Scalia, G., Buffoni, L., Avasthi, R., Lu, Z., Sanger, A., Tok- can, N., Vanderburg, C.R., Segerstolpe, A˚ ., Zhang, M., et al. (2021). Deep learning and alignment of spatially resolved single-cell transcrip-
tomes with Tangram. Nat. Methods 18, 1352–1362.
Hao, Y., Hao, S., Andersen-Nissen, E., Mauck, W.M., Zheng, S., Butler, A., Lee, M.J., Wilk, A.J., Darby, C., Zager, M., et al. (2021). Integrated analysis of multimodal single-cell data. Cell 184, 3573–3587.e29.
Hie, B., Bryson, B., and Berger, B. (2019). Efficient integration of heteroge- neous single-cell transcriptomes using Scanorama. Nat. Biotechnol. 37, 685–691.
Xu, W., Yang, W., Zhang, Y., Chen, Y., Hong, N., Zhang, Q., Wang, X., Hu, Y., Song, K., Jin, W., and Chen, X. (2022). ISSAAC-seq enables sensitive and flexible multimodal profiling of chromatin accessibility and gene expression in single cells. Nat. Methods 19, 1243–1249.
Mulvaney, J., and Dabdoub, A. (2012). Atoh1, an Essential Transcription Factor in Neurogenesis and Intestinal and Inner Ear Development: Func- tion, Regulation, and Context Dependency. JARO 13, 281–293.
Lai, T., Jabaudon, D., Molyneaux, B.J., Azim, E., Arlotta, P., Menezes, J.R.L., and Macklis, J.D. (2008). SOX5 Controls the Sequential Generation of Distinct Corticofugal Neuron Subtypes. Neuron 57, 232–247.
Clark, E.A., Rutlin, M., Capano, L.S., Aviles, S., Saadon, J.R., Taneja, P., Zhang, Q., Bullis, J.B., Lauer, T., Myers, E., et al. (2020). Cortical RORb is required for layer 4 transcriptional identity and barrel integrity. Elife 9, e52370.
Ino, H. (2004). Immunohistochemical Characterization of the Orphan Nu- clear Receptor RORa in the Mouse Nervous System. J. Histochem. Cyto- chem. 52, 311–323.
Cubelos, B., Sebastia´ n-Serrano, A., Beccari, L., Calcagnotto, M.E., Cis- neros, E., Kim, S., Dopazo, A., Alvarez-Dolado, M., Redondo, J.M., Bovo- lenta, P., et al. (2010). Cux1 and Cux2 Regulate Dendritic Branching, Spine Morphology, and Synapses of the Upper Layer Neurons of the Cortex. Neuron 66, 523–535.
Runge, K., Mathieu, R., Bugeon, S., Lafi, S., Beurrier, C., Sahu, S., Schal- ler, F., Loubat, A., Herault, L., Gaillard, S., et al. (2021). Disruption of NEUROD2 causes a neurodevelopmental syndrome with autistic features via cell-autonomous defects in forebrain glutamatergic neurons. Mol. Psy- chiatr. 26, 6125–6148.
Zhang, Z., Zhou, J., Tan, P., Pang, Y., Rivkin, A.C., Kirchgessner, M.A., Williams, E., Lee, C.-T., Liu, H., Franklin, A.D., et al. (2021). Epigenomic di- versity of cortical projection neurons in the mouse brain. Nature 598, 167–173.
Mun˜ oz-Castan˜ eda, R., Zingg, B., Matho, K.S., Chen, X., Wang, Q., Foster, N.N., Li, A., Narasimhan, A., Hirokawa, K.E., Huo, B., et al. (2021). Cellular anatomy of the mouse primary motor cortex. Nature 598, 159–166.
Zimmer, C., Tiveron, M.C., Bodmer, R., and Cremer, H. (2004). Dynamics of Cux2 Expression Suggests that an Early Pool of SVZ Precursors is Fated to Become Upper Cortical Layer Neurons. Cerebr. Cortex 14, 1408–1420.
Yuan, Z., Zhou, Q., Cai, L., Pan, L., Sun, W., Qumu, S., Yu, S., Feng, J., Zhao, H., Zheng, Y., et al. (2021). SEAM is a spatial single nuclear metab- olomics method for dissecting tissue microenvironment. Nat. Methods 18, 1223–1232.
Dranoff, J.A., and Wells, R.G. (2010). Portal fibroblasts: Underappreciated mediators of biliary fibrosis. Hepatology 51, 1438–1444.
Halpern, K.B., Shenhav, R., Matcovitch-Natan, O., To´ th, B., Lemze, D., Golan, M., Massasa, E.E., Baydatch, S., Landen, S., Moor, A.E., et al. (2017). Single-cell spatial reconstruction reveals global division of labour in the mammalian liver. Nature 542, 352–356.
Acharya, P., Chouhan, K., Weiskirchen, S., and Weiskirchen, R. (2021). Cellular Mechanisms of Liver Fibrosis. Front. Pharmacol. 12, 671640.
Xu, F., Liu, C., Zhou, D., and Zhang, L. (2016). TGF-b/SMAD Pathway and Its Regulation in Hepatic Fibrosis. J. Histochem. Cytochem. 64, 157–167.
Trautwein, C., Friedman, S.L., Schuppan, D., and Pinzani, M. (2015). He- patic fibrosis: Concept to treatment. J. Hepatol. 62, S15–S24.
Zhang, H., Ju, B., Nie, Y., Song, B., Xu, Y., and Gao, P. (2018). Adenovirus- mediated knockdown of activin A receptor typeı¨½2A attenuates immune- induced hepatic fibrosis in mice and inhibits interleukin-17-induced activation of primary hepatic stellate cells. Int. J. Mol. Med. 42, 279–289.
Conroy, K.P., Kitto, L.J., and Henderson, N.C. (2016). av integrins: key reg- ulators of tissue fibrosis. Cell Tissue Res. 365, 511–519.
Wang, Y., Shu, Y., Xiao, Y., Wang, Q., Kanekura, T., Li, Y., Wang, J., Zhao, M., Lu, Q., and Xiao, R. (2014). Hypomethylation and overexpression of ITGAL (CD11a) in CD4+ T cells in systemic sclerosis. Clin. Epigenet. 6, 25.
Dewidar, B., Meyer, C., Dooley, S., and Meindl-Beinker, A.N. (2019). TGF-b in Hepatic Stellate Cell Activation and Liver Fibrogenesis- Updated 2019. Cells 8, 1419.
Liu, F., Huang, X., Luo, Z., He, J., Haider, F., Song, C., Peng, L., Chen, T., and Wu, B. (2019). Hypoxia-Activated PI3K/Akt Inhibits Oxidative Stress via the Regulation of Reactive Oxygen Species in Human Dental Pulp Cells. Oxid. Med. Cell. Longev. 2019, 6595189–6595210.
Mo, Z., Liu, D., Rong, D., and Zhang, S. (2021). Hypoxic Characteristic in the Immunosuppressive Microenvironment of Hepatocellular Carcinoma. Front. Immunol. 12, 611058.
Terabe, M., and Berzofsky, J.A. (2018). Tissue-Specific Roles of NKT Cells in Tumor Immunity. Front. Immunol. 9, 1838.
Simon, S., and Labarriere, N. (2017). PD-1 expression on tumor-specific T cells: Friend or foe for immunotherapy? OncoImmunology 7, e1364828.
Courtney, A.H., Shvets, A.A., Lu, W., Griffante, G., Mollenauer, M., Hor- kova, V., Lo, W.-L., Yu, S., Stepanek, O., Chakraborty, A.K., and Weiss,
A. (2019). CD45 functions as a signaling gatekeeper in T cells. Sci. Signal.
12, eaaw8151.
Peters, A., Burkett, P.R., Sobel, R.A., Buckley, C.D., Watson, S.P., Bettelli, E., and Kuchroo, V.K. (2015). Podoplanin negatively regulates CD4+ effector T cell responses. J. Clin. Invest. 125, 129–140.
Zhu, C., Sakuishi, K., Xiao, S., Sun, Z., Zaghouani, S., Gu, G., Wang, C., Tan, D.J., Wu, C., Rangachari, M., et al. (2015). An IL-27/NFIL3 signalling axis drives Tim-3 and IL-10 expression and T-cell dysfunction. Nat. Com- mun. 6, 6072.
Yang, S., Liu, F., Wang, Q.J., Rosenberg, S.A., and Morgan, R.A. (2011). The shedding of CD62L (L-selectin) regulates the acquisition of lytic activ- ity in human tumor reactive T lymphocytes. PLoS One 6, e22560.
Hu, G., and Wang, S. (2017). Tumor-infiltrating CD45RO+ Memory T Lym- phocytes Predict Favorable Clinical Outcome in Solid Tumors. Sci. Rep. 7, 10376.
Wang, M., Windgassen, D., and Papoutsakis, E.T. (2008). Comparative analysis of transcriptional profiling of CD3+, CD4+ and CD8+ T cells


 
Technology
ll
OPEN ACCESS



identifies novel immune response players in T-Cell activation. BMC Ge- nom. 9, 225.
Thibodeau, J., Bourgeois-Daigneault, M.-C., and Lapointe, R. (2012). Tar- geting the MHC Class II antigen presentation pathway in cancer immuno- therapy. OncoImmunology 1, 908–916.
Fang, H., Ang, B., Xu, X., Huang, X., Wu, Y., Sun, Y., Wang, W., Li, N., Cao,
X., and Wan, T. (2014). TLR4 is essential for dendritic cell activation and anti-tumor T-cell response enhancement by DAMPs released from chem- ically stressed cancer cells. Cell. Mol. Immunol. 11, 150–159.
Noe, J.T., and Mitchell, R.A. (2020). MIF-Dependent Control of Tumor Im- munity. Front. Immunol. 11, 609948.
Wolf, E.M., Fingleton, B., and Hasty, A.H. (2022). The therapeutic potential of TREM2 in cancer. Front. Oncol. 12, 984193.
Eriksson, E., Moreno, R., Milenova, I., Liljenfeldt, L., Dieterich, L.C., Chris- tiansson, L., Karlsson, H., Ullenhag, G., Mangsbo, S.M., Dimberg, A., et al. (2017). Activation of myeloid and endothelial cells by CD40L gene therapy supports T-cell expansion and migration into the tumor microenvironment. Gene Ther. 24, 92–103.
Schmid, M.C., Khan, S.Q., Kaneda, M.M., Pathria, P., Shepard, R., Louis,
T.L., Anand, S., Woo, G., Leem, C., Faridi, M.H., et al. (2018). Integrin CD11b activation drives anti-tumor innate immunity. Nat. Commun. 9, 5379.
Srivatsa, S., Paul, M.C., Cardone, C., Holcmann, M., Amberg, N., Pathria, P., Diamanti, M.A., Linder, M., Timelthaler, G., Dienes, H.P., et al. (2017). EGFR in Tumor-Associated Myeloid Cells Promotes Development of Colo- rectal Cancer in Mice and Associates With Outcomes of Patients. Gastro- enterology 153, 178–190.e10.
Li, L.-J., Chang, P.M.-H., Li, C.-H., Chang, Y.-C., Lai, T.-C., Su, C.-Y.,
Chen, C.-L., Chang, W.-M., Hsiao, M., and Feng, S.-W. (2022). FAS recep- tor regulates NOTCH activity through ERK-JAG1 axis activation and con- trols oral cancer stemness ability and pulmonary metastasis. Cell Death Dis. 8, 101.
Qiu, X., Mao, Q., Tang, Y., Wang, L., Chawla, R., Pliner, H.A., and Trapnell,
C. (2017). Reversed graph embedding resolves complex single-cell trajec- tories. Nat. Methods 14, 979–982.
Stuart, T., Srivastava, A., Madad, S., Lareau, C.A., and Satija, R. (2021). Single-cell chromatin state analysis with Signac. Nat. Methods 18, 1333–1341.
Yu, G., Wang, L.-G., Han, Y., and He, Q.-Y. (2012). clusterProfiler: an R Package for Comparing Biological Themes Among Gene Clusters. OMICS A J. Integr. Biol. 16, 284–287.
Wilkerson, M.D., and Hayes, D.N. (2010). ConsensusClusterPlus: a class discovery tool with confidence assessments and item tracking. Bioinfor- matics 26, 1572–1573.
Shao, X., Li, C., Yang, H., Lu, X., Liao, J., Qian, J., Wang, K., Cheng, J., Yang, P., Chen, H., et al. (2022). Knowledge-graph-based cell-cell communication inference for spatially resolved transcriptomic data with SpaTalk. Nat. Commun. 13, 4429.
Zhang, Y., Liu, T., Meyer, C.A., Eeckhoute, J., Johnson, D.S., Bernstein, B.E., Nusbaum, C., Myers, R.M., Brown, M., Li, W., and Liu, X.S. (2008). Model-based Analysis of ChIP-Seq (MACS). Genome Biol. 9, R137.
Alboukadel, Kassambara, and Marcin Kosinski. Przemyslaw Biecek. surv- miner: Drawing Survival Curves using ‘ggplot2’. R package version 0.4.9. 2021. https://CRAN.R-project.org/package=survminer.
Subramanian, A., Tamayo, P., Mootha, V.K., Mukherjee, S., Ebert, B.L., Gillette, M.A., Paulovich, A., Pomeroy, S.L., Golub, T.R., Lander, E.S., and Mesirov, J.P. (2005). Gene set enrichment analysis: A knowledge- based approach for interpreting genome-wide expression profiles. Proc. Natl. Acad. Sci. USA 102, 15545–15550.
Fornes, O., Castro-Mondragon, J.A., Khan, A., van der Lee, R., Zhang, X., Richmond, P.A., Modi, B.P., Correard, S., Gheorghe, M., Baranaˇsic´, D., et al. (2020). JASPAR 2020: update of the open-access database of tran- scription factor binding profiles. Nucleic Acids Res. 48, D87–D92. gkz1001.
Wickham, H. (2016). Data Analysis. In ggplot2 Use R! (Springer Interna- tional Publishing)), pp. 189–201.
Flamary, R., Courty, N., Gramfort, A., Alaya, M.Z., Boisbunon, A., Cham- bon, S., Chapel, L., Corenflos, A., Fatras, K., Fournier, N., et al. POT: Python Optimal Transport.
Wei, R., He, S., Bai, S., Sei, E., Hu, M., Thompson, A., Chen, K., Krishna- murthy, S., and Navin, N.E. (2022). Spatial charting of single-cell transcrip- tomes in tissues. Nat. Biotechnol. 40, 1190–1199.
Kartha, V.K., Duarte, F.M., Hu, Y., Ma, S., Chew, J.G., Lareau, C.A., Earl, A., Burkett, Z.D., Kohlway, A.S., Lebofsky, R., and Buenrostro, J.D. (2022). Functional inference of gene regulation using single-cell multi-omics. Cell Genom. 2, 100166.

ll
OPEN ACCESS

 
Technology


STAR+METHODS
KEY RESOURCES TABLE




RESOURCE AVAILABILITY

Lead contact
Further information and request should be directed to and will be fulfilled by the lead contact, Xiaohui Fan (fanxh@zju.edu.cn).


 
Technology
ll
OPEN ACCESS


Materials availability
This study did not generate new unique reagents.

Data and code availability
The original data used in this paper can be accessed through the following links: (1) SNARE-seq data of mouse brain cortex2: GEO accession: GSE126074; (2) DBiT-seq data of mouse embryo17: GEO accession: GSE137986; (3) 10x Visium with highly multiplexed protein data of mouse liver, 10x Visium data and CITE-seq data of human liver18: https://www.livercellatlas.org/index.php; (4) SPOTS data of mouse spleen, SPOTS data of breast tumor: GEO accession: GSE198353; (5) Spatial ATAC–RNA-seq data of mouse embryo, Spatial ATAC–RNA-seq data of human hippocampus: https://web.atlasxomics.com/visualization/Fan; (6) 10x Visium data of mouse brain cortex: https://satijalab.org/seurat/articles/spatial_vignette; (7) ISSAC-seq data of mouse brain cortex27: https://www.ebi.ac. uk/biostudies/arrayexpress/studies/E-MTAB-11264; (8) 10x Visium data of human breast cancer21: https://zenodo.org/record/ 4739739#.Y-er_uxBzUY; (9) CITE-seq data of human breast cancer21: GEO accession: GSE176078.
The SpaTrio toolkit is available at GitHub: https://github.com/ZJUFanLab/SpaTrio and Zenodo archive: https://doi.org/10.5281/ zenodo.10025036.

METHODS DETAILS

SpaTrio toolkit
Mapping of cells
The input single-cell multi-omics and ST data were processed before calculating the optimal probabilistic (or fractional) alignment. Genes that were not shared between the two datasets were removed, and we recommended using the top 100 genes of each cell type in the two datasets for subsequent analysis under default parameters. Gene expression matrices were normalized and scaled to prepare for subsequent experiments. The two datasets both contain a pair of matrices, which are (X;E) and (Y;Z) respectively, where
X = xai ˛ Rp3n represents the gene expression of p genes in n cells, and Y = ybj ˛ Rp3m represents the gene expression of p genes in m spots, E ˛Rh3n is the h-dimensional embedded representation matrix of cells, Z ˛R23m is the two-dimensional spatial coordi- nate matrix of spots. This means that xai ˛ R is the transcript level for gene a in cell i, ybj ˛ R is the transcript level for gene b in spot j, e$i is the vector of h-dimensional low-dimensional representation of cell i and z$j is the two-dimensional spatial location of spot j.
Because the E matrix is derived from the embedding space after dimensionality reduction, the distance between the cells represents the similarity of the cells in the low-dimensional embedding space. The Z matrix is derived from the spatial position in tissue; thus, the distances between the cells are the actual coordinate distances. We extract the spatial coordinates of each point from the spatial transcriptome data and obtain dimensionally reduced low-dimensional embedding representations of ATAC/Protein assay from the single-cell multi-omics data. The embedding matrix is then normalized to ensure that features of different dimensions have the same weight when computing distances. Next, we construct two k-NN graphs using the spatial coordinates and low-dimensional embedding matrix. The k-NN graphs ensure that both types of distances operate at the same scale, providing important neighbor- hood information for data integration and alignment. We compute the shortest path distance between each pair of nodes and set the distance of any unconnected node to its maximum in the graph. Moreover, we added a type-aware mechanism. Specifically, if the types/regions of two cells/spots differed, their distance is artificially enlarged. Then, the resulting matrix is rescaled by dividing
by the maximum distance and finally forms the graph distance matrix D ˛Rn3n, where dik refers to the scaled k-NN graph distance between cell i and cell k. We tested the effect of the type-aware mechanism and spatial KNN graph on spatial reconstruction using
simulated and real data. From the results, it can be seen that the integration of spatial information performed best under spatial pat- terns of different complexity. Even in data with very high complexity, the spatial graph still significantly improved the performance of the tool (Figures S20A–S20D). This illustrates the advantages of spatial information integration and its applicability to spatial patterns of varying complexity. We also compared the differences in constructing modal graphs using ATAC and RNA assay, and the results demonstrated that integrating multimodal information to spatially arrange cells is significantly better than solely based on transcrip- tome similarity (Figures S21A–S21E).
In addition, we assume that each cell/spot has a weight gi, greater than zero, which reflects its significance compared to the other cells. These weights incorporate a priori information, such as the relative number of cells in a spot or the histopathological importance score of a spot or cell. To ensure consistency, we normalized the weights such that the sum of all gi equals one, resulting in a dis- tribution g = (g1;.;gn). If no prior information was available regarding the cells/spots, we used a uniform distribution. Additionally, we provide users with the flexibility to input the expected number of cells in each spot. This information allows us to adjust the weights based on the cell count in each spot. The total weight remains constant, and the weight of each spot is proportionally determined by the number of cells it contains.
The triplets (X; D; g) and (Y; D'; g') are used to describe single-cell multi-omics data and ST slices, where X and Y are the transcrip- tome expression matrices of all cells and spots respectively, and D/ D' is the graph distance of the cell/spot pairwise, g/ g' is the dis- tribution of all cells/spots. The Euclidean distance algorithm was used to calculate the cost matrix. Taking single-cell data as an example, x$i and y$j are expression profile vectors of cell i and spot j, a nonnegative cost between them is measured by the expression cost function c:

ll
OPEN ACCESS






c x$i; y$j = x$i — y$j  2

 
Technology

To establish the alignment between cells and spots, we introduce the alignment matrix P = [pij] ˛ Rn3m. Each element pij in the alignment matrix represents the mapping strength or weight between a specific cell i and spot j. For all cell i, the sum of the mapping
weights to all spots j should be equal to the weight of cell i in the distribution g. This constraint is formulated as  j pij = gi, where gi is the weight of cell i. For all spots j, the sum of the mapping weights from all cells i should be equal to the weight of spot j in the dis- tribution g'. This constraint is formulated as  i pij = gj', where gj' is the weight of spot j. G(g; g') is the set of all mappings between two datasets. Given slices (X; D; g) and (Y; D'; g') containing n cells and m spots, an expression cost function c and a parameter a, use the
following cost to find a mapping P ˛ G(g; g'):
F P; X; D; Y; D'; c; a = 1	a Xc x ; y  p + aX d	d'  p p .
2
		  	  
The first component, (1 — a)  i;jc(x$i;y$j)pij, represents the gene expression cost. It calculates the overall dissimilarity between the gene expression profiles of cells and spots, considering their respective mapping weights. The second component,

aPi;j;k;l
(dik — d' )2pijpkl, is the pairwise distance cost. It measures the overall discrepancy in pairwise distances between cells

and spots, taking into account the pairwise mapping weights. The parameter a controls the trade-off between gene expression sim- ilarity and pairwise distance similarity. A higher value of a emphasizes the importance of matching pairwise distances, while a lower value focuses more on aligning gene expression profiles.75
After obtaining the comparison matrix between cells and spots, we sorted them from largest to smallest probability. Next, we uti- lized a non-negative least squares (NNLS) algorithm to deconvolve the cell types for each spot based on the average gene expression of each cell type in the single-cell data. We then prioritized selecting cell types that matched the NNLS results to assign cells to cor- responding points. This approach ensures consistency between selected cell types from single-cell and spatial transcriptome mea- surements, thus mitigating the impact of differential abundance and accurately assigning cells to their respective spots. If the number of mapped cells is less than expected, we complement it with the cell having the highest probability. To demonstrate the effective- ness of this strategy, we selected simulated data and real data with varying degrees of abundance differences. We compared SpaTrio with Energy Mover’s Distance (EMD), unbalanced optimal transport (UOT), and partial optimal transport (POT).75 The results showed that SpaTrio outperformed the other methods in handling the problem of differential abundance (Figures S22A–S22D). This indicates that SpaTrio’s strategy can accurately address abundance differences, making it a more reliable and robust solution for tackling this issue.
SpaTrio assigns spatial coordinates to each cell based on the similarity between the cell and its neighbors after obtaining the assignment relationship between cells and spots. Specifically, it uses gene expression data between cells and neighboring locations for analysis. For each spot, we quantified the similarity between cells and neighboring locations by computing the PCC between their gene expressions. This similarity metric reflects the degree to which cells are related to neighboring locations. Then, according to the weight of similarity, the spatial coordinates of each cell are calculated. A higher weight indicates that the cell is more similar to neigh- boring locations, so it has more influence in the coordinate calculation. The coordinates of cell i can be expressed as (xi;yi) and map- ped onto spot j. There are multiple spots j1, ., jn around spot j. The PCCs between cell i and the surrounding spots were calculated and scaled to a range of 0–1, obtaining the final correlation scores as p1, ., pn. The coordinates of cell i are computed using the following formula:
0Pxnpn Pynpn1
(xi; yi) = @	n	;	n	A

In addition, SpaTrio adjusts the coordinates of the cells so that the centroid of the cells within each spot overlaps with the central coordinates of the spot, making them more scattered within the scope of each spot to better simulate the spatial distribution of cells. The resulting cell locations reflect the similarity of gene expression to surrounding spots and do not extend beyond the boundaries of the spots. In some cases, the number of neighboring spots of spot j may be insufficient. For this, we added a pseudo-spot jpseudo, which shares gene expression with spot j, and its spatial coordinates conformed to the following calculation:
 xpseudo; ypseudo  =  xj $ (n + 1) — Xxn; yj $ (n + 1) — Xyn!
A pseudo-spot is regarded as a neighboring spot that participates in allocating and correcting the cell coordinates. We compared the coordinate correction strategies of SpaTrio with CARD and SpaTalk, showing that SpaTrio can effectively assign all cells, and the gap between the adjusted coordinates and the real coordinates is significantly lower than the other two methods, which proves the effectiveness of the SpaTrio coordinate correction function (Figures S23A–S23F).
Analysis of module
Based on the spatial coordinates of single cells after mapping and the molecular information contained in the cell, inspired by CellTrek76 and FigR,77 we designed a module analysis function to identify potential spatial feature expression modules. First, the


 
Technology
ll
OPEN ACCESS


molecular expression state of cells in space may have insufficient continuity, affecting spatial module recognition. Therefore, we first smoothed the characteristic intensity of the cells on the k-NN graph, which was calculated using a low-dimensional embedded rep- resentation. The spatial distance matrix between cells is transformed into a spatial kernel matrix W using radial basis functions (RBF), the smoothed feature expression matrix X is normalized, and the covariance of the expression matrix X and kernel matrix W is calcu- lated. Next, the covariance was divided by the square root of the diagonal elements to obtain a spatially weighted correlation matrix. Using the spatially weighted correlation matrix, we used consensus clustering (CC)68 to detect the feature expression modules. The CC function was implemented using the ConsensusClusterPlus package (v1.62.0). After the feature clusters were obtained, the identified features were filtered based on the level of consensus and correlation. The activity score of the identified module
was calculated using Seurat25 (v4.3.0) AddModuleScore.
Inference of CCI
We employed different analytical strategies for cellular communication involving different modalities. For transcriptome-based cell interaction analysis, the gene expression counts matrix, two-dimensional coordinates, and cell classification information of all as- signed cells to the SpaTalk69 package (v1.0) for analysis. Interactions between all input cell types were calculated and included spe- cific ligand-receptor pairs and strengths of interactions.
For the proteome-based analysis of cellular communication, we utilized the results of the modular analysis. We calculated the pro- tein module scores for each cell using the Seurat (v4.3.0) AddModuleScore and divided them into two groups based on the cell-type specificity of the scores. If the specificity was high, the protein in the module was a specific protein of the corresponding cell type. If the specificity was low, the proteins in all the modules were treated as spatially differential proteins. If a spatially differentially ex- pressed protein was highly expressed in a cell group, it was a specific protein. After specific proteins were identified in each cell pop- ulation, protein interaction scores were calculated based on expressed protein abundance. For example, the specific protein a of cell population i is a ligand, and the average expression is xai, The specific protein b of cell population j is a receptor, expressed as xbj, and the corresponding cell interaction score S is calculated by the following formula:
Sa;b;i;j = pxai $xbj

After calculating the interaction scores between all the cell types, we bound the protein interaction scores to 1 by dividing them by the maximum score.

Simulation                                                        data We evaluated the performance of SpaTrio by simulating the data. We simulated the data based on a mouse cerebral cortex dataset to make the simulation as realistic as possible. These data, including the transcriptome expression and chromatin accessibility of the cells, were generated using SNARE-seq technology. First, we preprocessed the transcriptome dataset using normalization, scaling, principal component analysis (PCA), UMAP dimensionality reduction, and graph-based cell clustering. Normalization and linear dimensional reduction were also performed in the ATAC assay, and MACS270 (v2.2.7.1) was used for peak calling analysis. For the cell subpopulations obtained by clustering, we determined the cell types of each cell subpopulation by integrating them with the Allen brain reference dataset (https://portal.brain-map.org/atlases-and-data/rnaseq). We selected three main cell subpopula- tions (L2/3 IT, L4, and L5 IT) from the data, defined as Cell type 1, 2, and 3, and randomly sampled 250 cells from each subpopulation. Only the top 2000 highly variable genes were retained to increase the calculation speed. This dataset of 750 cells was used as the input for SpaTrio. We then randomly divided 250 cells of each type into 50 groups, with each group corresponding to a spot. The average expression of each group of cells was used as the expression of the spot. Next, we manually assigned spatial coordinates to these merged spots and evenly arranged the 150 spots in space, as shown in Pattern 1. Furthermore, we developed a design called Pattern 2, which consisted of three layers of cells evenly distributed from the innermost to the outermost layer. Specifically, the inner layer comprises 19 spots, the middle layer comprises 42 spots, and the outer layer comprises 30 spots. Pattern 3 and 4 were built using multivariate normal distribution and randomly sampling. After assigning spatial coordinates to each spot, ST datasets were formed, and each spot’s transcriptome and epigenome were used to measure SpaTrio performance.
Before SpaTrio mapped the cells to spots, we added a step to the ST data to add a controllable degree of noise to affect the het- erogeneity of the transcriptome data. We generated new transcript counts based on the negative binomial distribution of total counts at each spot and then on the multinomial distribution of individual gene counts. This process is controlled by the pseudocount param- eter d, which perturbs the count of each transcript. Intuitively, the higher the value of d, the more noisy the simulated gene expression counts are and, therefore, the less informative. In addition, we randomly rotated the slice before alignment. The objective was to elim- inate the influence of the slice angle.
We selected four indicators to quantify the accuracy of the nodal cell mapping results. Mapping accuracy was measured by calcu- lating the proportion of cells correctly assigned to the matching regions. For spot j, n cells allocated, among which n' cells have the same cell type as spot j, and the accuracy of cell allocation is the proportion of these cells. Allocation accuracy A for an entire slice with m spots was calculated using the following formula:
1 m n'
A =	
m j = 1 n

ll
OPEN ACCESS

 
Technology


The omics data of the mapped spots were obtained by adding the single-cell omics data. We calculated the PCC and SCC of the transcriptome before and after mapping each spot. It measured the accuracy of SpaTrio deconvolution of the spot. In addition, we calculated the ARI between the cell type of the ground truth and the mapped results and the RMSE between the deconvolution and the proportion of accurate labels for each spot in the ST dataset using the following formula:



RMSE =
utn = 1
y'n — yn N

Where N is the number of cell types, yn' is the proportion of cell types in the spot obtained by mapping, and yn is the true proportion of cell type n.
Finally, we compared the performance of SpaTrio with that of PASTE (v1.3.0), Tangram (v1.0.4), CARD (v1.0), Seurat (v4.3.0), and Scanorama (v1.7.3). A particular angle randomly rotated the input ST data before integration, and a pseudocount of specified size was added. PASTE was run using default parameters to obtain the alignment probability matrix. Tangram was run using cell level mapping with default parameters to obtain the alignment probability between the spots and cells. CARD was run to infer the single cell resolution gene expression for each measured spatial location. We used Seurat to integrate the input with the IntegrateData func- tion and calculated the distance matrix between spots/cells based on PCA embedding, obtaining the inverse and removing the maximum values to obtain the alignment matrix. Like Seurat, Scanorama integrated the datasets and calculated the matching rela- tionships between the spots and cells. The obtained alignment matrices were input into the assign_coord function, the cells were assigned to the corresponding spots, and the above indicators were used to compare tool performance.
When comparing the impact of using RNA and ATAC graphs, we generated new simulated data based on Pattern 1. In this sce- nario, we introduced pseudocounts to the Cell type 2 and Cell type 3 populations, effectively eliminating the transcriptome differ- ences between these two groups of cells, treating them as a single cell population. This allowed us to examine the effect of utilizing different graph construction methods while controlling for potential transcriptome heterogeneity within these specific cell types.
To better evaluate SpaTrio’s ability to handle cell abundance differences, we modified the Pattern 1 simulated data and created a "Random abundance" dataset. Specifically, the spatial data remained unchanged, while the single-cell multi-modal data had randomly altered cell abundances. For each Cell type 1 (250, 500, 750, 1000, 1250), Cell type 2 (250, 500, 750, 1000, 1250), and Cell type 3 (250, 500), corresponding numbers of cells were randomly sampled to create the dataset. This allowed us to assess how well SpaTrio performed when facing varying levels of cell abundance differences in the input data.

Biological data
We evaluated the performance of SpaTrio using six biological datasets. Mouse embryo data (DBiT-seq),mouse liver data (10x Visium with highly multiplexed proteins), mouse spleen data (SPOTS), breast tumor data (SPOTS), mouse embryo data (Spatial ATAC–RNA- seq) and human hippocampus (Spatial ATAC–RNA-seq) were used to create the input dataset.
Mouse embryo data (Dataset 1)
We selected a slice with a pixel size of 25-mm and merged the four spatially adjacent pixels into one pixel, preserving the spatial tran- scriptomics data as input ST data. Meanwhile, we removed the location information of the original data as the input single-cell multi- omics data. Finally, the single-cell data contained 1789 cells, 13285 genes, and 22 proteins. The corresponding generated ST data contains 472 spots and 18510 genes. We performed the same preprocessing on the transcriptional data of the input datasets, including normalization, PCA analysis, and non-linear dimensionality reduction using UMAP. We performed cell clustering at the same resolution (resolution = 0.8). The count expression matrices, cell clustering information of all datasets, and spatial coordinates information of ST data were input into SpaTrio. In addition, we performed log-ratio (CLR) normalization on protein abundance and obtained the dimensionality reduction information of protein assay by performing PCA analysis. It was input as the embedding infor- mation of single-cell data. Only cell-type differential genes shared between the two datasets are selected for the next step of spatial mapping. The omics data of the mapped spot is also obtained by merging the data of the contained single cells.
Mouse liver data (Dataset 2)
Mouse liver data (10x Visium with highly multiplexed protein) consisted of a slice, containing 1659 spots annotated with liver zona- tions, 16555 genes, and 91 proteins. We divided the slice into two parts of different sizes, both containing four zonations of the liver. The spots located in the larger part were selected to be input as single-cell multi-omics data, and the spots located in the smaller were selected to be input as ST data. In this way, we constructed single-cell data of 1398 cells and ST data of 261 spots. In the mapping process, we used the scaled expression matrix, which only contains the differential genes shared by the two datasets, and used the regional information to affect the calculation of the graph distance. As mentioned before, the mapped spot data is merged from the assigned cell data. In addition, we calculate the average abundance of the cell type-specific proteins in each region and scaled them as the signal intensity of the corresponding cell type.
Mouse spleen data (Dataset 3)
Mouse spleen data (SPOTS) consisted of two slices and we choose the replicate 1. The slice containing 2569 spots, 17806 genes, and 21 proteins. We divide the entire slice into 477 grids of equal size to generate ST data. We performed the same preprocessing on the transcript data of the input dataset as Dataset 1, including normalization, PCA analysis, and non-linear dimensionality reduction


 
Technology
ll
OPEN ACCESS


using UMAP. We performed CLR normalization on protein abundance and derived PCA dimensionality reduction information. Only cell-type differential genes shared between the two datasets were selected for the next step of spatial mapping.
Breast tumor data (Dataset 4)
Breast tumor data (SPOTS) consisted of 1978 spots, 18932 genes, and 32 proteins. We divide the entire slice into 600 grids of equal size to generate ST data. We performed the same preprocessing on the transcript data of the input dataset as Dataset 1 and per- formed cell clustering at the same resolution (resolution = 0.2). For the subsequent spatial mapping, we only considered cell-type differential genes that were common to both datasets.
Mouse embryo data (Dataset 5)
Mouse embryo data (Spatial ATAC–RNA-seq) consisted of 2187 pixels, 17058 genes, and 32437 peaks. We divide the entire slice into 573 grids of equal size to generate ST data. We processed ATAC assay using normalization using term frequency-inverse document frequency (TF-IDF), linear dimensional reduction using singular value decomposition (SVD), and nonlinear dimensionality reduction using UMAP. For the subsequent spatial mapping, we only considered highly variable genes that were common to both datasets. Human hippocampus data (Dataset 6)
Human hippocampus data (Spatial ATAC–RNA-seq) consisted of 2500 pixels, 29293 genes, and 56614 peaks. We divide the entire slice into 625 grids of equal size to generate ST data. We processed ATAC assay as Dataset 5. For the subsequent spatial mapping, we focused on highly variable genes that were shared between both datasets.

Mouse brain cortex data analysis
Single-cell multi-omics data of the mouse brain cortex were measured by ISSAAC-seq, which contained chromatin accessibility and gene expression of 12 types of excitatory neurons, seven types of inhibitory neurons, and four types of non-neurons. ST data of 10x Visium only retained spots located in the cortex, and the slice was segmented into five regions (Region 1, 2, 3, 4, and 5) based on transcriptome heterogeneity, corresponding to five major cortex layers (Astro, L2/3, L4, L5, L6, and Oligo). The ATAC assay of the ISSAAC-seq data was performed using a standard analysis procedure, including normalization using TF-IDF, linear dimensional reduction using SVD, and nonlinear dimensionality reduction using UMAP. The first component was removed from the downstream analysis. In addition to the two expression count matrices, we input the cluster information and low-dimensional embedding matrix of the single-cell data, ST region information, and spatial coordinates into SpaTrio. SpaTrio was operated according to default param- eters. The number of cells expected to be allocated to each spot was set to 10. When calculating the spatial gene module of L4/5 cells, we selected the top 5000 highly variable genes and set sigma = 140, min_avg_con = 0.3, min_avg_cor = 0.3, min_featuer = 20, max_featuer = 1200, and min_pct_cutoff = 0.15. The spatial motif modules were calculated with sigma = 140, min_avg_con = 0.3, min_avg_cor = 0.3 min_featuer = 20, and max_featuer = 400.

Human                 liver                 data                 analysis Liver datasets were extracted from the Liver Cell Atlas (https://www.livercellatlas.org/index.php). We selected single-cell multi-omics data from one patient who developed liver obesity with 5,393 cells, 26,758 genes, and 189 proteins. ST data were generated from a steatotic patient (H35), containing the gene expression and surface protein abundance of five major cell types (hepatocytes, fibro- blasts, endothelial cells, macrophages, and cholangiocytes), covering 18,703 unique genes among 1,248 spots. On this slice, spots were divided into the main liver zones, including the portal (48 spots), periportal (72 spots), mid (364 spots), and central (142 spots) zones, as well as 622 spots that had not been annotated. Gene expression matrices were normalized and scaled, and the most var- iable 5000 genes were retained to create the input. CLR normalization was performed on the protein abundance matrix, and PCA was used to obtain a low-dimensional embedding matrix for the protein assay, which was then transmitted to SpaTrio. SpaTrio was oper- ated using default parameters, and the number of cells expected to be mapped to each spot was set to three. When calculating the spatial gene module of hepatocytes, we selected the top 2000 highly variable genes and set sigma = 230, min_avg_con = 0.5, min_ avg_cor = 0.5, min_featuer = 20, max_featuer = 1000, and min_pct_ cut-off = 0.1. The spatial protein modules used for cell commu- nication inference in selected regions were calculated with sigma = 230, min_avg_con = 0.6, min_avg_cor = 0.6, min_featuer = 10, and max_featuer = 200, min_pct_cutoff = 0.1. We used the Monocle 2 software package (v.2.26.0)65 to perform a trajectory analysis of hepatocytes in major regions, with raw count data as input, based on the DDRTree function, gene order, and dimensionality reduc- tion according to differential genes between subpopulations and along pseudotime trajectories to order cells.

Human breast cancer data analysis
The CITE-seq and 10x Visium datasets of human breast cancer were obtained from an atlas of human breast cancers (https:// singlecell.broadinstitute.org/single_cell/study/SCP1039/a-single-cell-and-spatially-resolved-atlas-of-human-breast-cancers). We retained the cell-type annotations for individual cells and the regional divisions for spots from the original paper. The CITE-seq counts were normalized and scaled using Seurat, and the protein abundance of the samples was imputed without the protein assay. Spe- cifically, we selected seven significant cell populations: T cells, PVL cells, endothelial cells, CAFs, myeloid cells, plasmablasts, and B cells. Using the FindAllMarkers step, differentially expressed antibodies between populations were calculated, and protein expres- sion levels were transferred to other samples using anchoring-based transfer learning. We chose the CITE-seq data of three patients (ER+: CID4535, CID4040, and CID4530N) with similar transcriptomes (Figure S18A) and the ST data of one slice (ER+: CID4535) as inputs to SpaTrio. The ST data covered 17,908 unique genes among the 357 spots, and the CITE-seq data included transcriptional

ll
OPEN ACCESS

 
Technology


and protein assays of 6,543 cells, covering 23,926 unique genes and 169 proteins. SpaTrio was operated with default parameters, and each spot was matched with up to 15 cells. The abundance of cell types for each spot, the cytotoxicity score (GZMB, GNLY, GZMA, NKG7, and PRF1), and the exhaustion score (PDCD1, CTLA4, and HAVCR2) of cells were calculated using the Seurat AddModuleScore with the corresponding genes. The toxicity score minus the exhaustion score was used to obtain the T cell function score. In the ST data, spots with T cell abundance greater than 0 were annotated as T cells, and to calculate the spatial protein mod- ule of T cells, we set sigma = 110, min_avg_con = 0.6, min_avg_cor = 0.6, min_featuer = 5, and max_featuer = 100. We set sigma = 110, min_avg_con = 0.5, min_avg_cor = 0.5, min_featuer = 5, max_featuer = 200, and min_pct_cutoff = 0.1 to identify the protein modules of invasive cancer + lymphocytes region in preparation for the cell–cell interaction analysis and visualize the results using ggplot274 (v3.4.2).

Transcription factor regulation analysis
We performed peak calling analysis on the ATAC data using MACS2, and estimated transcription factor activity using the RunChromVAR feature within Signac66 (v1.9.0). The positional weight matrix used in the process was obtained from the JASPAR202073 database. Fold changes in transcription factor activity and gene expression were computed using the FindMarkers function, with a false discovery rate (FDR) of less than 0.05. We then used the PCCs of the fold-change of the transcription factor and the corresponding gene as the correlation between the two modalities. Transcription factors were classified into three groups based on the correlation between transcription factor activity and expression: (1) transcription factors whose motif activity was with high positively correlated with gene expression, (2) transcription factors that showed a negative correlation, and (3) transcription factors that showed an insignificant correlation. We hypothesized that transcription factors with a positive correlation act as transcriptional activators within differentially accessible chromatin regions (DAR), whereas those with a negative correlation act as transcriptional repressors.

Pathway and biological process enrichment analysis
To enrich gene modules with pathways, all genes within each module were analyzed using the clusterProfiler R package.67 Enrich- ment analysis results meeting the statistical threshold (qvalueCutoff = 0.05) and related to Biological Process(BP) were selected and reserved. For pathway enrichment in cell populations, the FindAllMarkers function was used to calculate differential expression genes (DEGs) for each cell subset by comparing it to other cells. We filtered them using the following settings (only.pos = TRUE, min.pct = 0.2, logfc.threshold = 0.2), and only retained the genes with an adjusted p value (Wilcoxon test) < 0.05. For Gene Ontology(GO) enrichment analysis, we selected the top 100 genes in fold change. Additionally, we performed Gene Set Enrichment Analysis (GSEA) on the ranked gene list to identify significantly activated pathways and biological processes. The signatures for these pathways and processes were obtained from the Molecular Signatures Database72 (http://www.gsea-msigdb.org/gsea/msigdb).

SURVIVAL ANALYSIS

RNA-seq and clinical data of BRCA patients were obtained from the Cancer Genome Atlas (TCGA) and Molecular Taxonomy of Breast Cancer International Consortium (METABRIC) using the cgdsr R package. To investigate the association between target gene expression and patient survival, tumor samples were categorized into low (25%) and high (75%) expression groups. The Kaplan-Meier formula in the R package "Survival" was utilized for survival analysis, and the survival curve was visualized using the ggsurvplot function in the R package "survminer".

QUANTIFICATION AND STATISTICAL ANALYSIS

The quantitative and statistical analyses are described in the relevant sections of the Method details and in the figure legends. R (version 4.2.2) and Python 3.8.13 were used for all statistical analyses.
